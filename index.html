<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßëüèª‚Äçüíª Dulce Bocado - ERP</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#6d453c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dulce Bocado">
    <meta name="description" content="Sistema ERP para Dulce Bocado - Gesti√≥n de ventas, inventario y n√≥mina">

    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRHVsY2UgQm9jYWRvIC0gRVJQIiwic2hvcnRfbmFtZSI6IkR1bGNlIEJvY2FkbyIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmRmOGY2IiwidGhlbWVfY29sb3IiOiIjNmQ0NTNjIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9naC9kZXZlbG9wZXJzL2dpdGh1Yi9mbGFncy9lNDc0MjQucG5nIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyJ9XX0=">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    colors: {
                        brand: {
                            50: '#fdf8f6',
                            100: '#f2e8e5',
                            200: '#eaddd7',
                            300: '#e0cec7',
                            400: '#d2bab0',
                            500: '#a77f70',
                            600: '#8a5a4d',
                            700: '#6d453c',
                            800: '#4a2e28',
                            900: '#2d1b17',
                        },
                        sweet: {
                            100: '#fff0f3',
                            200: '#ffc1cc',
                            300: '#ff8fa3',
                            400: '#ff5c7a',
                            500: '#e83e5f',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            background: linear-gradient(135deg, #fdf8f6 0%, #fff0f3 100%);
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .sidebar-item { transition: all 0.3s ease; }
        .sidebar-item:hover { transform: translateX(5px); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #a77f70; border-radius: 3px; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        .btn-action { transition: all 0.2s; }
        .btn-action:hover { transform: scale(1.1); }
        
        .sidebar { 
            transition: width 0.3s ease-in-out; 
            width: 16rem;
        }
        .sidebar.mini { 
            width: 4.5rem;
        }
        .sidebar.mini .sidebar-text,
        .sidebar.mini .sidebar-header-text,
        .sidebar.mini .user-info {
            display: none;
        }
        .sidebar.mini .sidebar-item {
            justify-content: center;
            padding-left: 0;
            padding-right: 0;
        }
        .sidebar.mini .sidebar-item i {
            margin: 0;
            font-size: 1.25rem;
        }
        .sidebar.mini .sidebar-section-title {
            display: none;
        }
        
        .main-content { transition: margin-left 0.3s ease-in-out; }
        
        .nomina-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        
        #installPWA {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: linear-gradient(135deg, #6d453c, #8a5a4d);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            display: none;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .search-container {
            position: relative;
            margin-bottom: 1rem;
        }
        .search-input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }
        .search-input:focus {
            outline: none;
            border-color: #a77f70;
            box-shadow: 0 0 0 3px rgba(167, 127, 112, 0.1);
        }
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }
        
        .product-card {
            transition: all 0.3s ease;
        }
        .product-card.no-stock {
            opacity: 0.6;
            order: 2;
            background: #f3f4f6;
        }
        .product-card.has-stock {
            order: 1;
        }
        .stock-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }
        .stock-badge.high { background: #10b981; color: white; }
        .stock-badge.low { background: #f59e0b; color: white; }
        .stock-badge.none { background: #ef4444; color: white; }
        
        .sidebar.mini .sidebar-item {
            position: relative;
        }
        .sidebar.mini .sidebar-item:hover::after {
            content: attr(data-title);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: #2d1b17;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            margin-left: 8px;
            z-index: 100;
        }
        
        .stock-input-cashier {
            width: 80px;
            text-align: center;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 4px;
            font-weight: bold;
        }
        .stock-input-cashier:focus {
            outline: none;
            border-color: #a77f70;
        }
        /* Agregar en la secci√≥n <style> del HTML */

        /* Contenedor de gr√°ficas con altura fija */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        /* Asegurar que el canvas no se expanda */
        .chart-container canvas {
            max-height: 100% !important;
        }
        
        /* Alternativa: altura m√°xima en el glass-panel de gr√°ficas */
        #dashboard .glass-panel:has(canvas) {
            min-height: 0;
        }
        
        /* Forzar altura en los contenedores de chart espec√≠ficos */
        #salesChart, #expensesChart {
            max-height: 300px !important;
            height: 300px !important;
        }

        /* Estilos para expansi√≥n de ventas mixtas */
        .sale-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .sale-row:hover {
            background-color: #f9fafb;
        }
        .sale-details {
            display: none;
            background-color: #f9fafb;
            border-top: 1px dashed #e5e7eb;
        }
        .sale-details.active {
            display: table-row;
        }
        .iva-badge-0 { background: #fce7f3; color: #be185d; }
        .iva-badge-16 { background: #dbeafe; color: #1e40af; }
        .iva-badge-mix { background: #f3e8ff; color: #7c3aed; }

        /* NUEVOS: Estilos para items de gasto */
        .expense-item-row {
            transition: all 0.2s;
        }
        .expense-item-row:hover {
            background-color: #f3f4f6;
        }
        .expense-item-iva-toggle {
            transition: all 0.2s;
        }
        .expense-item-iva-toggle.active {
            background-color: #dbeafe;
            border-color: #3b82f6;
            color: #1e40af;
        }
        
        /* Estilos para semanas de facturaci√≥n */
        .week-card {
            transition: all 0.3s;
            cursor: pointer;
        }
        .week-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .week-card.facturada {
            opacity: 0.6;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-color: #86efac;
        }
        .week-card.facturada::after {
            content: 'FACTURADA';
            position: absolute;
            top: 10px;
            right: 10px;
            background: #22c55e;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body class="h-screen overflow-hidden">

<!-- PWA Install Button -->
<button id="installPWA" onclick="installApp()">
    <i class="fas fa-download mr-2"></i>Instalar App
</button>

<!-- Login Screen -->
<div id="loginScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-brand-100 to-sweet-100">
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4 transform transition-all hover:scale-105">
        <div class="text-center mb-8">
            <div class="w-20 h-20 bg-gradient-to-br from-brand-500 to-sweet-500 rounded-full mx-auto mb-4 flex items-center justify-center text-white text-3xl">
                <i class="fas fa-birthday-cake"></i>
            </div>
            <h1 class="text-3xl font-serif font-bold text-brand-800">Dulce Bocado</h1>
            <p class="text-brand-600 mt-2">Tierra Blanca - ERP System</p>
        </div>
        
        <div id="loginForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input type="email" id="loginEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all" placeholder="admin@dulcebocado.com">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Contrase√±a</label>
                <input type="password" id="loginPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button onclick="login()" class="w-full bg-gradient-to-r from-brand-600 to-brand-700 text-white py-3 rounded-lg font-semibold hover:from-brand-700 hover:to-brand-800 transition-all transform hover:scale-105 shadow-lg">
                Ingresar al Sistema
            </button>
            <div class="text-center">
                <button onclick="showRegisterForm()" class="text-sm text-brand-600 hover:text-brand-800 underline">
                    Crear cuenta nueva
                </button>
            </div>
        </div>

        <div id="registerForm" class="space-y-4 hidden">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo</label>
                <input type="text" id="regName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Tu nombre">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input type="email" id="regEmail" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="tu@email.com">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Contrase√±a</label>
                <input type="password" id="regPassword" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="M√≠nimo 6 caracteres">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Rol</label>
                <select id="regRole" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    <option value="cashier">Cajero</option>
                    <option value="admin">Administrador</option>
                </select>
            </div>
            <button onclick="register()" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-3 rounded-lg font-semibold hover:from-green-700 hover:to-green-800 transition-all shadow-lg">
                Crear Cuenta
            </button>
            <div class="text-center">
                <button onclick="showLoginForm()" class="text-sm text-gray-600 hover:text-gray-800 underline">
                    Ya tengo cuenta
                </button>
            </div>
        </div>
        
        <div class="mt-6 text-center text-sm text-gray-500">
            <p>Sistema conectado a Supabase</p>
        </div>
    </div>
</div>

<!-- Main App -->
<div id="mainApp" class="hidden h-full flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar bg-gradient-to-b from-brand-900 to-brand-800 text-white flex flex-col shadow-2xl z-50">
        <div class="p-4 border-b border-brand-700 flex justify-between items-center">
            <div class="flex items-center gap-3 sidebar-header-text">
                <div class="w-10 h-10 bg-sweet-500 rounded-full flex items-center justify-center">
                    <i class="fas üßÅ text-white"></i>
                </div>
                <div>
                    <h2 class="font-serif font-bold text-lg">Dulce Bocado</h2>
                    <p class="text-xs text-brand-300">ERP Supabase</p>
                </div>
            </div>
            <button onclick="toggleSidebar()" class="text-white hover:text-brand-200 transition-colors p-2 rounded-lg hover:bg-brand-700" title="Contraer/Expandir men√∫">
                <i class="fas fa-chevron-left text-lg" id="toggleIcon"></i>
            </button>
        </div>

        <nav class="flex-1 p-3 space-y-2 overflow-y-auto custom-scrollbar">
            <div class="text-xs font-semibold text-brand-400 uppercase tracking-wider mb-2 px-2 sidebar-section-title">Principal</div>
            
            <button onclick="showModule('dashboard')" data-title="Dashboard" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-brand-700 transition-colors text-left admin-only">
                <i class="fas fa-chart-pie w-5 text-center"></i>
                <span class="sidebar-text">Dashboard Financiero</span>
            </button>

            <button onclick="showModule('pos')" data-title="Punto de Venta" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-brand-700 transition-colors text-left">
                <i class="fas fa-cash-register w-5 text-center"></i>
                <span class="sidebar-text">Punto de Venta (POS)</span>
            </button>

            <button onclick="showModule('salesHistory')" data-title="Historial" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-brand-700 transition-colors text-left">
                <i class="fas fa-receipt w-5 text-center"></i>
                <span class="sidebar-text">Historial de Ventas</span>
            </button>

            <button onclick="showModule('expenses')" data-title="Gastos" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-brand-700 transition-colors text-left">
                <i class="fas fa-wallet w-5 text-center"></i>
                <span class="sidebar-text" id="expensesMenuText">Mis Gastos</span>
            </button>

            <button onclick="showModule('products')" data-title="Productos" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-brand-700 transition-colors text-left">
                <i class="fas fa-box w-5 text-center"></i>
                <span class="sidebar-text">Productos</span>
            </button>

            <div class="text-xs font-semibold text-brand-400 uppercase tracking-wider mt-6 mb-2 px-2 sidebar-section-title admin-only">Administraci√≥n</div>

            <button onclick="showModule('bank')" data-title="Bancos" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-brand-700 transition-colors text-left admin-only">
                <i class="fas fa-university w-5 text-center"></i>
                <span class="sidebar-text">Bancos y Efectivo</span>
            </button>

            <button onclick="showModule('taxes')" data-title="Impuestos" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-brand-700 transition-colors text-left admin-only">
                <i class="fas fa-calculator w-5 text-center"></i>
                <span class="sidebar-text">Impuestos (IVA/ISR)</span>
            </button>

            <button onclick="showModule('employees')" data-title="Empleados" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-brand-700 transition-colors text-left admin-only">
                <i class="fas fa-users w-5 text-center"></i>
                <span class="sidebar-text">Empleados</span>
            </button>

            <button onclick="showModule('nomina')" data-title="N√≥mina" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-brand-700 transition-colors text-left admin-only">
                <i class="fas fa-money-check-alt w-5 text-center"></i>
                <span class="sidebar-text">N√≥mina</span>
            </button>

            <!-- NUEVO: Bot√≥n Facturas Globales -->
            <button onclick="showModule('globalInvoices')" data-title="Facturas Globales" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-brand-700 transition-colors text-left admin-only">
                <i class="fas fa-file-invoice w-5 text-center"></i>
                <span class="sidebar-text">Facturas Globales</span>
            </button>
        </nav>

        <div class="p-3 border-t border-brand-700">
            <div class="flex items-center gap-3 mb-3 user-info">
                <div class="w-8 h-8 bg-brand-600 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-sm"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium truncate" id="currentUserName">Usuario</p>
                    <p class="text-xs text-brand-400" id="currentUserRole">Rol</p>
                </div>
            </div>
            <button onclick="logout()" data-title="Cerrar Sesi√≥n" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors text-sm group">
                <i class="fas fa-power-off text-lg"></i>
                <span class="sidebar-text">Cerrar Sesi√≥n</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main id="mainContent" class="flex-1 overflow-y-auto bg-gray-50 p-8 custom-scrollbar main-content">
        
        <!-- Dashboard Module -->
        <div id="dashboard" class="module fade-in">
            <div class="mb-8">
                <h1 class="text-3xl font-serif font-bold text-brand-900 mb-2">Dashboard Financiero</h1>
                <p class="text-gray-600">Resumen general del negocio (Datos en tiempo real)</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="glass-panel p-6 rounded-2xl card-hover border-l-4 border-green-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm mb-1">Ventas Reales del D√≠a</p>
                            <h3 class="text-2xl font-bold text-gray-800" id="dashboardTodaySales">$0.00</h3>
                        </div>
                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                    <p class="text-xs text-green-600 mt-2" id="salesStatus"><i class="fas fa-check-circle"></i> Sin cancelaciones</p>
                </div>

                <div class="glass-panel p-6 rounded-2xl card-hover border-l-4 border-blue-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm mb-1">IVA por Pagar</p>
                            <h3 class="text-2xl font-bold text-gray-800" id="dashboardIVA">$0.00</h3>
                        </div>
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                            <i class="fas fa-percentage"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Este mes</p>
                </div>

                <div class="glass-panel p-6 rounded-2xl card-hover border-l-4 border-purple-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm mb-1">ISR Estimado (RESICO)</p>
                            <h3 class="text-2xl font-bold text-gray-800" id="dashboardISR">$0.00</h3>
                        </div>
                        <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center text-purple-600">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">2.5% de ingresos</p>
                </div>

                <div class="glass-panel p-6 rounded-2xl card-hover border-l-4 border-orange-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm mb-1">Gastos del Mes</p>
                            <h3 class="text-2xl font-bold text-gray-800" id="dashboardExpenses">$0.00</h3>
                        </div>
                        <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center text-orange-600">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <p class="text-xs text-red-500 mt-2" id="expenseTrend"><i class="fas fa-arrow-down"></i> Ver detalle</p>
                </div>
            </div>

            <div id="cancelledAlert" class="hidden mb-6 glass-panel p-4 rounded-xl bg-red-50 border border-red-200">
                <div class="flex items-center gap-3 text-red-800">
                    <i class="fas fa-exclamation-triangle text-xl"></i>
                    <div>
                        <p class="font-bold">Hay ventas canceladas hoy</p>
                        <p class="text-sm">Total cancelado: <span id="cancelledAmount" class="font-bold">$0.00</span> | Ventas afectadas: <span id="cancelledCount">0</span></p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                 <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="text-lg font-bold text-brand-800 mb-4">Ventas vs Gastos (√öltimos 7 d√≠as)</h3>
                <div class="chart-container">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="text-lg font-bold text-brand-800 mb-4">Distribuci√≥n de Gastos por √Årea</h3>
                    <div class="chart-container">
                        <canvas id="expensesChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-6 rounded-2xl">
                <h3 class="text-lg font-bold text-brand-800 mb-4">Actividad Reciente</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="px-4 py-3 text-left rounded-l-lg">Fecha</th>
                                <th class="px-4 py-3 text-left">Concepto</th>
                                <th class="px-4 py-3 text-left">Tipo</th>
                                <th class="px-4 py-3 text-right rounded-r-lg">Monto</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivityTable" class="divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- POS Module -->
        <div id="pos" class="module hidden fade-in">
            <div class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-serif font-bold text-brand-900 mb-2">Punto de Venta</h1>
                    <p class="text-gray-600">Nueva venta - Los precios con IVA ya incluyen el 16%</p>
                </div>
                <button onclick="openCustomProductModal()" class="bg-sweet-500 hover:bg-sweet-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-plus mr-2"></i>Pastel Personalizado
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-200px)]">
                <div class="lg:col-span-2 glass-panel rounded-2xl p-6 overflow-y-auto custom-scrollbar">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="productSearch" class="search-input" placeholder="Buscar productos por nombre..." oninput="filterProductsBySearch(this.value)">
                    </div>
                    
                    <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                        <button onclick="filterProducts('all')" class="px-4 py-2 bg-brand-600 text-white rounded-full text-sm whitespace-nowrap hover:bg-brand-700 transition-colors">Todos</button>
                        <button onclick="filterProducts('pasteles')" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-full text-sm whitespace-nowrap hover:bg-gray-50 transition-colors">Pasteles</button>
                        <button onclick="filterProducts('postres')" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-full text-sm whitespace-nowrap hover:bg-gray-50 transition-colors">Postres</button>
                        <button onclick="filterProducts('decoracion')" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-full text-sm whitespace-nowrap hover:bg-gray-50 transition-colors">Decoraci√≥n</button>
                        <button onclick="filterProducts('herramientas')" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-full text-sm whitespace-nowrap hover:bg-gray-50 transition-colors">Herramientas</button>
                    </div>

                    <div id="productsGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    </div>
                </div>

                <div class="glass-panel rounded-2xl p-6 flex flex-col">
                    <h3 class="text-lg font-bold text-brand-800 mb-4">Ticket Actual</h3>
                    
                    <div id="cartItems" class="flex-1 overflow-y-auto custom-scrollbar space-y-3 mb-4">
                        <div class="text-center text-gray-400 py-8">
                            <i class="fas fa-shopping-basket text-4xl mb-2"></i>
                            <p>Carrito vac√≠o</p>
                        </div>
                    </div>

                    <div class="border-t pt-4 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Subtotal:</span>
                            <span class="font-medium" id="cartSubtotal">$0.00</span>
                        </div>
                        <div class="flex justify-between text-sm text-blue-600">
                            <span class="text-gray-600">IVA (16%):</span>
                            <span class="font-medium" id="cartIVA">$0.00</span>
                            <span class="text-xs text-gray-400">(incluido)</span>
                        </div>
                        <div class="flex justify-between text-lg font-bold text-brand-800 pt-2 border-t">
                            <span>Total:</span>
                            <span id="cartTotal">$0.00</span>
                        </div>
                    </div>

                    <div class="mt-4 space-y-2">
                        <label class="text-sm font-medium text-gray-700">M√©todo de Pago:</label>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button onclick="setPaymentMethod('efectivo')" id="btnEfectivo" class="payment-btn py-2 border-2 border-brand-500 bg-brand-50 text-brand-700 rounded-lg text-sm font-medium transition-all">
                                <i class="fas fa-money-bill-wave mr-1"></i>Efectivo
                            </button>
                            <button onclick="setPaymentMethod('transferencia')" id="btnTransferencia" class="payment-btn py-2 border-2 border-gray-300 text-gray-600 rounded-lg text-sm font-medium transition-all hover:border-brand-400">
                                <i class="fas fa-mobile-alt mr-1"></i>Transfer
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="setPaymentMethod('tarjeta')" id="btnTarjeta" class="payment-btn py-2 border-2 border-gray-300 text-gray-600 rounded-lg text-sm font-medium transition-all hover:border-brand-400">
                                <i class="fas fa-credit-card mr-1"></i>Tarjeta
                            </button>
                            <button onclick="openMixedPaymentModal()" id="btnMixto" class="payment-btn py-2 border-2 border-purple-300 text-purple-600 rounded-lg text-sm font-medium transition-all hover:border-purple-500 hover:bg-purple-50">
                                <i class="fas fa-calculator mr-1"></i>Pago Mixto
                            </button>
                        </div>
                        
                        <div id="mixedPaymentSummary" class="hidden mt-3 p-3 bg-purple-50 rounded-lg border border-purple-200">
                            <p class="text-xs font-bold text-purple-800 mb-2">Desglose del Pago:</p>
                            <div class="space-y-1 text-sm">
                                <div class="flex justify-between"><span class="text-gray-600">Efectivo:</span><span class="font-medium" id="mixedCash">$0.00</span></div>
                                <div class="flex justify-between"><span class="text-gray-600">Transferencia:</span><span class="font-medium" id="mixedTransfer">$0.00</span></div>
                                <div class="flex justify-between"><span class="text-gray-600">Tarjeta:</span><span class="font-medium" id="mixedCard">$0.00</span></div>
                                <div class="flex justify-between border-t border-purple-200 pt-1 mt-1">
                                    <span class="font-bold text-purple-900">Total:</span>
                                    <span class="font-bold text-purple-900" id="mixedTotal">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="processSale()" class="mt-4 w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-3 rounded-lg font-bold text-lg hover:from-green-700 hover:to-green-800 transition-all transform hover:scale-105 shadow-lg">
                        <i class="fas fa-check-circle mr-2"></i>Cobrar
                    </button>
                </div>
            </div>
        </div>

        <!-- Sales History Module -->
        <div id="salesHistory" class="module hidden fade-in">
            <div class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-serif font-bold text-brand-900 mb-2">Historial de Ventas</h1>
                    <p class="text-gray-600">Corte del d√≠a y ventas anteriores</p>
                </div>
                <button onclick="generateDailyCut()" class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded-lg transition-colors shadow-lg">
                    <i class="fas fa-cut mr-2"></i>Generar Corte del D√≠a
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="glass-panel p-6 rounded-2xl bg-gradient-to-br from-green-50 to-green-100 border border-green-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-800 text-sm font-medium">Ventas Hoy (Reales)</p>
                            <h3 class="text-2xl font-bold text-green-900" id="historyTotalSales">$0.00</h3>
                            <p class="text-xs text-green-700 mt-1"><span id="historyCount">0</span> transacciones</p>
                        </div>
                        <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-white text-xl">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-2xl bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-800 text-sm font-medium">En Caja Deber√≠a Haber</p>
                            <h3 class="text-2xl font-bold text-blue-900" id="historyShouldHave">$0.00</h3>
                            <div class="text-xs text-blue-700 mt-1 space-x-2">
                                <span id="cashTotal">E: $0</span>
                                <span id="transferTotal">T: $0</span>
                                <span id="cardTotal">C: $0</span>
                            </div>
                        </div>
                        <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white text-xl">
                            <i class="fas fa-cash-register"></i>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-2xl bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-800 text-sm font-medium">IVA Generado Hoy</p>
                            <h3 class="text-2xl font-bold text-purple-900" id="historyIVA">$0.00</h3>
                            <p class="text-xs text-purple-700 mt-1">IVA incluido en precios</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center text-white text-xl">
                            <i class="fas fa-receipt"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div id="historyCancelledSection" class="hidden mb-6 glass-panel p-4 rounded-xl bg-red-50 border border-red-200">
                <h4 class="font-bold text-red-800 mb-2">Ventas Canceladas Hoy</h4>
                <div class="grid grid-cols-3 gap-4 text-sm">
                    <div>
                        <span class="text-gray-600">Total Cancelado:</span>
                        <span class="font-bold text-red-600 ml-2" id="historyCancelledAmount">$0.00</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Ventas Afectadas:</span>
                        <span class="font-bold text-red-600 ml-2" id="historyCancelledCount">0</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Ventas Brutas:</span>
                        <span class="font-bold text-gray-600 ml-2" id="historyGrossSales">$0.00</span>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-4 rounded-xl mb-6 flex flex-wrap gap-4 items-center">
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">Desde:</label>
                    <input type="date" id="filterDateFrom" class="border border-gray-300 rounded-lg px-3 py-1 text-sm focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">Hasta:</label>
                    <input type="date" id="filterDateTo" class="border border-gray-300 rounded-lg px-3 py-1 text-sm focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
                <button onclick="filterSales()" class="bg-brand-600 text-white px-4 py-1 rounded-lg text-sm hover:bg-brand-700 transition-colors">
                    <i class="fas fa-filter mr-1"></i>Filtrar
                </button>
                <button onclick="loadTodaySales()" class="bg-gray-200 text-gray-700 px-4 py-1 rounded-lg text-sm hover:bg-gray-300 transition-colors">
                    Hoy
                </button>
            </div>

            <div class="glass-panel rounded-2xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-brand-50 text-brand-800">
                            <tr>
                                <th class="px-4 py-3 text-left">Folio</th>
                                <th class="px-4 py-3 text-left">Fecha/Hora</th>
                                <th class="px-4 py-3 text-left">Cajero</th>
                                <th class="px-4 py-3 text-left">Productos</th>
                                <th class="px-4 py-3 text-center">Tipo IVA</th>
                                <th class="px-4 py-3 text-left">M√©todo</th>
                                <th class="px-4 py-3 text-right">Total</th>
                                <th class="px-4 py-3 text-center">Estado</th>
                                <th class="px-4 py-3 text-center admin-only-inline">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody" class="divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- EXPENSES MODULE - COMPLETAMENTE REESTRUCTURADO -->
        <div id="expenses" class="module hidden fade-in">
            <div class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-serif font-bold text-brand-900 mb-2" id="expensesTitle">Gastos y Egresos</h1>
                    <p class="text-gray-600" id="expensesSubtitle">Control de egresos con items editables</p>
                </div>
                <button onclick="openExpenseModal()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition-colors shadow-lg">
                    <i class="fas fa-plus mr-2"></i>Registrar Gasto
                </button>
            </div>

            <div id="adminExpenseStats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="glass-panel p-4 rounded-xl border-l-4 border-red-500">
                    <p class="text-xs text-gray-500 uppercase">Producci√≥n</p>
                    <h4 class="text-lg font-bold text-gray-800" id="expenseProduction">$0.00</h4>
                </div>
                <div class="glass-panel p-4 rounded-xl border-l-4 border-blue-500">
                    <p class="text-xs text-gray-500 uppercase">Atenci√≥n Clientes</p>
                    <h4 class="text-lg font-bold text-gray-800" id="expenseCustomerService">$0.00</h4>
                </div>
                <div class="glass-panel p-4 rounded-xl border-l-4 border-yellow-500">
                    <p class="text-xs text-gray-500 uppercase">Administrativo</p>
                    <h4 class="text-lg font-bold text-gray-800" id="expenseAdmin">$0.00</h4>
                </div>
                <div class="glass-panel p-4 rounded-xl border-l-4 border-purple-500">
                    <p class="text-xs text-gray-500 uppercase">Otros</p>
                    <h4 class="text-lg font-bold text-gray-800" id="expenseOthers">$0.00</h4>
                </div>
            </div>

            <div id="cashierExpenseStats" class="hidden mb-6">
                <div class="glass-panel p-6 rounded-2xl bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-orange-800 text-sm font-medium">Total de Tus Gastos Registrados</p>
                            <h3 class="text-3xl font-bold text-orange-900" id="cashierTotalExpenses">$0.00</h3>
                            <p class="text-xs text-orange-700 mt-1">Este mes</p>
                        </div>
                        <div class="w-16 h-16 bg-orange-500 rounded-full flex items-center justify-center text-white text-2xl">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl overflow-hidden">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center flex-wrap gap-4">
                    <h3 class="font-bold text-brand-800" id="expensesTableTitle">Registro de Gastos</h3>
                    <div class="flex gap-2 items-center">
                        <span id="expenseFilterLabel" class="text-sm text-gray-600 hidden">Mostrando solo tus gastos</span>
                        <select id="expenseFilterArea" onchange="loadExpenses()" class="border border-gray-300 rounded-lg px-3 py-1 text-sm admin-only-inline">
                            <option value="all">Todas las √°reas</option>
                            <option value="produccion">Producci√≥n</option>
                            <option value="atencion">Atenci√≥n a Clientes</option>
                            <option value="administrativo">Administrativo</option>
                            <option value="otros">Otros</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="px-4 py-3 text-left">Fecha</th>
                                <th class="px-4 py-3 text-left admin-only-inline">√Årea</th>
                                <th class="px-4 py-3 text-left">Proveedor/Concepto</th>
                                <th class="px-4 py-3 text-center">Items</th>
                                <th class="px-4 py-3 text-left">M√©todo</th>
                                <th class="px-4 py-3 text-right">Total</th>
                                <th class="px-4 py-3 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody" class="divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Products Module -->
        <div id="products" class="module hidden fade-in">
            <div class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-serif font-bold text-brand-900 mb-2">Cat√°logo de Productos</h1>
                    <p class="text-gray-600">Precios con IVA ya incluyen el 16%</p>
                </div>
                <button onclick="openProductModal()" class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded-lg transition-colors shadow-lg admin-only-inline" id="btnNewProduct">
                    <i class="fas fa-plus mr-2"></i>Nuevo Producto
                </button>
            </div>

            <div class="glass-panel rounded-2xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-brand-50 text-brand-800">
                            <tr>
                                <th class="px-4 py-3 text-left">Nombre</th>
                                <th class="px-4 py-3 text-left">Categor√≠a</th>
                                <th class="px-4 py-3 text-center">Stock</th>
                                <th class="px-4 py-3 text-center">IVA Incluido</th>
                                <th class="px-4 py-3 text-right">Precio Final</th>
                                <th class="px-4 py-3 text-center">Estado</th>
                                <th class="px-4 py-3 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody" class="divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Bank Module -->
        <div id="bank" class="module hidden fade-in admin-only-content">
            <div class="mb-6">
                <h1 class="text-3xl font-serif font-bold text-brand-900 mb-2">Bancos y Efectivo</h1>
                <p class="text-gray-600">Saldos actualizados en tiempo real (incluye N√≥mina)</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-green-100 rounded-full -mr-16 -mt-16 opacity-50"></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-white text-xl">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Efectivo en Caja</h3>
                                <p class="text-sm text-gray-500">Ventas - Gastos - N√≥mina (Efectivo)</p>
                            </div>
                        </div>
                        <div class="text-3xl font-bold text-green-700 mb-2" id="cashBalance">$0.00</div>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-blue-100 rounded-full -mr-16 -mt-16 opacity-50"></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white text-xl">
                                <i class="fas fa-university"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Cuenta Bancaria</h3>
                                <p class="text-sm text-gray-500">Transferencias, tarjetas y N√≥mina bancaria</p>
                            </div>
                        </div>
                        <div class="text-3xl font-bold text-blue-700 mb-2" id="bankBalance">$0.00</div>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-6 rounded-2xl">
                <h3 class="text-lg font-bold text-brand-800 mb-4">Desglose de Movimientos</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="bankMovements">
                    <!-- Se llena din√°micamente -->
                </div>
            </div>
        </div>

        <!-- Taxes Module -->
        <div id="taxes" class="module hidden fade-in admin-only-content">
            <div class="mb-6">
                <h1 class="text-3xl font-serif font-bold text-brand-900 mb-2">Impuestos</h1>
                <p class="text-gray-600">Desglose de ventas por tipo de IVA y c√°lculo de impuestos</p>
            </div>

            <div class="glass-panel p-6 rounded-2xl mb-6 border-l-4 border-brand-500">
                <h3 class="text-lg font-bold text-brand-800 mb-4">
                    <i class="fas fa-calendar-alt mr-2"></i>Seleccionar Per√≠odo de An√°lisis
                </h3>
                <div class="flex flex-wrap gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Inicio</label>
                        <input type="date" id="taxDateFrom" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Fin</label>
                        <input type="date" id="taxDateTo" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <button onclick="calculateTaxesByPeriod()" class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded-lg transition-colors shadow-lg">
                        <i class="fas fa-search mr-2"></i>Analizar Per√≠odo
                    </button>
                    <button onclick="setTaxPeriodThisMonth()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition-colors">
                        Este Mes
                    </button>
                    <button onclick="setTaxPeriodLastMonth()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition-colors">
                        Mes Pasado
                    </button>
                </div>
            </div>

            <div id="taxPeriodSummary" class="hidden mb-6">
                <div class="glass-panel p-4 rounded-xl bg-brand-50 border border-brand-200 mb-4">
                    <h4 class="font-bold text-brand-800 mb-2">
                        <i class="fas fa-file-invoice mr-2"></i>Resumen del Per√≠odo: 
                        <span id="taxPeriodLabel" class="text-brand-600"></span>
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Total Ventas:</span>
                            <span class="font-bold text-brand-800 ml-2" id="taxPeriodTotalSales">$0.00</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Transacciones:</span>
                            <span class="font-bold text-brand-800 ml-2" id="taxPeriodTransactions">0</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Ventas IVA 0%:</span>
                            <span class="font-bold text-pink-600 ml-2" id="taxPeriodCount0">0</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Ventas IVA 16%:</span>
                            <span class="font-bold text-blue-600 ml-2" id="taxPeriodCount16">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden border-t-4 border-pink-400">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-pink-100 rounded-full -mr-16 -mt-16 opacity-50"></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-pink-500 rounded-full flex items-center justify-center text-white text-xl">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Ventas con IVA 0%</h3>
                                <p class="text-sm text-gray-500">Productos sin IVA (Exentos)</p>
                            </div>
                        </div>
                        <div class="text-3xl font-bold text-pink-700 mb-2" id="salesIVA0">$0.00</div>
                        <div class="text-sm text-gray-600 mb-4">
                            <span id="transactionsIVA0">0</span> transacciones
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden border-t-4 border-blue-400">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-blue-100 rounded-full -mr-16 -mt-16 opacity-50"></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white text-xl">
                                <i class="fas fa-receipt"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Ventas con IVA 16%</h3>
                                <p class="text-sm text-gray-500">IVA incluido en precios</p>
                            </div>
                        </div>
                        <div class="text-3xl font-bold text-blue-700 mb-2" id="salesIVA16">$0.00</div>
                        <div class="text-sm text-gray-600 mb-4">
                            <span id="transactionsIVA16">0</span> transacciones | 
                            IVA incluido: <span class="font-bold text-blue-600" id="ivaIncluded16">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="glass-panel p-6 rounded-2xl border-t-4 border-blue-500">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">IVA (16% incluido en precios)</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                            <span class="text-gray-700">IVA Cobrado (Ventas)</span>
                            <span class="font-bold text-blue-700" id="ivaCharged">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                            <span class="text-gray-700">IVA en Gastos</span>
                            <span class="font-bold text-red-700" id="ivaExpenses">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-blue-100 rounded-lg border-2 border-blue-300">
                            <span class="font-bold text-blue-900">IVA a Pagar</span>
                            <span class="font-bold text-xl text-blue-900" id="ivaToPay">$0.00</span>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-2xl border-t-4 border-purple-500">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">ISR - RESICO</h3>
                    <div class="bg-purple-50 p-4 rounded-lg mb-4">
                        <p class="text-sm text-purple-900 mb-2"><strong>R√©gimen:</strong> RESICO (Personas F√≠sicas)</p>
                        <p class="text-sm text-purple-900 mb-2"><strong>Actividad:</strong> Panificaci√≥n Tradicional</p>
                        <p class="text-sm text-purple-900"><strong>Tasa:</strong> 2.5% sobre ingresos</p>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Ingresos del Periodo:</span>
                            <span class="font-medium" id="isrIncome">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-purple-100 rounded-lg border-2 border-purple-300">
                            <span class="font-bold text-purple-900">ISR Estimado (2.5%):</span>
                            <span class="font-bold text-xl text-purple-900" id="isrAmount">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl overflow-hidden">
                <div class="p-4 border-b border-gray-200">
                    <h3 class="font-bold text-brand-800">Detalle de Ventas del Per√≠odo Analizado</h3>
                    <p class="text-sm text-gray-500 mt-1">Haz clic en una venta "Mixta" para ver el desglose por tipo de IVA</p>
                </div>
                <div class="overflow-x-auto max-h-96 overflow-y-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left">Folio</th>
                                <th class="px-4 py-3 text-left">Fecha</th>
                                <th class="px-4 py-3 text-left">Productos</th>
                                <th class="px-4 py-3 text-center">Tipo IVA</th>
                                <th class="px-4 py-3 text-right">Subtotal</th>
                                <th class="px-4 py-3 text-right">IVA</th>
                                <th class="px-4 py-3 text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody id="taxSalesDetailTable" class="divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Employees Module -->
        <div id="employees" class="module hidden fade-in admin-only-content">
            <div class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-serif font-bold text-brand-900 mb-2">Empleados</h1>
                    <p class="text-gray-600">Personal de Dulce Bocado</p>
                </div>
                <button onclick="openEmployeeModal()" class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded-lg transition-colors shadow-lg">
                    <i class="fas fa-plus mr-2"></i>Agregar Empleado
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass-panel p-6 rounded-2xl">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center text-orange-600">
                            <i class="fas fa-bread-slice"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-gray-800">Producci√≥n</h3>
                            <p class="text-xs text-gray-500" id="countProduction">0 empleados</p>
                        </div>
                    </div>
                    <div id="productionEmployees" class="space-y-3"></div>
                </div>

                <div class="glass-panel p-6 rounded-2xl">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center text-pink-600">
                            <i class="fas fa-headset"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-gray-800">Atenci√≥n a Clientes</h3>
                            <p class="text-xs text-gray-500" id="countService">0 empleados</p>
                        </div>
                    </div>
                    <div id="serviceEmployees" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <!-- NOMINA MODULE - AHORA CON IMPACTO EN BANCOS -->
        <div id="nomina" class="module hidden fade-in admin-only-content">
            <div class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-serif font-bold text-brand-900 mb-2">N√≥mina</h1>
                    <p class="text-gray-600">Gesti√≥n de pagos y sueldos (se registra autom√°ticamente como gasto)</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="generateNominaReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors shadow-lg">
                        <i class="fas fa-file-pdf mr-2"></i>Reporte Mensual
                    </button>
                    <button onclick="openNominaModal()" class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded-lg transition-colors shadow-lg">
                        <i class="fas fa-plus mr-2"></i>Registrar Pago
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="nomina-card p-4 rounded-xl text-white">
                    <p class="text-xs opacity-80 uppercase">Total N√≥mina Mes</p>
                    <h4 class="text-xl font-bold" id="totalNominaMes">$0.00</h4>
                </div>
                <div class="glass-panel p-4 rounded-xl border-l-4 border-green-500">
                    <p class="text-xs text-gray-500 uppercase">Sueldos Base</p>
                    <h4 class="text-lg font-bold text-gray-800" id="totalSueldos">$0.00</h4>
                </div>
                <div class="glass-panel p-4 rounded-xl border-l-4 border-yellow-500">
                    <p class="text-xs text-gray-500 uppercase">Horas Extras</p>
                    <h4 class="text-lg font-bold text-gray-800" id="totalHorasExtras">$0.00</h4>
                </div>
                <div class="glass-panel p-4 rounded-xl border-l-4 border-purple-500">
                    <p class="text-xs text-gray-500 uppercase">Bonos y Puntualidad</p>
                    <h4 class="text-lg font-bold text-gray-800" id="totalBonos">$0.00</h4>
                </div>
            </div>

            <div class="glass-panel rounded-2xl overflow-hidden">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center flex-wrap gap-4">
                    <h3 class="font-bold text-brand-800">Historial de Pagos</h3>
                    <div class="flex gap-2">
                        <select id="nominaFilterMonth" onchange="loadNomina()" class="border border-gray-300 rounded-lg px-3 py-1 text-sm">
                            <option value="all">Todos los meses</option>
                            <option value="0">Enero</option>
                            <option value="1">Febrero</option>
                            <option value="2">Marzo</option>
                            <option value="3">Abril</option>
                            <option value="4">Mayo</option>
                            <option value="5">Junio</option>
                            <option value="6">Julio</option>
                            <option value="7">Agosto</option>
                            <option value="8">Septiembre</option>
                            <option value="9">Octubre</option>
                            <option value="10">Noviembre</option>
                            <option value="11">Diciembre</option>
                        </select>
                        <select id="nominaFilterEmployee" onchange="loadNomina()" class="border border-gray-300 rounded-lg px-3 py-1 text-sm">
                            <option value="all">Todos los empleados</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="px-4 py-3 text-left">Fecha</th>
                                <th class="px-4 py-3 text-left">Empleado</th>
                                <th class="px-4 py-3 text-right">Sueldo Base</th>
                                <th class="px-4 py-3 text-center">Horas Extras</th>
                                <th class="px-4 py-3 text-right">Pago H.E.</th>
                                <th class="px-4 py-3 text-right">Bono</th>
                                <th class="px-4 py-3 text-right">Bono Punt.</th>
                                <th class="px-4 py-3 text-right">Total</th>
                                <th class="px-4 py-3 text-center">M√©todo</th>
                                <th class="px-4 py-3 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="nominaTableBody" class="divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mt-6 glass-panel p-6 rounded-2xl">
                <h3 class="text-lg font-bold text-brand-800 mb-4">Resumen por Empleado (Mes Actual)</h3>
                <div id="nominaResumenEmpleados" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </div>
            </div>
        </div>

        <!-- NUEVO: M√ìDULO DE FACTURAS GLOBALES -->
        <div id="globalInvoices" class="module hidden fade-in admin-only-content">
            <div class="mb-6">
                <h1 class="text-3xl font-serif font-bold text-brand-900 mb-2">Facturas Globales</h1>
                <p class="text-gray-600">Resumen semanal para facturaci√≥n global (CFDI)</p>
            </div>

            <div class="glass-panel p-6 rounded-2xl mb-6 border-l-4 border-brand-500">
                <h3 class="text-lg font-bold text-brand-800 mb-4">
                    <i class="fas fa-calendar-alt mr-2"></i>Seleccionar Mes para Facturaci√≥n
                </h3>
                <div class="flex flex-wrap gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mes</label>
                        <select id="globalInvoiceMonth" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                            <option value="0">Enero</option>
                            <option value="1">Febrero</option>
                            <option value="2">Marzo</option>
                            <option value="3">Abril</option>
                            <option value="4">Mayo</option>
                            <option value="5">Junio</option>
                            <option value="6">Julio</option>
                            <option value="7">Agosto</option>
                            <option value="8">Septiembre</option>
                            <option value="9">Octubre</option>
                            <option value="10">Noviembre</option>
                            <option value="11">Diciembre</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">A√±o</label>
                        <input type="number" id="globalInvoiceYear" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" value="2024">
                    </div>
                    <button onclick="loadGlobalInvoiceWeeks()" class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded-lg transition-colors shadow-lg">
                        <i class="fas fa-search mr-2"></i>Cargar Semanas
                    </button>
                    <button onclick="setCurrentMonthForGlobal()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition-colors">
                        Mes Actual
                    </button>
                </div>
            </div>

            <div id="globalInvoiceSummary" class="hidden mb-6">
                <div class="glass-panel p-4 rounded-xl bg-brand-50 border border-brand-200">
                    <h4 class="font-bold text-brand-800 mb-2">
                        <i class="fas fa-file-invoice-dollar mr-2"></i>Resumen del Mes: 
                        <span id="globalInvoiceMonthLabel" class="text-brand-600"></span>
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Total Ventas Mes:</span>
                            <span class="font-bold text-brand-800 ml-2" id="globalMonthTotal">$0.00</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Semanas:</span>
                            <span class="font-bold text-brand-800 ml-2" id="globalWeeksCount">0</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Semanas Facturadas:</span>
                            <span class="font-bold text-green-600 ml-2" id="globalWeeksInvoiced">0</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Pendientes:</span>
                            <span class="font-bold text-orange-600 ml-2" id="globalWeeksPending">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="weeksContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Las semanas se generan din√°micamente -->
            </div>

            <!-- Modal para detalle de semana -->
            <div id="weekDetailModal" class="modal">
                <div class="bg-white rounded-2xl p-6 w-full max-w-4xl mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="text-2xl font-bold text-brand-800" id="weekDetailTitle">Semana 1</h3>
                            <p class="text-gray-500" id="weekDetailDates">1-7 de Enero 2024</p>
                        </div>
                        <button onclick="closeModal('weekDetailModal')" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="glass-panel p-4 rounded-xl bg-pink-50 border border-pink-200">
                            <p class="text-xs text-pink-600 uppercase font-bold">Ventas IVA 0%</p>
                            <h4 class="text-xl font-bold text-pink-700" id="weekDetailIVA0">$0.00</h4>
                            <p class="text-xs text-gray-500 mt-1"><span id="weekDetailCount0">0</span> transacciones</p>
                        </div>
                        <div class="glass-panel p-4 rounded-xl bg-blue-50 border border-blue-200">
                            <p class="text-xs text-blue-600 uppercase font-bold">Ventas IVA 16%</p>
                            <h4 class="text-xl font-bold text-blue-700" id="weekDetailIVA16">$0.00</h4>
                            <p class="text-xs text-gray-500 mt-1"><span id="weekDetailCount16">0</span> transacciones</p>
                        </div>
                        <div class="glass-panel p-4 rounded-xl bg-green-50 border border-green-200">
                            <p class="text-xs text-green-600 uppercase font-bold">Total Semana</p>
                            <h4 class="text-xl font-bold text-green-700" id="weekDetailTotal">$0.00</h4>
                            <p class="text-xs text-gray-500 mt-1">IVA incluido: <span id="weekDetailIVATotal">$0.00</span></p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h4 class="font-bold text-gray-800 mb-3">Desglose para CFDI:</h4>
                        <div class="bg-gray-50 p-4 rounded-lg space-y-2 text-sm font-mono">
                            <div class="flex justify-between">
                                <span>Subtotal (IVA 0%):</span>
                                <span id="cfdiSubtotal0">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Subtotal (IVA 16%):</span>
                                <span id="cfdiSubtotal16">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span>IVA Trasladado (16%):</span>
                                <span id="cfdiIVA">$0.00</span>
                            </div>
                            <div class="flex justify-between border-t pt-2 font-bold text-lg">
                                <span>Total:</span>
                                <span id="cfdiTotal">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="markWeekAsInvoiced()" id="btnMarkInvoiced" class="flex-1 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-bold">
                            <i class="fas fa-check-circle mr-2"></i>Marcar como Facturada
                        </button>
                        <button onclick="exportWeekToExcel()" class="flex-1 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-bold">
                            <i class="fas fa-file-excel mr-2"></i>Exportar a Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </main>
</div>

<!-- MODALES -->

<!-- Modal Producto Personalizado -->
<div id="customProductModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 shadow-2xl">
        <h3 class="text-xl font-bold text-brand-800 mb-4">Pastel Personalizado</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
                <textarea id="customDesc" rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Ej: Pastel 3 pisos, fondant rosa..."></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Precio Final (IVA incluido si aplica) ($)</label>
                <input type="number" id="customPrice" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="0.00">
            </div>
            <div class="flex items-center gap-2">
                <input type="checkbox" id="customIVA" class="w-4 h-4 text-brand-600 rounded">
                <label for="customIVA" class="text-sm text-gray-700">Precio ya incluye IVA (16%)</label>
            </div>
        </div>
        <div class="flex gap-3 mt-6">
            <button onclick="closeModal('customProductModal')" class="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
            <button onclick="addCustomProduct()" class="flex-1 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition-colors">Agregar</button>
        </div>
    </div>
</div>

<!-- Modal Pago Mixto -->
<div id="mixedPaymentModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 shadow-2xl">
        <h3 class="text-xl font-bold text-purple-800 mb-4">
            <i class="fas fa-calculator mr-2"></i>Pago Mixto
        </h3>
        <div class="space-y-4 mb-4">
            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Efectivo</label>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-gray-500">$</span>
                    <input type="number" id="mixedPaymentCash" class="w-24 border border-gray-300 rounded-lg px-3 py-2 text-right focus:ring-2 focus:ring-green-500 outline-none" placeholder="0.00" step="0.01" oninput="validateMixedPayment()">
                </div>
            </div>

            <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Transferencia</label>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-gray-500">$</span>
                    <input type="number" id="mixedPaymentTransfer" class="w-24 border border-gray-300 rounded-lg px-3 py-2 text-right focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0.00" step="0.01" oninput="validateMixedPayment()">
                </div>
            </div>

            <div class="flex items-center justify-between p-3 bg-purple-50 rounded-lg">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center text-white">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tarjeta</label>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-gray-500">$</span>
                    <input type="number" id="mixedPaymentCard" class="w-24 border border-gray-300 rounded-lg px-3 py-2 text-right focus:ring-2 focus:ring-purple-500 outline-none" placeholder="0.00" step="0.01" oninput="validateMixedPayment()">
                </div>
            </div>
        </div>

        <div class="bg-gray-50 p-4 rounded-lg mb-4">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm text-gray-600">Total a Pagar:</span>
                <span class="font-bold text-lg" id="mixedPaymentTotalRequired">$0.00</span>
            </div>
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm text-gray-600">Total Distribuido:</span>
                <span class="font-bold text-lg" id="mixedPaymentDistributed">$0.00</span>
            </div>
            <div class="flex justify-between items-center pt-2 border-t border-gray-200">
                <span class="text-sm font-medium" id="mixedPaymentDiffLabel">Diferencia:</span>
                <span class="font-bold" id="mixedPaymentDifference">$0.00</span>
            </div>
            <div id="mixedPaymentAlert" class="hidden mt-2 p-2 bg-red-100 text-red-700 text-xs rounded text-center">
                <i class="fas fa-exclamation-circle mr-1"></i> Los montos no coinciden
            </div>
            <div id="mixedPaymentSuccess" class="hidden mt-2 p-2 bg-green-100 text-green-700 text-xs rounded text-center">
                <i class="fas fa-check-circle mr-1"></i> ¬°Montos correctos!
            </div>
        </div>

        <div class="grid grid-cols-2 gap-2 mb-4">
            <button onclick="autoDistribute('half')" class="py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-xs font-medium text-gray-700 transition-colors">
                <i class="fas fa-adjust mr-1"></i>50/50
            </button>
            <button onclick="autoDistribute('thirds')" class="py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-xs font-medium text-gray-700 transition-colors">
                <i class="fas fa-chart-pie mr-1"></i>Tercios
            </button>
        </div>

        <div class="flex gap-3">
            <button onclick="closeModal('mixedPaymentModal')" class="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
            <button onclick="confirmMixedPayment()" id="btnConfirmMixed" class="flex-1 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors opacity-50 cursor-not-allowed" disabled>
                Confirmar
            </button>
        </div>
    </div>
</div>

<!-- NUEVO: Modal de Gastos con Items Editables -->
<div id="expenseModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-4xl mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-bold text-brand-800 mb-4" id="expenseModalTitle">Registrar Gasto</h3>
        
        <!-- Encabezado del gasto -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">√Årea</label>
                <select id="expenseArea" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    <option value="produccion">Producci√≥n</option>
                    <option value="atencion">Atenci√≥n a Clientes</option>
                    <option value="administrativo">Administrativo</option>
                    <option value="otros">Otros</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Proveedor/Concepto General</label>
                <input type="text" id="expenseProvider" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Ej: Costco, Office Depot...">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">M√©todo de Pago</label>
                <select id="expenseMethod" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    <option value="efectivo">Efectivo</option>
                    <option value="transferencia">Transferencia</option>
                    <option value="tarjeta">Tarjeta</option>
                </select>
            </div>
        </div>

        <!-- Toggle para tipo de IVA -->
        <div class="flex items-center justify-between mb-4 p-3 bg-blue-50 rounded-lg">
            <div class="flex items-center gap-2">
                <input type="checkbox" id="expenseIVAIncluded" class="w-4 h-4 text-brand-600 rounded" onchange="toggleExpenseIVAMode()">
                <label for="expenseIVAIncluded" class="text-sm font-medium text-gray-700">
                    El monto total YA INCLUYE IVA (16%)
                </label>
            </div>
            <span class="text-xs text-blue-600" id="expenseIVAModeText">Modo: IVA se suma al subtotal</span>
        </div>

        <!-- Items del gasto -->
        <div class="mb-4">
            <div class="flex justify-between items-center mb-3">
                <h4 class="font-bold text-gray-800">Conceptos/Items</h4>
                <button onclick="addExpenseItem()" class="text-sm bg-brand-600 text-white px-3 py-1 rounded-lg hover:bg-brand-700 transition-colors">
                    <i class="fas fa-plus mr-1"></i>Agregar Item
                </button>
            </div>
            
            <div id="expenseItemsContainer" class="space-y-2">
                <!-- Los items se agregan din√°micamente -->
            </div>
        </div>

        <!-- Totales -->
        <div class="bg-brand-50 p-4 rounded-lg border-2 border-brand-200 mb-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div class="text-center">
                    <p class="text-gray-600">Subtotal</p>
                    <p class="text-lg font-bold text-gray-800" id="expenseSubtotal">$0.00</p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600">IVA (16%)</p>
                    <p class="text-lg font-bold text-blue-600" id="expenseIVATotal">$0.00</p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600">Total Items</p>
                    <p class="text-lg font-bold text-gray-800" id="expenseItemsCount">0</p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600 font-bold">TOTAL</p>
                    <p class="text-xl font-bold text-brand-800" id="expenseGrandTotal">$0.00</p>
                </div>
            </div>
        </div>

        <div class="flex gap-3">
            <button onclick="closeModal('expenseModal')" class="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
            <button onclick="saveExpense()" class="flex-1 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                <i class="fas fa-save mr-2"></i>Guardar Gasto
            </button>
        </div>
    </div>
</div>

<!-- Modal Editar Gasto -->
<div id="editExpenseModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-4xl mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-bold text-brand-800 mb-4">Editar Gasto</h3>
        <input type="hidden" id="editExpenseId">
        
        <!-- Mismo contenido que expenseModal pero para edici√≥n -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">√Årea</label>
                <select id="editExpenseArea" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    <option value="produccion">Producci√≥n</option>
                    <option value="atencion">Atenci√≥n a Clientes</option>
                    <option value="administrativo">Administrativo</option>
                    <option value="otros">Otros</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Proveedor/Concepto</label>
                <input type="text" id="editExpenseProvider" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">M√©todo de Pago</label>
                <select id="editExpenseMethod" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    <option value="efectivo">Efectivo</option>
                    <option value="transferencia">Transferencia</option>
                    <option value="tarjeta">Tarjeta</option>
                </select>
            </div>
        </div>

        <div class="flex items-center justify-between mb-4 p-3 bg-blue-50 rounded-lg">
            <div class="flex items-center gap-2">
                <input type="checkbox" id="editExpenseIVAIncluded" class="w-4 h-4 text-brand-600 rounded" onchange="toggleEditExpenseIVAMode()">
                <label for="editExpenseIVAIncluded" class="text-sm font-medium text-gray-700">
                    El monto total YA INCLUYE IVA (16%)
                </label>
            </div>
            <span class="text-xs text-blue-600" id="editExpenseIVAModeText">Modo: IVA se suma al subtotal</span>
        </div>

        <div class="mb-4">
            <div class="flex justify-between items-center mb-3">
                <h4 class="font-bold text-gray-800">Conceptos/Items</h4>
                <button onclick="addEditExpenseItem()" class="text-sm bg-brand-600 text-white px-3 py-1 rounded-lg hover:bg-brand-700 transition-colors">
                    <i class="fas fa-plus mr-1"></i>Agregar Item
                </button>
            </div>
            
            <div id="editExpenseItemsContainer" class="space-y-2">
                <!-- Items existentes se cargan aqu√≠ -->
            </div>
        </div>

        <div class="bg-brand-50 p-4 rounded-lg border-2 border-brand-200 mb-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div class="text-center">
                    <p class="text-gray-600">Subtotal</p>
                    <p class="text-lg font-bold text-gray-800" id="editExpenseSubtotal">$0.00</p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600">IVA (16%)</p>
                    <p class="text-lg font-bold text-blue-600" id="editExpenseIVATotal">$0.00</p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600">Total Items</p>
                    <p class="text-lg font-bold text-gray-800" id="editExpenseItemsCount">0</p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600 font-bold">TOTAL</p>
                    <p class="text-xl font-bold text-brand-800" id="editExpenseGrandTotal">$0.00</p>
                </div>
            </div>
        </div>

        <div class="flex gap-3">
            <button onclick="closeModal('editExpenseModal')" class="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
            <button onclick="updateExpense()" class="flex-1 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition-colors">
                <i class="fas fa-save mr-2"></i>Actualizar Gasto
            </button>
        </div>
    </div>
</div>

<!-- Modal Producto -->
<div id="productModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 shadow-2xl">
        <h3 class="text-xl font-bold text-brand-800 mb-4" id="productModalTitle">Nuevo Producto</h3>
        <input type="hidden" id="prodId">
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
                <input type="text" id="prodName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Categor√≠a</label>
                <select id="prodCategory" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    <option value="pasteles">Pasteles</option>
                    <option value="postres">Postres</option>
                    <option value="decoracion">Decoraci√≥n</option>
                    <option value="herramientas">Herramientas</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Precio Final ($) *</label>
                <input type="number" id="prodPrice" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" step="0.01">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Stock Actual</label>
                <input type="number" id="prodStock" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
            </div>
            <div class="flex items-center gap-2">
                <input type="checkbox" id="prodIVA" class="w-4 h-4 text-brand-600 rounded">
                <label for="prodIVA" class="text-sm text-gray-700">Precio incluye IVA (16%)</label>
            </div>
        </div>
        <div class="flex gap-3 mt-6">
            <button onclick="closeModal('productModal')" class="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
            <button onclick="saveProduct()" class="flex-1 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition-colors">Guardar</button>
        </div>
    </div>
</div>

<!-- Modal Stock -->
<div id="stockModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-sm mx-4 shadow-2xl">
        <h3 class="text-xl font-bold text-brand-800 mb-4">Ajustar Stock</h3>
        <input type="hidden" id="stockProdId">
        <div class="text-center mb-6">
            <div class="text-4xl mb-2" id="stockProdImage">üì¶</div>
            <h4 class="font-bold text-lg text-gray-800" id="stockProdName">Producto</h4>
            <p class="text-sm text-gray-500" id="stockProdCurrent">Stock actual: 0</p>
        </div>
        
        <div class="flex items-center justify-center gap-4 mb-6">
            <button onclick="adjustStockPreview(-1)" class="w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-700 font-bold text-lg">-</button>
            <input type="number" id="stockNewValue" class="stock-input-cashier text-xl" value="0" min="0">
            <button onclick="adjustStockPreview(1)" class="w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-700 font-bold text-lg">+</button>
        </div>
        
        <div class="bg-blue-50 p-3 rounded-lg mb-4 text-center">
            <p class="text-xs text-blue-600">Nuevo stock: <span id="stockPreview" class="font-bold text-lg">0</span></p>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('stockModal')" class="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
            <button onclick="saveStockAdjustment()" class="flex-1 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition-colors">Guardar Cambio</button>
        </div>
    </div>
</div>

<!-- Modal Empleado -->
<div id="employeeModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 shadow-2xl">
        <h3 class="text-xl font-bold text-brand-800 mb-4">Agregar Empleado</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo *</label>
                <input type="text" id="empName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">√Årea *</label>
                <select id="empArea" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    <option value="produccion">Producci√≥n</option>
                    <option value="atencion">Atenci√≥n a Clientes</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Puesto/Rol *</label>
                <input type="text" id="empRole" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
            </div>
        </div>
        <div class="flex gap-3 mt-6">
            <button onclick="closeModal('employeeModal')" class="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
            <button onclick="saveEmployee()" class="flex-1 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition-colors">Guardar</button>
        </div>
    </div>
</div>

<!-- Modal N√≥mina - AHORA CON M√âTODO DE PAGO -->
<div id="nominaModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-lg mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-bold text-brand-800 mb-4">Registrar Pago de N√≥mina</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Empleado *</label>
                <select id="nominaEmployee" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    <option value="">Seleccionar empleado...</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Periodo (Mes)</label>
                    <select id="nominaMonth" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                        <option value="0">Enero</option>
                        <option value="1">Febrero</option>
                        <option value="2">Marzo</option>
                        <option value="3">Abril</option>
                        <option value="4">Mayo</option>
                        <option value="5">Junio</option>
                        <option value="6">Julio</option>
                        <option value="7">Agosto</option>
                        <option value="8">Septiembre</option>
                        <option value="9">Octubre</option>
                        <option value="10">Noviembre</option>
                        <option value="11">Diciembre</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">A√±o</label>
                    <input type="number" id="nominaYear" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" value="2024">
                </div>
            </div>
            
            <!-- NUEVO: M√©todo de pago de n√≥mina -->
            <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                <label class="block text-sm font-medium text-gray-700 mb-2">M√©todo de Pago de N√≥mina *</label>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="setNominaPaymentMethod('efectivo')" id="btnNominaEfectivo" class="payment-nomina-btn py-2 border-2 border-brand-500 bg-brand-50 text-brand-700 rounded-lg text-sm font-medium transition-all">
                        <i class="fas fa-money-bill-wave mr-1"></i>Efectivo
                    </button>
                    <button onclick="setNominaPaymentMethod('transferencia')" id="btnNominaTransferencia" class="payment-nomina-btn py-2 border-2 border-gray-300 text-gray-600 rounded-lg text-sm font-medium transition-all hover:border-brand-400">
                        <i class="fas fa-mobile-alt mr-1"></i>Transfer
                    </button>
                    <button onclick="setNominaPaymentMethod('tarjeta')" id="btnNominaTarjeta" class="payment-nomina-btn py-2 border-2 border-gray-300 text-gray-600 rounded-lg text-sm font-medium transition-all hover:border-brand-400">
                        <i class="fas fa-credit-card mr-1"></i>Tarjeta
                    </button>
                </div>
                <input type="hidden" id="nominaPaymentMethod" value="efectivo">
            </div>

            <div class="border-t pt-4">
                <h4 class="font-bold text-gray-800 mb-3">Conceptos de Pago</h4>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sueldo Base ($)</label>
                        <input type="number" id="nominaSueldo" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="0.00" oninput="calculateNominaTotal()">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Horas Extras</label>
                            <input type="number" id="nominaHorasExtras" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="0" oninput="calculateNominaTotal()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pago por Hora ($)</label>
                            <input type="number" id="nominaPagoHoraExtra" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="0.00" oninput="calculateNominaTotal()">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bono Productividad ($)</label>
                            <input type="number" id="nominaBono" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="0.00" oninput="calculateNominaTotal()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bono Puntualidad ($)</label>
                            <input type="number" id="nominaBonoPuntualidad" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="0.00" oninput="calculateNominaTotal()">
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-brand-50 p-4 rounded-lg border-2 border-brand-200">
                <div class="flex justify-between items-center">
                    <span class="font-bold text-brand-800">TOTAL A PAGAR:</span>
                    <span class="text-2xl font-bold text-brand-800" id="nominaTotal">$0.00</span>
                </div>
                <p class="text-xs text-gray-500 mt-1">Se registrar√° autom√°ticamente como gasto</p>
            </div>
        </div>
        <div class="flex gap-3 mt-6">
            <button onclick="closeModal('nominaModal')" class="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
            <button onclick="saveNomina()" class="flex-1 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition-colors">Guardar Pago</button>
        </div>
    </div>
</div>

<!-- Modal Corte -->
<div id="cutModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-lg mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-brand-100 rounded-full mx-auto mb-3 flex items-center justify-center text-brand-600 text-2xl">
                <i class="fas fa-cut"></i>
            </div>
            <h3 class="text-2xl font-bold text-brand-800">Corte del D√≠a</h3>
            <p class="text-gray-500" id="cutDate"></p>
        </div>

        <div class="space-y-4 mb-6">
            <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                <span class="text-green-800">Ventas Reales:</span>
                <span class="font-bold text-green-900" id="cutTotal">$0.00</span>
            </div>
            <div class="grid grid-cols-3 gap-2 text-center">
                <div class="p-2 bg-gray-50 rounded">
                    <p class="text-xs text-gray-500">Efectivo</p>
                    <p class="font-bold text-gray-800" id="cutCash">$0</p>
                </div>
                <div class="p-2 bg-gray-50 rounded">
                    <p class="text-xs text-gray-500">Transfer</p>
                    <p class="font-bold text-gray-800" id="cutTransfer">$0</p>
                </div>
                <div class="p-2 bg-gray-50 rounded">
                    <p class="text-xs text-gray-500">Tarjeta</p>
                    <p class="font-bold text-gray-800" id="cutCard">$0</p>
                </div>
            </div>
            <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                <span class="text-blue-800">IVA Generado:</span>
                <span class="font-bold text-blue-900" id="cutIVA">$0.00</span>
            </div>
            <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                <span class="text-purple-800">Transacciones:</span>
                <span class="font-bold text-purple-900" id="cutTransactions">0</span>
            </div>
            <div id="cutCancelledSection" class="hidden flex justify-between items-center p-3 bg-red-50 rounded-lg border border-red-200">
                <span class="text-red-800">Ventas Canceladas:</span>
                <span class="font-bold text-red-900" id="cutCancelledAmount">$0.00</span>
            </div>
        </div>

        <div class="border-t pt-4">
            <h4 class="font-bold text-gray-800 mb-2">Desglose de Ventas:</h4>
            <div id="cutDetails" class="text-sm space-y-1 max-h-40 overflow-y-auto"></div>
        </div>

        <button onclick="closeModal('cutModal')" class="w-full mt-6 py-3 bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition-colors">
            Cerrar
        </button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // ============================================
    // CONFIGURACI√ìN SUPABASE
    // ============================================
    const SUPABASE_URL = 'https://qvisoofgwuuhfnbzytnb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2aXNvb2Znd3V1aGZuYnp5dG5iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzODE4MDAsImV4cCI6MjA4Njk1NzgwMH0.816vyiAx3RBlGWyyjC-4AU_-4yMHv0wW1g0CXqhahjs';

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Variables globales
    let currentUser = null;
    let currentProfile = null;
    let cart = [];
    let currentPaymentMethod = 'efectivo';
    let mixedPaymentData = { efectivo: 0, transferencia: 0, tarjeta: 0 };
    let isMixedPayment = false;
    let products = [];
    let employees = [];
    let salesChartInstance = null;
    let expensesChartInstance = null;
    let currentProductFilter = 'all';
    let deferredPrompt = null;
    let isSidebarMini = false;
    let expandedSales = new Set();
    
    // NUEVOS: Variables para gastos
    let expenseItems = [];
    let editExpenseItems = [];
    let currentEditingExpenseId = null;
    
    // NUEVOS: Variables para facturas globales
    let currentGlobalInvoiceWeeks = [];
    let selectedWeekForInvoice = null;

    // ============================================
    // PWA - SERVICE WORKER & INSTALL
    // ============================================
    
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
            const CACHE_NAME = 'dulce-bocado-v1';
            const urlsToCache = [
                '/',
                'https://cdn.tailwindcss.com',
                'https://unpkg.com/@supabase/supabase-js@2',
                'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css',
                'https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap',
                'https://cdn.jsdelivr.net/npm/chart.js'
            ];

            self.addEventListener('install', event => {
                event.waitUntil(
                    caches.open(CACHE_NAME)
                        .then(cache => cache.addAll(urlsToCache))
                );
            });

            self.addEventListener('fetch', event => {
                event.respondWith(
                    caches.match(event.request)
                        .then(response => {
                            if (response) return response;
                            return fetch(event.request);
                        })
                );
            });
        `)).then(registration => {
            console.log('Service Worker registrado:', registration);
        }).catch(error => {
            console.log('Error al registrar Service Worker:', error);
        });
    }

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('installPWA').style.display = 'block';
    });

    function installApp() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('Usuario acept√≥ instalar la PWA');
                    document.getElementById('installPWA').style.display = 'none';
                }
                deferredPrompt = null;
            });
        }
    }

    // ============================================
    // AUTENTICACI√ìN
    // ============================================
    
    function showRegisterForm() {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('registerForm').classList.remove('hidden');
    }

    function showLoginForm() {
        document.getElementById('registerForm').classList.add('hidden');
        document.getElementById('loginForm').classList.remove('hidden');
    }

    async function register() {
        const email = document.getElementById('regEmail').value;
        const password = document.getElementById('regPassword').value;
        const name = document.getElementById('regName').value;
        const role = document.getElementById('regRole').value;

        if (!email || !password || !name) {
            alert('Complete todos los campos');
            return;
        }

        try {
            const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                email,
                password
            });

            if (authError) throw authError;

            const { error: profileError } = await supabaseClient
                .from('profiles')
                .insert([{
                    id: authData.user.id,
                    username: email,
                    role: role,
                    full_name: name
                }]);

            if (profileError) throw profileError;

            alert('Cuenta creada exitosamente. Ahora puedes iniciar sesi√≥n.');
            showLoginForm();
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function login() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        try {
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email,
                password
            });

            if (error) throw error;

            await initializeApp();
        } catch (error) {
            alert('Error de inicio de sesi√≥n: ' + error.message);
        }
    }

    async function logout() {
        await supabaseClient.auth.signOut();
        location.reload();
    }

    async function checkSession() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
            await initializeApp();
        }
    }

    // ============================================
    // INICIALIZACI√ìN
    // ============================================

    async function initializeApp() {
        try {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) return;

            const { data: profile, error } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .single();

            if (error) throw error;

            currentUser = user;
            currentProfile = profile;

            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('currentUserName').textContent = profile.full_name || profile.username;
            document.getElementById('currentUserRole').textContent = profile.role === 'admin' ? 'Administrador' : 'Cajero';

            if (profile.role === 'cashier') {
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = 'none';
                });
                document.querySelectorAll('.admin-only-inline').forEach(el => {
                    el.style.display = 'none';
                });
                document.querySelectorAll('.admin-only-content').forEach(el => {
                    el.classList.add('hidden');
                });
                
                document.getElementById('expensesMenuText').textContent = 'Mis Gastos';
                document.getElementById('adminExpenseStats').classList.add('hidden');
                document.getElementById('cashierExpenseStats').classList.remove('hidden');
                document.getElementById('expenseFilterLabel').classList.remove('hidden');
                document.getElementById('expensesTableTitle').textContent = 'Mis Gastos Registrados';
                
                showModule('pos');
            } else {
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = '';
                });
                document.querySelectorAll('.admin-only-inline').forEach(el => {
                    el.style.display = '';
                });
                document.querySelectorAll('.admin-only-content').forEach(el => {
                    el.classList.remove('hidden');
                });
                
                document.getElementById('cashierExpenseStats').classList.add('hidden');
                showModule('dashboard');
            }

            await loadProducts();
            await loadEmployees();
            await updateDashboard();
            await loadTodaySales();
            
            setupRealtimeSubscriptions();
            
        } catch (error) {
            console.error('Error initializing:', error);
            alert('Error al inicializar la aplicaci√≥n');
        }
    }

    function setupRealtimeSubscriptions() {
        supabaseClient
            .channel('sales_changes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'sales' }, payload => {
                if (currentProfile?.role === 'admin') {
                    updateDashboard();
                    loadTodaySales();
                }
            })
            .subscribe();
    }

    // ============================================
    // NAVEGACI√ìN
    // ============================================

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const toggleIcon = document.getElementById('toggleIcon');
        
        isSidebarMini = !isSidebarMini;
        
        if (isSidebarMini) {
            sidebar.classList.add('mini');
            toggleIcon.classList.remove('fa-chevron-left');
            toggleIcon.classList.add('fa-chevron-right');
        } else {
            sidebar.classList.remove('mini');
            toggleIcon.classList.remove('fa-chevron-right');
            toggleIcon.classList.add('fa-chevron-left');
        }
    }

    async function showModule(moduleName) {
        if (currentProfile?.role === 'cashier') {
            const allowedModules = ['pos', 'salesHistory', 'expenses', 'products'];
            if (!allowedModules.includes(moduleName)) {
                alert('No tienes permisos para acceder a esta secci√≥n');
                return;
            }
        }
        
        document.querySelectorAll('.module').forEach(m => m.classList.add('hidden'));
        document.getElementById(moduleName).classList.remove('hidden');
        
        switch(moduleName) {
            case 'pos': await loadProducts(); break;
            case 'salesHistory': await loadTodaySales(); break;
            case 'expenses': await loadExpenses(); break;
            case 'products': await loadProductsTable(); break;
            case 'bank': await updateBankModule(); break;
            case 'taxes': setTaxPeriodThisMonth(); break;
            case 'employees': await loadEmployees(); break;
            case 'nomina': await loadNomina(); break;
            case 'dashboard': await updateDashboard(); break;
            case 'globalInvoices': setCurrentMonthForGlobal(); break;
        }
        
        if (window.innerWidth < 768 && !isSidebarMini) {
            toggleSidebar();
        }
    }

    // ============================================
    // DASHBOARD
    // ============================================

    async function updateDashboard() {
        try {
            const today = new Date().toISOString().split('T')[0];
            
            const { data: todaySales } = await supabaseClient
                .from('sales')
                .select('*')
                .gte('created_at', today)
                .eq('cancelled', false);

            const { data: todayCancelled } = await supabaseClient
                .from('sales')
                .select('*')
                .gte('created_at', today)
                .eq('cancelled', true);

            const todayTotal = todaySales?.reduce((sum, s) => sum + s.total, 0) || 0;
            const cancelledTotal = todayCancelled?.reduce((sum, s) => sum + s.total, 0) || 0;
            
            document.getElementById('dashboardTodaySales').textContent = formatMoney(todayTotal);
            
            const cancelledAlert = document.getElementById('cancelledAlert');
            if (todayCancelled?.length > 0) {
                cancelledAlert.classList.remove('hidden');
                document.getElementById('cancelledAmount').textContent = formatMoney(cancelledTotal);
                document.getElementById('cancelledCount').textContent = todayCancelled.length;
                document.getElementById('salesStatus').innerHTML = `<i class="fas fa-exclamation-circle text-red-500"></i> ${todayCancelled.length} venta(s) cancelada(s)`;
                document.getElementById('salesStatus').className = 'text-xs text-red-600 mt-2';
            } else {
                cancelledAlert.classList.add('hidden');
                document.getElementById('salesStatus').innerHTML = '<i class="fas fa-check-circle"></i> Sin cancelaciones';
                document.getElementById('salesStatus').className = 'text-xs text-green-600 mt-2';
            }
            
            const firstDayOfMonth = new Date();
            firstDayOfMonth.setDate(1);
            
            const { data: monthSales } = await supabaseClient
                .from('sales')
                .select('total, iva')
                .gte('created_at', firstDayOfMonth.toISOString())
                .eq('cancelled', false);

            const ivaTotal = monthSales?.reduce((sum, s) => sum + s.iva, 0) || 0;
            document.getElementById('dashboardIVA').textContent = formatMoney(ivaTotal);
            
            const totalIncome = monthSales?.reduce((sum, s) => sum + s.total, 0) || 0;
            const isr = totalIncome * 0.025;
            document.getElementById('dashboardISR').textContent = formatMoney(isr);

            const { data: monthExpenses } = await supabaseClient
                .from('expenses')
                .select('amount')
                .gte('created_at', firstDayOfMonth.toISOString());

            const totalExpenses = monthExpenses?.reduce((sum, e) => sum + e.amount, 0) || 0;
            document.getElementById('dashboardExpenses').textContent = formatMoney(totalExpenses);
            
            const { data: recentSales } = await supabaseClient
                .from('sales')
                .select('*')
                .eq('cancelled', false)
                .order('created_at', { ascending: false })
                .limit(5);

            const { data: recentExpenses } = await supabaseClient
                .from('expenses')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(5);

            const recent = [
                ...(recentSales || []).map(s => ({...s, type: 'sale'})), 
                ...(recentExpenses || []).map(e => ({...e, type: 'expense'}))
            ].sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 5);
            
            const tbody = document.getElementById('recentActivityTable');
            tbody.innerHTML = recent.map(item => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-4 py-3 text-gray-600">${new Date(item.created_at).toLocaleDateString()}</td>
                    <td class="px-4 py-3 font-medium">${item.type === 'sale' ? 'Venta' : item.concept}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs ${item.type === 'sale' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            ${item.type === 'sale' ? 'Ingreso' : 'Egreso'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-right font-bold ${item.type === 'sale' ? 'text-green-600' : 'text-red-600'}">
                        ${item.type === 'sale' ? '+' : '-'}${formatMoney(item.total || item.amount)}
                    </td>
                </tr>
            `).join('');

            if (currentProfile?.role === 'admin') {
                await initCharts();
            }
            
        } catch (error) {
            console.error('Error updating dashboard:', error);
        }
    }

    async function initCharts() {
        try {
            const last7Days = Array.from({length: 7}, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (6 - i));
                return d.toISOString().split('T')[0];
            });

            const { data: salesData } = await supabaseClient
                .from('sales')
                .select('total, created_at')
                .eq('cancelled', false)
                .gte('created_at', last7Days[0]);

            const { data: expensesData } = await supabaseClient
                .from('expenses')
                .select('amount, created_at')
                .gte('created_at', last7Days[0]);

            const dailySales = last7Days.map(date => {
                return salesData
                    ?.filter(s => s.created_at.startsWith(date))
                    .reduce((sum, s) => sum + s.total, 0) || 0;
            });

            const dailyExpenses = last7Days.map(date => {
                return expensesData
                    ?.filter(e => e.created_at.startsWith(date))
                    .reduce((sum, e) => sum + e.amount, 0) || 0;
            });

            const ctx1 = document.getElementById('salesChart');
            if (ctx1) {
                if (salesChartInstance) salesChartInstance.destroy();
                salesChartInstance = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: last7Days.map(d => new Date(d).toLocaleDateString('es', {weekday: 'short'})),
                        datasets: [{
                            label: 'Ventas',
                            data: dailySales,
                            borderColor: '#a77f70',
                            backgroundColor: 'rgba(167, 127, 112, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'Gastos',
                            data: dailyExpenses,
                            borderColor: '#e83e5f',
                            backgroundColor: 'rgba(232, 62, 95, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                position: 'bottom',
                                labels: { boxWidth: 12, padding: 10 }
                            } 
                        }
                    }
                });
            }

            const { data: allExpenses } = await supabaseClient
                .from('expenses')
                .select('area, amount');

            const areaTotals = ['produccion', 'atencion', 'administrativo', 'otros'].map(area => {
                return allExpenses
                    ?.filter(e => e.area === area)
                    .reduce((sum, e) => sum + e.amount, 0) || 0;
            });

            const ctx2 = document.getElementById('expensesChart');
            if (ctx2) {
                if (expensesChartInstance) expensesChartInstance.destroy();
                expensesChartInstance = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['Producci√≥n', 'Atenci√≥n', 'Administrativo', 'Otros'],
                        datasets: [{
                            data: areaTotals,
                            backgroundColor: ['#f97316', '#3b82f6', '#eab308', '#a855f7']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                position: 'bottom',
                                labels: { boxWidth: 12, padding: 10 }
                            } 
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error initializing charts:', error);
        }
    }

    // ============================================
    // PRODUCTOS (POS)
    // ============================================

    async function loadProducts(filter = 'all') {
        try {
            currentProductFilter = filter;
            const { data, error } = await supabaseClient
                .from('products')
                .select('*')
                .eq('is_active', true)
                .order('name');

            if (error) throw error;
            products = data || [];

            renderProductsGrid(products, filter);
        } catch (error) {
            console.error('Error loading products:', error);
        }
    }

    function renderProductsGrid(productsToRender, filter = 'all') {
        const grid = document.getElementById('productsGrid');
        let filtered = productsToRender;
        
        if (filter !== 'all') {
            filtered = productsToRender.filter(p => p.category === filter);
        }
        
        filtered.sort((a, b) => {
            if (a.stock > 0 && b.stock <= 0) return -1;
            if (a.stock <= 0 && b.stock > 0) return 1;
            return a.name.localeCompare(b.name);
        });
        
        grid.innerHTML = filtered.map(p => {
            const hasStock = p.stock > 0;
            const stockClass = p.stock > 10 ? 'high' : p.stock > 0 ? 'low' : 'none';
            const stockText = p.stock > 0 ? `Stock: ${p.stock}` : 'Agotado';
            
            return `
                <div onclick="${hasStock ? `addToCart('${p.id}')` : ''}" 
                     class="product-card ${hasStock ? 'has-stock' : 'no-stock'} bg-white p-4 rounded-xl shadow-md hover:shadow-xl transition-all cursor-pointer transform hover:scale-105 border-2 border-transparent hover:border-brand-300 relative">
                    
                    ${hasStock ? `<span class="stock-badge ${stockClass}">${stockText}</span>` : '<span class="stock-badge none">AGOTADO</span>'}
                    
                    <div class="text-4xl mb-2 text-center">${p.image || 'üì¶'}</div>
                    <h4 class="font-bold text-gray-800 text-sm mb-1">${p.name}</h4>
                    <p class="text-xs ${p.has_iva ? 'text-blue-600 font-medium' : 'text-gray-500'} mb-2">
                        ${p.has_iva ? 'IVA incluido' : 'Sin IVA'}
                    </p>
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-brand-700">${formatMoney(p.price)}</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    function filterProducts(category) {
        document.querySelectorAll('#pos button[onclick^="filterProducts"]').forEach(btn => {
            btn.classList.remove('bg-brand-600', 'text-white');
            btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-300');
        });
        
        event.target.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-300');
        event.target.classList.add('bg-brand-600', 'text-white');
        
        const searchValue = document.getElementById('productSearch').value.toLowerCase();
        if (searchValue) {
            filterProductsBySearch(searchValue);
        } else {
            renderProductsGrid(products, category);
        }
    }

    function filterProductsBySearch(searchTerm) {
        const term = searchTerm.toLowerCase();
        const filtered = products.filter(p => 
            p.name.toLowerCase().includes(term) || 
            p.category.toLowerCase().includes(term)
        );
        renderProductsGrid(filtered, currentProductFilter);
    }

    function addToCart(productId) {
        const product = products.find(p => p.id === productId);
        if (!product || product.stock <= 0) {
            alert('Producto sin stock disponible');
            return;
        }
        
        const existing = cart.find(item => item.id === productId);
        if (existing) {
            if (existing.quantity >= product.stock) {
                alert('No hay suficiente stock');
                return;
            }
            existing.quantity++;
        } else {
            cart.push({
                id: product.id,
                name: product.name,
                price: product.price,
                hasIVA: product.has_iva,
                image: product.image,
                quantity: 1
            });
        }
        updateCart();
    }

    function addCustomProduct() {
        const desc = document.getElementById('customDesc').value;
        const price = parseFloat(document.getElementById('customPrice').value);
        const hasIVA = document.getElementById('customIVA').checked;
        
        if (!desc || !price) {
            alert('Complete todos los campos');
            return;
        }
        
        cart.push({
            id: 'custom_' + Date.now(),
            name: desc,
            price: price,
            hasIVA: hasIVA,
            quantity: 1,
            isCustom: true
        });
        
        updateCart();
        closeModal('customProductModal');
        
        document.getElementById('customDesc').value = '';
        document.getElementById('customPrice').value = '';
        document.getElementById('customIVA').checked = false;
    }

    function updateCart() {
        const container = document.getElementById('cartItems');
        if (cart.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-400 py-8">
                    <i class="fas fa-shopping-basket text-4xl mb-2"></i>
                    <p>Carrito vac√≠o</p>
                </div>
            `;
        } else {
            container.innerHTML = cart.map((item, index) => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                    <div class="flex-1">
                        <h4 class="font-medium text-sm text-gray-800">${item.name}</h4>
                        <p class="text-xs text-gray-500">${formatMoney(item.price)} c/u ${item.hasIVA ? '(IVA incl.)' : ''}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="updateQuantity(${index}, -1)" class="w-6 h-6 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-600">-</button>
                        <span class="font-medium w-6 text-center">${item.quantity}</span>
                        <button onclick="updateQuantity(${index}, 1)" class="w-6 h-6 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-600">+</button>
                        <button onclick="removeFromCart(${index})" class="ml-2 text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }
        calculateTotals();
    }

    function updateQuantity(index, change) {
        const item = cart[index];
        if (change > 0 && !item.isCustom) {
            const product = products.find(p => p.id === item.id);
            if (product && item.quantity >= product.stock) {
                alert('No hay suficiente stock');
                return;
            }
        }
        
        cart[index].quantity += change;
        if (cart[index].quantity <= 0) {
            cart.splice(index, 1);
        }
        updateCart();
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        updateCart();
    }

    function calculateTotals() {
        let subtotalSinIVA = 0;
        let totalIVA = 0;
        
        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            if (item.hasIVA) {
                const subtotalItem = itemTotal / 1.16;
                const ivaItem = itemTotal - subtotalItem;
                subtotalSinIVA += subtotalItem;
                totalIVA += ivaItem;
            } else {
                subtotalSinIVA += itemTotal;
            }
        });
        
        document.getElementById('cartSubtotal').textContent = formatMoney(subtotalSinIVA);
        document.getElementById('cartIVA').textContent = formatMoney(totalIVA);
        document.getElementById('cartTotal').textContent = formatMoney(subtotalSinIVA + totalIVA);
    }

    // ============================================
    // PAGO MIXTO
    // ============================================

    function setPaymentMethod(method) {
        currentPaymentMethod = method;
        isMixedPayment = false;
        mixedPaymentData = { efectivo: 0, transferencia: 0, tarjeta: 0 };
        
        document.getElementById('mixedPaymentSummary').classList.add('hidden');
        
        document.querySelectorAll('.payment-btn').forEach(btn => {
            btn.classList.remove('border-brand-500', 'bg-brand-50', 'text-brand-700', 'border-purple-500', 'bg-purple-50', 'text-purple-700');
            btn.classList.add('border-gray-300', 'text-gray-600');
        });
        
        const activeBtn = document.getElementById('btn' + method.charAt(0).toUpperCase() + method.slice(1));
        if (activeBtn) {
            activeBtn.classList.remove('border-gray-300', 'text-gray-600');
            if (method === 'mixto') {
                activeBtn.classList.add('border-purple-500', 'bg-purple-50', 'text-purple-700');
            } else {
                activeBtn.classList.add('border-brand-500', 'bg-brand-50', 'text-brand-700');
            }
        }
    }

    function openMixedPaymentModal() {
        if (cart.length === 0) {
            alert('El carrito est√° vac√≠o');
            return;
        }
        
        let subtotalSinIVA = 0;
        let totalIVA = 0;
        
        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            if (item.hasIVA) {
                const subtotalItem = itemTotal / 1.16;
                const ivaItem = itemTotal - subtotalItem;
                subtotalSinIVA += subtotalItem;
                totalIVA += ivaItem;
            } else {
                subtotalSinIVA += itemTotal;
            }
        });
        
        const total = subtotalSinIVA + totalIVA;
        
        document.getElementById('mixedPaymentTotalRequired').textContent = formatMoney(total);
        document.getElementById('mixedPaymentDistributed').textContent = '$0.00';
        document.getElementById('mixedPaymentDifference').textContent = formatMoney(total);
        
        document.getElementById('mixedPaymentCash').value = '';
        document.getElementById('mixedPaymentTransfer').value = '';
        document.getElementById('mixedPaymentCard').value = '';
        
        document.getElementById('mixedPaymentAlert').classList.add('hidden');
        document.getElementById('mixedPaymentSuccess').classList.add('hidden');
        document.getElementById('btnConfirmMixed').disabled = true;
        document.getElementById('btnConfirmMixed').classList.add('opacity-50', 'cursor-not-allowed');
        
        setPaymentMethod('mixto');
        openModal('mixedPaymentModal');
    }

    function validateMixedPayment() {
        const cash = parseFloat(document.getElementById('mixedPaymentCash').value) || 0;
        const transfer = parseFloat(document.getElementById('mixedPaymentTransfer').value) || 0;
        const card = parseFloat(document.getElementById('mixedPaymentCard').value) || 0;
        
        const distributed = cash + transfer + card;
        
        let subtotalSinIVA = 0;
        let totalIVA = 0;
        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            if (item.hasIVA) {
                const subtotalItem = itemTotal / 1.16;
                const ivaItem = itemTotal - subtotalItem;
                subtotalSinIVA += subtotalItem;
                totalIVA += ivaItem;
            } else {
                subtotalSinIVA += itemTotal;
            }
        });
        const total = subtotalSinIVA + totalIVA;
        
        const difference = total - distributed;
        
        document.getElementById('mixedPaymentDistributed').textContent = formatMoney(distributed);
        document.getElementById('mixedPaymentDifference').textContent = formatMoney(Math.abs(difference));
        
        const alertBox = document.getElementById('mixedPaymentAlert');
        const successBox = document.getElementById('mixedPaymentSuccess');
        const confirmBtn = document.getElementById('btnConfirmMixed');
        
        if (Math.abs(difference) < 0.01) {
            document.getElementById('mixedPaymentDiffLabel').textContent = '¬°Cuadre perfecto!';
            document.getElementById('mixedPaymentDiffLabel').className = 'text-sm font-medium text-green-600';
            document.getElementById('mixedPaymentDifference').className = 'font-bold text-green-600';
            alertBox.classList.add('hidden');
            successBox.classList.remove('hidden');
            confirmBtn.disabled = false;
            confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else if (difference > 0) {
            document.getElementById('mixedPaymentDiffLabel').textContent = 'Falta:';
            document.getElementById('mixedPaymentDiffLabel').className = 'text-sm font-medium text-orange-600';
            document.getElementById('mixedPaymentDifference').className = 'font-bold text-orange-600';
            alertBox.textContent = `Faltan ${formatMoney(difference)}`;
            alertBox.classList.remove('hidden');
            successBox.classList.add('hidden');
            confirmBtn.disabled = true;
            confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
            document.getElementById('mixedPaymentDiffLabel').textContent = 'Excedente:';
            document.getElementById('mixedPaymentDiffLabel').className = 'text-sm font-medium text-red-600';
            document.getElementById('mixedPaymentDifference').className = 'font-bold text-red-600';
            alertBox.textContent = `Excedente de ${formatMoney(Math.abs(difference))}`;
            alertBox.classList.remove('hidden');
            successBox.classList.add('hidden');
            confirmBtn.disabled = true;
            confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

    function autoDistribute(type) {
        let subtotalSinIVA = 0;
        let totalIVA = 0;
        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            if (item.hasIVA) {
                const subtotalItem = itemTotal / 1.16;
                const ivaItem = itemTotal - subtotalItem;
                subtotalSinIVA += subtotalItem;
                totalIVA += ivaItem;
            } else {
                subtotalSinIVA += itemTotal;
            }
        });
        const total = subtotalSinIVA + totalIVA;
        
        let cash = 0, transfer = 0, card = 0;
        
        switch(type) {
            case 'half':
                cash = total / 2;
                transfer = total / 2;
                break;
            case 'thirds':
                cash = total / 3;
                transfer = total / 3;
                card = total / 3;
                break;
        }
        
        cash = Math.round(cash * 100) / 100;
        transfer = Math.round(transfer * 100) / 100;
        card = Math.round(card * 100) / 100;
        
        const sum = cash + transfer + card;
        if (sum !== total) cash += (total - sum);
        
        document.getElementById('mixedPaymentCash').value = cash.toFixed(2);
        document.getElementById('mixedPaymentTransfer').value = transfer > 0 ? transfer.toFixed(2) : '';
        document.getElementById('mixedPaymentCard').value = card > 0 ? card.toFixed(2) : '';
        
        validateMixedPayment();
    }

    function confirmMixedPayment() {
        const cash = parseFloat(document.getElementById('mixedPaymentCash').value) || 0;
        const transfer = parseFloat(document.getElementById('mixedPaymentTransfer').value) || 0;
        const card = parseFloat(document.getElementById('mixedPaymentCard').value) || 0;
        
        mixedPaymentData = { efectivo: cash, transferencia: transfer, tarjeta: card };
        isMixedPayment = true;
        
        document.getElementById('mixedPaymentSummary').classList.remove('hidden');
        document.getElementById('mixedCash').textContent = formatMoney(cash);
        document.getElementById('mixedTransfer').textContent = formatMoney(transfer);
        document.getElementById('mixedCard').textContent = formatMoney(card);
        document.getElementById('mixedTotal').textContent = formatMoney(cash + transfer + card);
        
        closeModal('mixedPaymentModal');
    }

    // ============================================
    // PROCESAR VENTA
    // ============================================

    async function processSale() {
        if (cart.length === 0) {
            alert('El carrito est√° vac√≠o');
            return;
        }
        
        if (isMixedPayment) {
            const totalMixed = mixedPaymentData.efectivo + mixedPaymentData.transferencia + mixedPaymentData.tarjeta;
            
            let subtotalSinIVA = 0;
            let iva = 0;
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                if (item.hasIVA) {
                    const subtotalItem = itemTotal / 1.16;
                    const ivaItem = itemTotal - subtotalItem;
                    subtotalSinIVA += subtotalItem;
                    iva += ivaItem;
                } else {
                    subtotalSinIVA += itemTotal;
                }
            });
            
            const total = subtotalSinIVA + iva;
            
            if (Math.abs(totalMixed - total) > 0.01) {
                alert('Los montos del pago mixto no coinciden con el total');
                return;
            }
        }
        
        let subtotalSinIVA = 0;
        let iva = 0;
        let totalIVA0 = 0;
        let totalIVA16 = 0;
        
        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            if (item.hasIVA) {
                const subtotalItem = itemTotal / 1.16;
                const ivaItem = itemTotal - subtotalItem;
                subtotalSinIVA += subtotalItem;
                iva += ivaItem;
                totalIVA16 += itemTotal;
            } else {
                subtotalSinIVA += itemTotal;
                totalIVA0 += itemTotal;
            }
        });
        
        const total = subtotalSinIVA + iva;
        
        const sale = {
            user_id: currentUser.id,
            cashier_name: currentProfile.full_name || currentProfile.username,
            items: cart.map(i => ({
                id: i.id,
                name: i.name,
                price: i.price,
                quantity: i.quantity,
                hasIVA: i.hasIVA
            })),
            subtotal: subtotalSinIVA,
            iva: iva,
            total: total,
            total_iva_0: totalIVA0,
            total_iva_16: totalIVA16,
            payment_method: isMixedPayment ? 'mixto' : currentPaymentMethod,
            payment_details: isMixedPayment ? mixedPaymentData : null,
            cancelled: false
        };
        
        try {
            const { error } = await supabaseClient.from('sales').insert([sale]);
            if (error) throw error;
            
            for (const item of cart) {
                if (!item.isCustom) {
                    const product = products.find(p => p.id === item.id);
                    if (product) {
                        await supabaseClient
                            .from('products')
                            .update({ stock: product.stock - item.quantity })
                            .eq('id', item.id);
                    }
                }
            }
            
            cart = [];
            isMixedPayment = false;
            mixedPaymentData = { efectivo: 0, transferencia: 0, tarjeta: 0 };
            updateCart();
            document.getElementById('mixedPaymentSummary').classList.add('hidden');
            
            alert('¬°Venta realizada con √©xito!');
            await loadProducts();
            
        } catch (error) {
            alert('Error al procesar la venta: ' + error.message);
        }
    }

    // ============================================
    // HISTORIAL DE VENTAS
    // ============================================

    async function loadTodaySales() {
        try {
            const today = new Date().toISOString().split('T')[0];
            
            const { data: todaySales } = await supabaseClient
                .from('sales')
                .select('*')
                .gte('created_at', today)
                .eq('cancelled', false)
                .order('created_at', { ascending: false });

            const { data: todayCancelled } = await supabaseClient
                .from('sales')
                .select('*')
                .gte('created_at', today)
                .eq('cancelled', true);

            const total = todaySales?.reduce((sum, s) => sum + s.total, 0) || 0;
            const grossTotal = total + (todayCancelled?.reduce((sum, s) => sum + s.total, 0) || 0);
            const iva = todaySales?.reduce((sum, s) => sum + s.iva, 0) || 0;
            
            let cash = 0, transfer = 0, card = 0;
            todaySales?.forEach(s => {
                if (s.payment_method === 'mixto' && s.payment_details) {
                    cash += s.payment_details.efectivo || 0;
                    transfer += s.payment_details.transferencia || 0;
                    card += s.payment_details.tarjeta || 0;
                } else {
                    if (s.payment_method === 'efectivo') cash += s.total;
                    if (s.payment_method === 'transferencia') transfer += s.total;
                    if (s.payment_method === 'tarjeta') card += s.total;
                }
            });
            
            document.getElementById('historyTotalSales').textContent = formatMoney(total);
            document.getElementById('historyIVA').textContent = formatMoney(iva);
            document.getElementById('historyCount').textContent = todaySales?.length || 0;
            document.getElementById('historyShouldHave').textContent = formatMoney(total);
            document.getElementById('cashTotal').textContent = 'E: ' + formatMoney(cash);
            document.getElementById('transferTotal').textContent = 'T: ' + formatMoney(transfer);
            document.getElementById('cardTotal').textContent = 'C: ' + formatMoney(card);
            
            const cancelledSection = document.getElementById('historyCancelledSection');
            if (todayCancelled?.length > 0) {
                cancelledSection.classList.remove('hidden');
                document.getElementById('historyCancelledAmount').textContent = formatMoney(todayCancelled.reduce((sum, s) => sum + s.total, 0));
                document.getElementById('historyCancelledCount').textContent = todayCancelled.length;
                document.getElementById('historyGrossSales').textContent = formatMoney(grossTotal);
            } else {
                cancelledSection.classList.add('hidden');
            }
            
            renderSalesTable(todaySales || []);
            
        } catch (error) {
            console.error('Error loading sales:', error);
        }
    }

    function getSaleIVAType(sale) {
        const hasIVA0 = (sale.total_iva_0 || 0) > 0;
        const hasIVA16 = (sale.total_iva_16 || 0) > 0;
        
        if (hasIVA0 && hasIVA16) {
            return { type: 'MIXTA', class: 'iva-badge-mix', icon: 'fa-layer-group' };
        } else if (hasIVA16) {
            return { type: '16%', class: 'iva-badge-16', icon: 'fa-percentage' };
        } else {
            return { type: '0%', class: 'iva-badge-0', icon: 'fa-circle' };
        }
    }

    function renderSalesTable(salesList) {
        const tbody = document.getElementById('salesTableBody');
        tbody.innerHTML = '';
        
        salesList.forEach(sale => {
            const ivaType = getSaleIVAType(sale);
            
            let paymentDisplay = '';
            if (sale.payment_method === 'mixto' && sale.payment_details) {
                const parts = [];
                if (sale.payment_details.efectivo > 0) parts.push(`Ef: ${formatMoney(sale.payment_details.efectivo)}`);
                if (sale.payment_details.transferencia > 0) parts.push(`Tr: ${formatMoney(sale.payment_details.transferencia)}`);
                if (sale.payment_details.tarjeta > 0) parts.push(`Ta: ${formatMoney(sale.payment_details.tarjeta)}`);
                paymentDisplay = `<span class="px-2 py-1 rounded-full text-xs bg-purple-100 text-purple-700" title="${parts.join(' | ')}">Mixto</span>`;
            } else {
                paymentDisplay = `<span class="px-2 py-1 rounded-full text-xs ${getPaymentMethodColor(sale.payment_method)}">${sale.payment_method}</span>`;
            }
            
            const mainRow = document.createElement('tr');
            mainRow.className = `sale-row hover:bg-gray-50 transition-colors ${sale.cancelled ? 'bg-red-50' : ''}`;
            mainRow.onclick = () => toggleSaleDetails(sale.id);
            mainRow.innerHTML = `
                <td class="px-4 py-3 font-medium ${sale.cancelled ? 'text-red-600 line-through' : 'text-brand-700'}">
                    ${sale.id.slice(0, 8)}...
                    ${ivaType.type === 'MIXTA' ? '<i class="fas fa-chevron-down text-xs ml-1 text-gray-400"></i>' : ''}
                </td>
                <td class="px-4 py-3 text-gray-600">${new Date(sale.created_at).toLocaleString()}</td>
                <td class="px-4 py-3 text-sm">${sale.cashier_name || 'N/A'}</td>
                <td class="px-4 py-3 text-sm">${sale.items.length} productos</td>
                <td class="px-4 py-3 text-center">
                    <span class="px-2 py-1 rounded-full text-xs font-bold ${ivaType.class}">
                        <i class="fas ${ivaType.icon} mr-1"></i>${ivaType.type}
                    </span>
                </td>
                <td class="px-4 py-3">${paymentDisplay}</td>
                <td class="px-4 py-3 text-right font-bold ${sale.cancelled ? 'text-red-600 line-through' : ''}">${formatMoney(sale.total)}</td>
                <td class="px-4 py-3 text-center">
                    ${sale.cancelled ? 
                        '<span class="px-2 py-1 rounded-full text-xs bg-red-100 text-red-700">Cancelada</span>' : 
                        '<span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-700">Activa</span>'
                    }
                </td>
                <td class="px-4 py-3 text-center">
                    ${!sale.cancelled && currentProfile?.role === 'admin' ? `
                        <button onclick="event.stopPropagation(); cancelSale('${sale.id}')" class="text-red-500 hover:text-red-700 text-xs bg-red-50 px-2 py-1 rounded transition-colors">
                            <i class="fas fa-times mr-1"></i>Cancelar
                        </button>
                    ` : '<span class="text-xs text-gray-400">-</span>'}
                </td>
            `;
            tbody.appendChild(mainRow);
            
            if (ivaType.type === 'MIXTA') {
                const detailRow = document.createElement('tr');
                detailRow.id = `sale-detail-${sale.id}`;
                detailRow.className = 'sale-details';
                detailRow.innerHTML = `
                    <td colspan="9" class="px-4 py-3">
                        <div class="bg-purple-50 rounded-lg p-3 ml-4">
                            <p class="text-xs font-bold text-purple-800 mb-2">Desglose por tipo de IVA:</p>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div class="flex justify-between items-center p-2 bg-white rounded">
                                    <span class="text-gray-600"><i class="fas fa-circle text-pink-500 mr-2"></i>IVA 0%:</span>
                                    <span class="font-bold text-pink-700">${formatMoney(sale.total_iva_0 || 0)}</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-white rounded">
                                    <span class="text-gray-600"><i class="fas fa-percentage text-blue-500 mr-2"></i>IVA 16%:</span>
                                    <span class="font-bold text-blue-700">${formatMoney(sale.total_iva_16 || 0)}</span>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-gray-500">
                                <p>Subtotal IVA 0%: ${formatMoney(sale.total_iva_0 || 0)}</p>
                                <p>Subtotal IVA 16%: ${formatMoney((sale.total_iva_16 || 0) / 1.16)} | IVA: ${formatMoney((sale.total_iva_16 || 0) - ((sale.total_iva_16 || 0) / 1.16))}</p>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(detailRow);
            }
        });
    }

    function toggleSaleDetails(saleId) {
        const detailRow = document.getElementById(`sale-detail-${saleId}`);
        if (detailRow) {
            detailRow.classList.toggle('active');
            const icon = detailRow.previousElementSibling.querySelector('.fa-chevron-down');
            if (icon) {
                icon.classList.toggle('fa-chevron-up');
                icon.classList.toggle('fa-chevron-down');
            }
        }
    }

    function getPaymentMethodColor(method) {
        const colors = {
            'efectivo': 'bg-green-100 text-green-700',
            'transferencia': 'bg-blue-100 text-blue-700',
            'tarjeta': 'bg-purple-100 text-purple-700'
        };
        return colors[method] || 'bg-gray-100 text-gray-700';
    }

    async function cancelSale(saleId) {
        if (!confirm('¬øCancelar esta venta? Se restaurar√° el stock.')) return;
        
        try {
            const { data: sale } = await supabaseClient
                .from('sales')
                .select('*')
                .eq('id', saleId)
                .single();

            if (!sale) return;

            for (const item of sale.items) {
                if (!item.isCustom) {
                    const { data: product } = await supabaseClient
                        .from('products')
                        .select('stock')
                        .eq('id', item.id)
                        .single();
                    
                    if (product) {
                        await supabaseClient
                            .from('products')
                            .update({ stock: product.stock + item.quantity })
                            .eq('id', item.id);
                    }
                }
            }

            await supabaseClient
                .from('sales')
                .update({ 
                    cancelled: true, 
                    cancelled_at: new Date().toISOString(),
                    cancelled_by: currentProfile.full_name 
                })
                .eq('id', saleId);

            await loadTodaySales();
            await updateDashboard();
            alert('Venta cancelada correctamente');
            
        } catch (error) {
            alert('Error al cancelar: ' + error.message);
        }
    }

    async function filterSales() {
        const from = document.getElementById('filterDateFrom').value;
        const to = document.getElementById('filterDateTo').value;
        
        if (!from || !to) return;
        
        try {
            const { data } = await supabaseClient
                .from('sales')
                .select('*')
                .gte('created_at', from)
                .lte('created_at', to + 'T23:59:59')
                .order('created_at', { ascending: false });
            
            renderSalesTable(data || []);
        } catch (error) {
            console.error('Error filtering sales:', error);
        }
    }

    function generateDailyCut() {
        loadTodaySales();
        const today = new Date();
        document.getElementById('cutDate').textContent = today.toLocaleDateString('es-MX', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
        
        const todayStr = new Date().toISOString().split('T')[0];
        supabaseClient
            .from('sales')
            .select('*')
            .gte('created_at', todayStr)
            .eq('cancelled', false)
            .then(({ data: todaySales }) => {
                const total = todaySales?.reduce((sum, s) => sum + s.total, 0) || 0;
                const iva = todaySales?.reduce((sum, s) => sum + s.iva, 0) || 0;
                
                let cash = 0, transfer = 0, card = 0;
                todaySales?.forEach(s => {
                    if (s.payment_method === 'mixto' && s.payment_details) {
                        cash += s.payment_details.efectivo || 0;
                        transfer += s.payment_details.transferencia || 0;
                        card += s.payment_details.tarjeta || 0;
                    } else {
                        if (s.payment_method === 'efectivo') cash += s.total;
                        if (s.payment_method === 'transferencia') transfer += s.total;
                        if (s.payment_method === 'tarjeta') card += s.total;
                    }
                });
                
                document.getElementById('cutTotal').textContent = formatMoney(total);
                document.getElementById('cutCash').textContent = formatMoney(cash);
                document.getElementById('cutTransfer').textContent = formatMoney(transfer);
                document.getElementById('cutCard').textContent = formatMoney(card);
                document.getElementById('cutIVA').textContent = formatMoney(iva);
                document.getElementById('cutTransactions').textContent = todaySales?.length || 0;
                
                return supabaseClient
                    .from('sales')
                    .select('*')
                    .gte('created_at', todayStr)
                    .eq('cancelled', true);
            })
            .then(({ data: cancelledSales }) => {
                if (cancelledSales?.length > 0) {
                    document.getElementById('cutCancelledSection').classList.remove('hidden');
                    document.getElementById('cutCancelledAmount').textContent = formatMoney(cancelledSales.reduce((sum, s) => sum + s.total, 0));
                } else {
                    document.getElementById('cutCancelledSection').classList.add('hidden');
                }
            });
        
        openModal('cutModal');
    }

    // ============================================
    // GASTOS - COMPLETAMENTE REESTRUCTURADO CON ITEMS
    // ============================================

    function openExpenseModal() {
        expenseItems = [];
        currentEditingExpenseId = null;
        document.getElementById('expenseModalTitle').textContent = 'Registrar Gasto';
        document.getElementById('expenseArea').value = 'produccion';
        document.getElementById('expenseProvider').value = '';
        document.getElementById('expenseMethod').value = 'efectivo';
        document.getElementById('expenseIVAIncluded').checked = false;
        
        toggleExpenseIVAMode();
        addExpenseItem(); // Agregar primer item vac√≠o
        updateExpenseTotals();
        
        openModal('expenseModal');
    }

    function toggleExpenseIVAMode() {
        const ivaIncluded = document.getElementById('expenseIVAIncluded').checked;
        const modeText = document.getElementById('expenseIVAModeText');
        
        if (ivaIncluded) {
            modeText.textContent = 'Modo: El total YA incluye IVA (16%)';
            modeText.className = 'text-xs text-green-600 font-bold';
        } else {
            modeText.textContent = 'Modo: IVA se suma al subtotal';
            modeText.className = 'text-xs text-blue-600';
        }
        
        updateExpenseTotals();
    }

    function addExpenseItem() {
        const itemId = Date.now() + Math.random();
        expenseItems.push({
            id: itemId,
            concept: '',
            quantity: 1,
            unit_price: 0,
            has_iva: false
        });
        renderExpenseItems();
    }

    function removeExpenseItem(itemId) {
        if (expenseItems.length <= 1) {
            alert('Debe tener al menos un concepto');
            return;
        }
        expenseItems = expenseItems.filter(item => item.id !== itemId);
        renderExpenseItems();
        updateExpenseTotals();
    }

    function updateExpenseItem(itemId, field, value) {
        const item = expenseItems.find(i => i.id === itemId);
        if (!item) return;
        
        if (field === 'quantity') {
            item.quantity = parseInt(value) || 1;
        } else if (field === 'unit_price') {
            item.unit_price = parseFloat(value) || 0;
        } else if (field === 'concept') {
            item.concept = value;
        } else if (field === 'has_iva') {
            item.has_iva = value;
        }
        
        updateExpenseTotals();
    }

    function renderExpenseItems() {
        const container = document.getElementById('expenseItemsContainer');
        const ivaIncluded = document.getElementById('expenseIVAIncluded').checked;
        
        container.innerHTML = expenseItems.map((item, index) => `
            <div class="expense-item-row bg-white p-3 rounded-lg border border-gray-200 flex flex-wrap gap-2 items-center">
                <div class="flex-1 min-w-[200px]">
                    <input type="text" 
                           placeholder="Concepto del item" 
                           value="${item.concept}"
                           onchange="updateExpenseItem(${item.id}, 'concept', this.value)"
                           class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
                <div class="w-20">
                    <input type="number" 
                           placeholder="Cant" 
                           value="${item.quantity}"
                           min="1"
                           onchange="updateExpenseItem(${item.id}, 'quantity', this.value)"
                           class="w-full border border-gray-300 rounded px-2 py-2 text-sm text-center focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
                <div class="w-28">
                    <div class="relative">
                        <span class="absolute left-2 top-2 text-gray-500 text-sm">$</span>
                        <input type="number" 
                               placeholder="Precio" 
                               value="${item.unit_price || ''}"
                               step="0.01"
                               onchange="updateExpenseItem(${item.id}, 'unit_price', this.value)"
                               class="w-full border border-gray-300 rounded pl-6 pr-2 py-2 text-sm text-right focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                </div>
                <button onclick="updateExpenseItem(${item.id}, 'has_iva', !${item.has_iva}); renderExpenseItems()" 
                        class="expense-item-iva-toggle px-3 py-2 rounded border-2 ${item.has_iva ? 'active border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-300 text-gray-500'} text-xs font-medium transition-all"
                        title="${ivaIncluded ? 'IVA ya incluido en el total' : 'Sumar IVA al subtotal'}">
                    <i class="fas fa-percentage mr-1"></i>IVA
                </button>
                <button onclick="removeExpenseItem(${item.id})" class="text-red-500 hover:text-red-700 px-2 py-2" title="Eliminar item">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `).join('');
    }

    function updateExpenseTotals() {
        const ivaIncluded = document.getElementById('expenseIVAIncluded').checked;
        
        let subtotal = 0;
        let iva = 0;
        
        expenseItems.forEach(item => {
            const itemTotal = (item.quantity || 0) * (item.unit_price || 0);
            
            if (ivaIncluded) {
                // Si el total ya incluye IVA, desglosamos
                if (item.has_iva) {
                    const itemSubtotal = itemTotal / 1.16;
                    const itemIVA = itemTotal - itemSubtotal;
                    subtotal += itemSubtotal;
                    iva += itemIVA;
                } else {
                    subtotal += itemTotal;
                }
            } else {
                // Si no incluye IVA, sumamos normal y agregamos IVA si aplica
                subtotal += itemTotal;
                if (item.has_iva) {
                    iva += itemTotal * 0.16;
                }
            }
        });
        
        const grandTotal = subtotal + iva;
        
        document.getElementById('expenseSubtotal').textContent = formatMoney(subtotal);
        document.getElementById('expenseIVATotal').textContent = formatMoney(iva);
        document.getElementById('expenseItemsCount').textContent = expenseItems.length;
        document.getElementById('expenseGrandTotal').textContent = formatMoney(grandTotal);
    }

    async function saveExpense() {
        const area = document.getElementById('expenseArea').value;
        const provider = document.getElementById('expenseProvider').value;
        const method = document.getElementById('expenseMethod').value;
        const ivaIncluded = document.getElementById('expenseIVAIncluded').checked;
        
        // Validar items
        const validItems = expenseItems.filter(item => item.concept.trim() !== '' && item.unit_price > 0);
        if (validItems.length === 0) {
            alert('Debe agregar al menos un concepto v√°lido');
            return;
        }
        
        // Calcular totales
        let subtotal = 0;
        let iva = 0;
        
        validItems.forEach(item => {
            const itemTotal = item.quantity * item.unit_price;
            
            if (ivaIncluded) {
                if (item.has_iva) {
                    const itemSubtotal = itemTotal / 1.16;
                    const itemIVA = itemTotal - itemSubtotal;
                    item.calculated_subtotal = itemSubtotal;
                    item.calculated_iva = itemIVA;
                    subtotal += itemSubtotal;
                    iva += itemIVA;
                } else {
                    item.calculated_subtotal = itemTotal;
                    item.calculated_iva = 0;
                    subtotal += itemTotal;
                }
            } else {
                item.calculated_subtotal = itemTotal;
                if (item.has_iva) {
                    const itemIVA = itemTotal * 0.16;
                    item.calculated_iva = itemIVA;
                    iva += itemIVA;
                } else {
                    item.calculated_iva = 0;
                }
                subtotal += itemTotal;
            }
        });
        
        const total = subtotal + iva;
        
        try {
            // Insertar gasto principal
            const { data: expenseData, error: expenseError } = await supabaseClient
                .from('expenses')
                .insert([{
                    user_id: currentUser.id,
                    registered_by: currentProfile.full_name,
                    area,
                    concept: provider || 'Gasto varios',
                    provider: provider,
                    amount: total,
                    subtotal: subtotal,
                    iva_amount: iva,
                    method,
                    has_iva: iva > 0,
                    iva_included: ivaIncluded,
                    items_count: validItems.length
                }])
                .select()
                .single();

            if (expenseError) throw expenseError;

            // Insertar items del gasto
            const itemsToInsert = validItems.map(item => ({
                expense_id: expenseData.id,
                concept: item.concept,
                quantity: item.quantity,
                unit_price: item.unit_price,
                has_iva: item.has_iva,
                subtotal: item.calculated_subtotal,
                iva_amount: item.calculated_iva,
                total: item.calculated_subtotal + item.calculated_iva
            }));

            const { error: itemsError } = await supabaseClient
                .from('expense_items')
                .insert(itemsToInsert);

            if (itemsError) throw itemsError;

            closeModal('expenseModal');
            await loadExpenses();
            await updateDashboard();
            
            alert('Gasto registrado correctamente');
            
        } catch (error) {
            console.error('Error saving expense:', error);
            alert('Error al guardar gasto: ' + error.message);
        }
    }

    // Funciones para editar gasto
    async function editExpense(expenseId) {
        try {
            const { data: expense, error } = await supabaseClient
                .from('expenses')
                .select('*, expense_items(*)')
                .eq('id', expenseId)
                .single();

            if (error) throw error;

            currentEditingExpenseId = expenseId;
            
            // Cargar datos en el modal de edici√≥n
            document.getElementById('editExpenseId').value = expenseId;
            document.getElementById('editExpenseArea').value = expense.area;
            document.getElementById('editExpenseProvider').value = expense.provider || expense.concept;
            document.getElementById('editExpenseMethod').value = expense.method;
            document.getElementById('editExpenseIVAIncluded').checked = expense.iva_included || false;
            
            // Cargar items
            editExpenseItems = (expense.expense_items || []).map(item => ({
                id: item.id,
                concept: item.concept,
                quantity: item.quantity,
                unit_price: item.unit_price,
                has_iva: item.has_iva
            }));
            
            toggleEditExpenseIVAMode();
            renderEditExpenseItems();
            updateEditExpenseTotals();
            
            openModal('editExpenseModal');
            
        } catch (error) {
            console.error('Error loading expense for edit:', error);
            alert('Error al cargar el gasto: ' + error.message);
        }
    }

    function toggleEditExpenseIVAMode() {
        const ivaIncluded = document.getElementById('editExpenseIVAIncluded').checked;
        const modeText = document.getElementById('editExpenseIVAModeText');
        
        if (ivaIncluded) {
            modeText.textContent = 'Modo: El total YA incluye IVA (16%)';
            modeText.className = 'text-xs text-green-600 font-bold';
        } else {
            modeText.textContent = 'Modo: IVA se suma al subtotal';
            modeText.className = 'text-xs text-blue-600';
        }
        
        updateEditExpenseTotals();
    }

    function addEditExpenseItem() {
        const itemId = 'new_' + Date.now();
        editExpenseItems.push({
            id: itemId,
            concept: '',
            quantity: 1,
            unit_price: 0,
            has_iva: false,
            isNew: true
        });
        renderEditExpenseItems();
    }

    function removeEditExpenseItem(itemId) {
        if (editExpenseItems.length <= 1) {
            alert('Debe tener al menos un concepto');
            return;
        }
        editExpenseItems = editExpenseItems.filter(item => item.id !== itemId);
        renderEditExpenseItems();
        updateEditExpenseTotals();
    }

    function updateEditExpenseItem(itemId, field, value) {
        const item = editExpenseItems.find(i => i.id === itemId);
        if (!item) return;
        
        if (field === 'quantity') {
            item.quantity = parseInt(value) || 1;
        } else if (field === 'unit_price') {
            item.unit_price = parseFloat(value) || 0;
        } else if (field === 'concept') {
            item.concept = value;
        } else if (field === 'has_iva') {
            item.has_iva = value;
        }
        
        updateEditExpenseTotals();
    }

    function renderEditExpenseItems() {
        const container = document.getElementById('editExpenseItemsContainer');
        const ivaIncluded = document.getElementById('editExpenseIVAIncluded').checked;
        
        container.innerHTML = editExpenseItems.map((item, index) => `
            <div class="expense-item-row bg-white p-3 rounded-lg border border-gray-200 flex flex-wrap gap-2 items-center">
                <div class="flex-1 min-w-[200px]">
                    <input type="text" 
                           placeholder="Concepto del item" 
                           value="${item.concept}"
                           onchange="updateEditExpenseItem('${item.id}', 'concept', this.value)"
                           class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
                <div class="w-20">
                    <input type="number" 
                           placeholder="Cant" 
                           value="${item.quantity}"
                           min="1"
                           onchange="updateEditExpenseItem('${item.id}', 'quantity', this.value)"
                           class="w-full border border-gray-300 rounded px-2 py-2 text-sm text-center focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
                <div class="w-28">
                    <div class="relative">
                        <span class="absolute left-2 top-2 text-gray-500 text-sm">$</span>
                        <input type="number" 
                               placeholder="Precio" 
                               value="${item.unit_price || ''}"
                               step="0.01"
                               onchange="updateEditExpenseItem('${item.id}', 'unit_price', this.value)"
                               class="w-full border border-gray-300 rounded pl-6 pr-2 py-2 text-sm text-right focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                </div>
                <button onclick="updateEditExpenseItem('${item.id}', 'has_iva', !${item.has_iva}); renderEditExpenseItems()" 
                        class="expense-item-iva-toggle px-3 py-2 rounded border-2 ${item.has_iva ? 'active border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-300 text-gray-500'} text-xs font-medium transition-all"
                        title="${ivaIncluded ? 'IVA ya incluido en el total' : 'Sumar IVA al subtotal'}">
                    <i class="fas fa-percentage mr-1"></i>IVA
                </button>
                <button onclick="removeEditExpenseItem('${item.id}')" class="text-red-500 hover:text-red-700 px-2 py-2" title="Eliminar item">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `).join('');
    }

    function updateEditExpenseTotals() {
        const ivaIncluded = document.getElementById('editExpenseIVAIncluded').checked;
        
        let subtotal = 0;
        let iva = 0;
        
        editExpenseItems.forEach(item => {
            const itemTotal = (item.quantity || 0) * (item.unit_price || 0);
            
            if (ivaIncluded) {
                if (item.has_iva) {
                    const itemSubtotal = itemTotal / 1.16;
                    const itemIVA = itemTotal - itemSubtotal;
                    item.calculated_subtotal = itemSubtotal;
                    item.calculated_iva = itemIVA;
                    subtotal += itemSubtotal;
                    iva += itemIVA;
                } else {
                    item.calculated_subtotal = itemTotal;
                    item.calculated_iva = 0;
                    subtotal += itemTotal;
                }
            } else {
                item.calculated_subtotal = itemTotal;
                if (item.has_iva) {
                    const itemIVA = itemTotal * 0.16;
                    item.calculated_iva = itemIVA;
                    iva += itemIVA;
                } else {
                    item.calculated_iva = 0;
                }
                subtotal += itemTotal;
            }
        });
        
        const grandTotal = subtotal + iva;
        
        document.getElementById('editExpenseSubtotal').textContent = formatMoney(subtotal);
        document.getElementById('editExpenseIVATotal').textContent = formatMoney(iva);
        document.getElementById('editExpenseItemsCount').textContent = editExpenseItems.length;
        document.getElementById('editExpenseGrandTotal').textContent = formatMoney(grandTotal);
    }

    async function updateExpense() {
        const expenseId = document.getElementById('editExpenseId').value;
        const area = document.getElementById('editExpenseArea').value;
        const provider = document.getElementById('editExpenseProvider').value;
        const method = document.getElementById('editExpenseMethod').value;
        const ivaIncluded = document.getElementById('editExpenseIVAIncluded').checked;
        
        const validItems = editExpenseItems.filter(item => item.concept.trim() !== '' && item.unit_price > 0);
        if (validItems.length === 0) {
            alert('Debe agregar al menos un concepto v√°lido');
            return;
        }
        
        let subtotal = 0;
        let iva = 0;
        
        validItems.forEach(item => {
            const itemTotal = item.quantity * item.unit_price;
            
            if (ivaIncluded) {
                if (item.has_iva) {
                    const itemSubtotal = itemTotal / 1.16;
                    const itemIVA = itemTotal - itemSubtotal;
                    item.calculated_subtotal = itemSubtotal;
                    item.calculated_iva = itemIVA;
                    subtotal += itemSubtotal;
                    iva += itemIVA;
                } else {
                    item.calculated_subtotal = itemTotal;
                    item.calculated_iva = 0;
                    subtotal += itemTotal;
                }
            } else {
                item.calculated_subtotal = itemTotal;
                if (item.has_iva) {
                    const itemIVA = itemTotal * 0.16;
                    item.calculated_iva = itemIVA;
                    iva += itemIVA;
                } else {
                    item.calculated_iva = 0;
                }
                subtotal += itemTotal;
            }
        });
        
        const total = subtotal + iva;
        
        try {
            // Actualizar gasto principal
            const { error: expenseError } = await supabaseClient
                .from('expenses')
                .update({
                    area,
                    concept: provider || 'Gasto varios',
                    provider: provider,
                    amount: total,
                    subtotal: subtotal,
                    iva_amount: iva,
                    method,
                    has_iva: iva > 0,
                    iva_included: ivaIncluded,
                    items_count: validItems.length,
                    updated_at: new Date().toISOString()
                })
                .eq('id', expenseId);

            if (expenseError) throw expenseError;

            // Eliminar items antiguos
            await supabaseClient
                .from('expense_items')
                .delete()
                .eq('expense_id', expenseId);

            // Insertar nuevos items
            const itemsToInsert = validItems.map(item => ({
                expense_id: expenseId,
                concept: item.concept,
                quantity: item.quantity,
                unit_price: item.unit_price,
                has_iva: item.has_iva,
                subtotal: item.calculated_subtotal,
                iva_amount: item.calculated_iva,
                total: item.calculated_subtotal + item.calculated_iva
            }));

            const { error: itemsError } = await supabaseClient
                .from('expense_items')
                .insert(itemsToInsert);

            if (itemsError) throw itemsError;

            closeModal('editExpenseModal');
            await loadExpenses();
            await updateDashboard();
            
            alert('Gasto actualizado correctamente');
            
        } catch (error) {
            console.error('Error updating expense:', error);
            alert('Error al actualizar gasto: ' + error.message);
        }
    }

    async function loadExpenses() {
        try {
            const filter = document.getElementById('expenseFilterArea').value;
            
            let query = supabaseClient
                .from('expenses')
                .select('*, expense_items(*)')
                .order('created_at', { ascending: false });
            
            if (currentProfile?.role === 'cashier') {
                query = query.eq('user_id', currentUser.id);
            } else if (filter !== 'all') {
                query = query.eq('area', filter);
            }
            
            const { data, error } = await query;
            if (error) throw error;
            
            if (currentProfile?.role === 'admin') {
                const { data: allExpenses } = await supabaseClient.from('expenses').select('area, amount');
                
                const stats = {
                    produccion: allExpenses?.filter(e => e.area === 'produccion').reduce((sum, e) => sum + e.amount, 0) || 0,
                    atencion: allExpenses?.filter(e => e.area === 'atencion').reduce((sum, e) => sum + e.amount, 0) || 0,
                    administrativo: allExpenses?.filter(e => e.area === 'administrativo').reduce((sum, e) => sum + e.amount, 0) || 0,
                    otros: allExpenses?.filter(e => e.area === 'otros').reduce((sum, e) => sum + e.amount, 0) || 0
                };
                
                document.getElementById('expenseProduction').textContent = formatMoney(stats.produccion);
                document.getElementById('expenseCustomerService').textContent = formatMoney(stats.atencion);
                document.getElementById('expenseAdmin').textContent = formatMoney(stats.administrativo);
                document.getElementById('expenseOthers').textContent = formatMoney(stats.otros);
            } else {
                const cashierTotal = data?.reduce((sum, e) => sum + e.amount, 0) || 0;
                document.getElementById('cashierTotalExpenses').textContent = formatMoney(cashierTotal);
            }
            
            const tbody = document.getElementById('expensesTableBody');
            tbody.innerHTML = (data || []).map(exp => {
                const itemCount = exp.expense_items?.length || exp.items_count || 0;
                const ivaBadge = exp.has_iva ? 
                    `<span class="px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-700" title="IVA: ${formatMoney(exp.iva_amount)}">
                        <i class="fas fa-check mr-1"></i>IVA ${exp.iva_included ? 'incl.' : '+16%'}
                     </span>` : 
                    '<span class="text-gray-400">-</span>';
                
                return `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-4 py-3 text-gray-600">${new Date(exp.created_at).toLocaleDateString()}</td>
                    ${currentProfile?.role === 'admin' ? `<td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs ${getAreaColor(exp.area)}">${exp.area}</span></td>` : ''}
                    <td class="px-4 py-3 font-medium">${exp.provider || exp.concept}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-700">
                            ${itemCount} item${itemCount !== 1 ? 's' : ''}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-gray-600 capitalize">${exp.method}</td>
                    <td class="px-4 py-3 text-right font-bold text-red-600">-${formatMoney(exp.amount)}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="viewExpenseDetail('${exp.id}')" class="text-blue-500 hover:text-blue-700 mr-2 btn-action" title="Ver detalle">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${exp.user_id === currentUser.id || currentProfile?.role === 'admin' ? `
                            <button onclick="editExpense('${exp.id}')" class="text-brand-500 hover:text-brand-700 mr-2 btn-action" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteExpense('${exp.id}')" class="text-red-500 hover:text-red-700 btn-action" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `}).join('');
            
        } catch (error) {
            console.error('Error loading expenses:', error);
        }
    }

    async function viewExpenseDetail(expenseId) {
        try {
            const { data: expense, error } = await supabaseClient
                .from('expenses')
                .select('*, expense_items(*)')
                .eq('id', expenseId)
                .single();

            if (error) throw error;

            const itemsHtml = (expense.expense_items || []).map((item, idx) => `
                <tr class="border-b border-gray-100">
                    <td class="py-2 text-sm">${idx + 1}</td>
                    <td class="py-2 text-sm font-medium">${item.concept}</td>
                    <td class="py-2 text-sm text-center">${item.quantity}</td>
                    <td class="py-2 text-sm text-right">${formatMoney(item.unit_price)}</td>
                    <td class="py-2 text-sm text-center">
                        ${item.has_iva ? '<i class="fas fa-check text-blue-500"></i>' : '-'}
                    </td>
                    <td class="py-2 text-sm text-right font-medium">${formatMoney(item.total)}</td>
                </tr>
            `).join('');

            const modalHtml = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="this.remove()">
                    <div class="bg-white rounded-2xl p-6 w-full max-w-2xl mx-4 shadow-2xl max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-brand-800">Detalle del Gasto</h3>
                                <p class="text-sm text-gray-500">${new Date(expense.created_at).toLocaleString()}</p>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                            <div class="bg-gray-50 p-3 rounded">
                                <span class="text-gray-600">√Årea:</span>
                                <span class="font-medium ml-2 capitalize">${expense.area}</span>
                            </div>
                            <div class="bg-gray-50 p-3 rounded">
                                <span class="text-gray-600">M√©todo:</span>
                                <span class="font-medium ml-2 capitalize">${expense.method}</span>
                            </div>
                            <div class="bg-gray-50 p-3 rounded">
                                <span class="text-gray-600">Proveedor:</span>
                                <span class="font-medium ml-2">${expense.provider || expense.concept}</span>
                            </div>
                            <div class="bg-gray-50 p-3 rounded">
                                <span class="text-gray-600">Registrado por:</span>
                                <span class="font-medium ml-2">${expense.registered_by}</span>
                            </div>
                        </div>

                        <table class="w-full text-sm mb-4">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-2 py-2 text-left">#</th>
                                    <th class="px-2 py-2 text-left">Concepto</th>
                                    <th class="px-2 py-2 text-center">Cant</th>
                                    <th class="px-2 py-2 text-right">P.Unit</th>
                                    <th class="px-2 py-2 text-center">IVA</th>
                                    <th class="px-2 py-2 text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                            </tbody>
                            <tfoot class="bg-brand-50 font-bold">
                                <tr>
                                    <td colspan="5" class="px-2 py-3 text-right">Subtotal:</td>
                                    <td class="px-2 py-3 text-right">${formatMoney(expense.subtotal)}</td>
                                </tr>
                                ${expense.iva_amount > 0 ? `
                                <tr>
                                    <td colspan="5" class="px-2 py-2 text-right text-blue-600">IVA:</td>
                                    <td class="px-2 py-2 text-right text-blue-600">${formatMoney(expense.iva_amount)}</td>
                                </tr>
                                ` : ''}
                                <tr class="text-lg">
                                    <td colspan="5" class="px-2 py-3 text-right">TOTAL:</td>
                                    <td class="px-2 py-3 text-right text-brand-800">${formatMoney(expense.amount)}</td>
                                </tr>
                            </tfoot>
                        </table>

                        <button onclick="this.closest('.fixed').remove()" class="w-full py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
        } catch (error) {
            console.error('Error viewing expense detail:', error);
            alert('Error al cargar el detalle del gasto');
        }
    }

    async function deleteExpense(id) {
        if (!confirm('¬øEliminar este gasto?')) return;
        
        try {
            // Los items se eliminan en cascada por la foreign key
            await supabaseClient.from('expenses').delete().eq('id', id);
            await loadExpenses();
            await updateDashboard();
        } catch (error) {
            alert('Error al eliminar: ' + error.message);
        }
    }

    function getAreaColor(area) {
        const colors = {
            'produccion': 'bg-orange-100 text-orange-700',
            'atencion': 'bg-blue-100 text-blue-700',
            'administrativo': 'bg-yellow-100 text-yellow-700',
            'otros': 'bg-purple-100 text-purple-700'
        };
        return colors[area] || 'bg-gray-100 text-gray-700';
    }

    // ============================================
    // PRODUCTOS
    // ============================================

    async function loadProductsTable() {
        try {
            const { data, error } = await supabaseClient
                .from('products')
                .select('*')
                .order('name');
            
            if (error) throw error;
            products = data || [];
            
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = products.map(p => {
                const isAdmin = currentProfile?.role === 'admin';
                
                const editButton = isAdmin ? `
                    <button onclick="editProduct('${p.id}')" class="text-blue-500 hover:text-blue-700 mr-3 btn-action" title="Editar producto">
                        <i class="fas fa-edit"></i>
                    </button>
                ` : '';
                
                const stockButton = !isAdmin ? `
                    <button onclick="openStockModal('${p.id}')" class="text-green-500 hover:text-green-700 mr-3 btn-action" title="Ajustar stock">
                        <i class="fas fa-boxes"></i>
                    </button>
                ` : '';
                
                const deleteButton = isAdmin ? `
                    <button onclick="deleteProduct('${p.id}')" class="text-red-500 hover:text-red-700 btn-action" title="Eliminar producto">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : '';
                
                return `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-4 py-3 font-medium">${p.name}</td>
                    <td class="px-4 py-3 capitalize">${p.category}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="${p.stock < 5 ? 'text-red-600 font-bold' : 'text-gray-700'}">${p.stock}</span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        ${p.has_iva ? '<span class="text-blue-600 font-medium">S√≠ (16%)</span>' : '<span class="text-gray-400">No</span>'}
                    </td>
                    <td class="px-4 py-3 text-right font-bold">${formatMoney(p.price)}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded-full text-xs ${p.stock > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            ${p.stock > 0 ? 'Activo' : 'Agotado'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        ${editButton}${stockButton}${deleteButton}
                    </td>
                </tr>
            `}).join('');
            
            const btnNewProduct = document.getElementById('btnNewProduct');
            if (btnNewProduct) {
                btnNewProduct.style.display = currentProfile?.role === 'admin' ? 'inline-flex' : 'none';
            }
            
        } catch (error) {
            console.error('Error loading products table:', error);
        }
    }

    function openStockModal(productId) {
        const product = products.find(p => p.id === productId);
        if (!product) return;
        
        document.getElementById('stockProdId').value = product.id;
        document.getElementById('stockProdName').textContent = product.name;
        document.getElementById('stockProdImage').textContent = product.image || 'üì¶';
        document.getElementById('stockProdCurrent').textContent = `Stock actual: ${product.stock}`;
        document.getElementById('stockNewValue').value = product.stock;
        document.getElementById('stockPreview').textContent = product.stock;
        
        openModal('stockModal');
    }

    function adjustStockPreview(change) {
        const input = document.getElementById('stockNewValue');
        let value = parseInt(input.value) || 0;
        value += change;
        if (value < 0) value = 0;
        input.value = value;
        document.getElementById('stockPreview').textContent = value;
    }

    async function saveStockAdjustment() {
        const productId = document.getElementById('stockProdId').value;
        const newStock = parseInt(document.getElementById('stockNewValue').value) || 0;
        
        if (newStock < 0) {
            alert('El stock no puede ser negativo');
            return;
        }
        
        try {
            const { error } = await supabaseClient
                .from('products')
                .update({ stock: newStock })
                .eq('id', productId);
            
            if (error) throw error;
            
            closeModal('stockModal');
            await loadProductsTable();
            await loadProducts();
            
            alert('Stock actualizado correctamente');
            
        } catch (error) {
            alert('Error al actualizar stock: ' + error.message);
        }
    }

    function openProductModal() {
        if (currentProfile?.role !== 'admin') {
            alert('No tienes permisos para crear productos');
            return;
        }
        
        document.getElementById('productModalTitle').textContent = 'Nuevo Producto';
        document.getElementById('prodId').value = '';
        document.getElementById('prodName').value = '';
        document.getElementById('prodCategory').value = 'pasteles';
        document.getElementById('prodPrice').value = '';
        document.getElementById('prodStock').value = '0';
        document.getElementById('prodIVA').checked = false;
        openModal('productModal');
    }

    function editProduct(id) {
        if (currentProfile?.role !== 'admin') {
            alert('No tienes permisos para editar productos');
            return;
        }
        
        const product = products.find(p => p.id === id);
        if (!product) return;
        
        document.getElementById('productModalTitle').textContent = 'Editar Producto';
        document.getElementById('prodId').value = product.id;
        document.getElementById('prodName').value = product.name;
        document.getElementById('prodCategory').value = product.category;
        document.getElementById('prodPrice').value = product.price;
        document.getElementById('prodStock').value = product.stock;
        document.getElementById('prodIVA').checked = product.has_iva;
        openModal('productModal');
    }

    async function saveProduct() {
        if (currentProfile?.role !== 'admin') {
            alert('No tienes permisos para guardar productos');
            return;
        }
        
        const id = document.getElementById('prodId').value;
        const name = document.getElementById('prodName').value;
        const category = document.getElementById('prodCategory').value;
        const price = parseFloat(document.getElementById('prodPrice').value);
        const stock = parseInt(document.getElementById('prodStock').value) || 0;
        const hasIVA = document.getElementById('prodIVA').checked;
        
        if (!name || !price) {
            alert('Complete los campos obligatorios');
            return;
        }
        
        const productData = {
            name,
            category,
            price,
            stock,
            has_iva: hasIVA,
            image: category === 'pasteles' ? 'üéÇ' : 
                   category === 'postres' ? 'üßÅ' : 
                   category === 'decoracion' ? 'üé®' : 'üë®‚Äçüç≥'
        };
        
        try {
            if (id) {
                await supabaseClient.from('products').update(productData).eq('id', id);
            } else {
                await supabaseClient.from('products').insert([productData]);
            }
            
            closeModal('productModal');
            await loadProductsTable();
            await loadProducts();
            
        } catch (error) {
            alert('Error al guardar producto: ' + error.message);
        }
    }

    async function deleteProduct(id) {
        if (currentProfile?.role !== 'admin') {
            alert('No tienes permisos para eliminar productos');
            return;
        }
        
        if (!confirm('¬øEliminar este producto?')) return;
        
        try {
            await supabaseClient.from('products').update({ is_active: false }).eq('id', id);
            await loadProductsTable();
            await loadProducts();
        } catch (error) {
            alert('Error al eliminar: ' + error.message);
        }
    }

    // ============================================
    // BANCOS - AHORA INCLUYE N√ìMINA
    // ============================================

    async function updateBankModule() {
        try {
            // Ventas
            const { data: salesData } = await supabaseClient
                .from('sales')
                .select('payment_method, payment_details, total')
                .eq('cancelled', false);

            let cashIn = 0, bankIn = 0;
            
            salesData?.forEach(s => {
                if (s.payment_method === 'mixto' && s.payment_details) {
                    cashIn += s.payment_details.efectivo || 0;
                    bankIn += (s.payment_details.transferencia || 0) + (s.payment_details.tarjeta || 0);
                } else {
                    if (s.payment_method === 'efectivo') cashIn += s.total;
                    if (s.payment_method === 'transferencia' || s.payment_method === 'tarjeta') bankIn += s.total;
                }
            });
            
            // Gastos (incluye n√≥mina ahora)
            const { data: expensesData } = await supabaseClient
                .from('expenses')
                .select('method, amount');
            
            const cashOut = expensesData?.filter(e => e.method === 'efectivo').reduce((sum, e) => sum + e.amount, 0) || 0;
            const bankOut = expensesData?.filter(e => e.method === 'transferencia' || e.method === 'tarjeta').reduce((sum, e) => sum + e.amount, 0) || 0;
            
            document.getElementById('cashBalance').textContent = formatMoney(cashIn - cashOut);
            document.getElementById('bankBalance').textContent = formatMoney(bankIn - bankOut);
            
            // Desglose de movimientos
            const movementsContainer = document.getElementById('bankMovements');
            movementsContainer.innerHTML = `
                <div class="glass-panel p-4 rounded-xl">
                    <h4 class="font-bold text-green-700 mb-2"><i class="fas fa-arrow-down mr-2"></i>Ingresos Efectivo</h4>
                    <p class="text-2xl font-bold text-gray-800">${formatMoney(cashIn)}</p>
                </div>
                <div class="glass-panel p-4 rounded-xl">
                    <h4 class="font-bold text-red-700 mb-2"><i class="fas fa-arrow-up mr-2"></i>Egresos Efectivo</h4>
                    <p class="text-2xl font-bold text-gray-800">${formatMoney(cashOut)}</p>
                    <p class="text-xs text-gray-500 mt-1">Incluye gastos y n√≥mina</p>
                </div>
                <div class="glass-panel p-4 rounded-xl">
                    <h4 class="font-bold text-blue-700 mb-2"><i class="fas fa-arrow-down mr-2"></i>Ingresos Banco</h4>
                    <p class="text-2xl font-bold text-gray-800">${formatMoney(bankIn)}</p>
                </div>
                <div class="glass-panel p-4 rounded-xl">
                    <h4 class="font-bold text-orange-700 mb-2"><i class="fas fa-arrow-up mr-2"></i>Egresos Banco</h4>
                    <p class="text-2xl font-bold text-gray-800">${formatMoney(bankOut)}</p>
                    <p class="text-xs text-gray-500 mt-1">Incluye gastos y n√≥mina</p>
                </div>
            `;
            
        } catch (error) {
            console.error('Error updating bank:', error);
        }
    }

    // ============================================
    // IMPUESTOS
    // ============================================

    function setTaxPeriodThisMonth() {
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        
        document.getElementById('taxDateFrom').value = firstDay.toISOString().split('T')[0];
        document.getElementById('taxDateTo').value = lastDay.toISOString().split('T')[0];
        
        calculateTaxesByPeriod();
    }

    function setTaxPeriodLastMonth() {
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        const lastDay = new Date(now.getFullYear(), now.getMonth(), 0);
        
        document.getElementById('taxDateFrom').value = firstDay.toISOString().split('T')[0];
        document.getElementById('taxDateTo').value = lastDay.toISOString().split('T')[0];
        
        calculateTaxesByPeriod();
    }

    async function calculateTaxesByPeriod() {
        const fromDate = document.getElementById('taxDateFrom').value;
        const toDate = document.getElementById('taxDateTo').value;
        
        if (!fromDate || !toDate) return;
        
        try {
            const { data: salesData } = await supabaseClient
                .from('sales')
                .select('*')
                .gte('created_at', fromDate)
                .lte('created_at', toDate + 'T23:59:59')
                .eq('cancelled', false);

            const { data: expensesData } = await supabaseClient
                .from('expenses')
                .select('*')
                .gte('created_at', fromDate)
                .lte('created_at', toDate + 'T23:59:59');

            let totalSales = 0;
            let totalIVA0 = 0;
            let totalIVA16 = 0;
            let countIVA0 = 0;
            let countIVA16 = 0;
            let countMixed = 0;
            
            salesData?.forEach(sale => {
                const saleIVA0 = sale.total_iva_0 || 0;
                const saleIVA16 = sale.total_iva_16 || 0;
                
                totalIVA0 += saleIVA0;
                totalIVA16 += saleIVA16;
                totalSales += sale.total;
                
                if (saleIVA0 > 0 && saleIVA16 > 0) {
                    countMixed++;
                } else if (saleIVA16 > 0) {
                    countIVA16++;
                } else {
                    countIVA0++;
                }
            });
            
            const ivaFrom16 = totalIVA16 - (totalIVA16 / 1.16);
            
            document.getElementById('taxPeriodSummary').classList.remove('hidden');
            document.getElementById('taxPeriodLabel').textContent = `${new Date(fromDate).toLocaleDateString('es-MX')} - ${new Date(toDate).toLocaleDateString('es-MX')}`;
            document.getElementById('taxPeriodTotalSales').textContent = formatMoney(totalSales);
            document.getElementById('taxPeriodTransactions').textContent = salesData?.length || 0;
            document.getElementById('taxPeriodCount0').textContent = countIVA0 + countMixed;
            document.getElementById('taxPeriodCount16').textContent = countIVA16 + countMixed;
            
            document.getElementById('salesIVA0').textContent = formatMoney(totalIVA0);
            document.getElementById('transactionsIVA0').textContent = countIVA0 + countMixed;
            document.getElementById('salesIVA16').textContent = formatMoney(totalIVA16);
            document.getElementById('transactionsIVA16').textContent = countIVA16 + countMixed;
            document.getElementById('ivaIncluded16').textContent = formatMoney(ivaFrom16);
            
            const ivaInExpenses = expensesData?.filter(e => e.has_iva).reduce((sum, e) => sum + (e.iva_amount || 0), 0) || 0;
            
            document.getElementById('ivaCharged').textContent = formatMoney(ivaFrom16);
            document.getElementById('ivaExpenses').textContent = formatMoney(ivaInExpenses);
            document.getElementById('ivaToPay').textContent = formatMoney(ivaFrom16 - ivaInExpenses);
            
            const isr = totalSales * 0.025;
            document.getElementById('isrIncome').textContent = formatMoney(totalSales);
            document.getElementById('isrAmount').textContent = formatMoney(isr);
            
            const tbody = document.getElementById('taxSalesDetailTable');
            tbody.innerHTML = (salesData || []).sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).map(sale => {
                const hasIVA0 = (sale.total_iva_0 || 0) > 0;
                const hasIVA16 = (sale.total_iva_16 || 0) > 0;
                
                let ivaType, ivaClass;
                if (hasIVA0 && hasIVA16) {
                    ivaType = 'MIXTA';
                    ivaClass = 'bg-purple-100 text-purple-700';
                } else if (hasIVA16) {
                    ivaType = '16%';
                    ivaClass = 'bg-blue-100 text-blue-700';
                } else {
                    ivaType = '0%';
                    ivaClass = 'bg-pink-100 text-pink-700';
                }
                
                return `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-4 py-3 font-medium text-brand-700">${sale.id.slice(0, 8)}...</td>
                    <td class="px-4 py-3 text-gray-600">${new Date(sale.created_at).toLocaleDateString('es-MX')}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${sale.items.map(i => i.name).join(', ').substring(0, 50)}...</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded-full text-xs ${ivaClass} font-bold">${ivaType}</span>
                    </td>
                    <td class="px-4 py-3 text-right">${formatMoney(sale.subtotal)}</td>
                    <td class="px-4 py-3 text-right ${hasIVA16 ? 'text-blue-600' : 'text-gray-400'}">${formatMoney(sale.iva)}</td>
                    <td class="px-4 py-3 text-right font-bold">${formatMoney(sale.total)}</td>
                </tr>
            `}).join('');
            
        } catch (error) {
            console.error('Error calculating taxes:', error);
        }
    }

    // ============================================
    // EMPLEADOS
    // ============================================

    async function loadEmployees() {
        try {
            const { data, error } = await supabaseClient
                .from('employees')
                .select('*')
                .eq('is_active', true)
                .order('name');
            
            if (error) throw error;
            employees = data || [];
            
            const prodCount = employees.filter(e => e.area === 'produccion').length;
            const servCount = employees.filter(e => e.area === 'atencion').length;
            
            document.getElementById('countProduction').textContent = prodCount + ' empleados';
            document.getElementById('countService').textContent = servCount + ' empleados';
            
            document.getElementById('productionEmployees').innerHTML = employees
                .filter(e => e.area === 'produccion')
                .map(e => `
                    <div class="flex items-center justify-between p-3 bg-orange-50 rounded-lg group">
                        <div>
                            <p class="font-medium text-gray-800">${e.name}</p>
                            <p class="text-xs text-gray-500">${e.role}</p>
                        </div>
                        <button onclick="deleteEmployee('${e.id}')" class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-all btn-action">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `).join('');
                
            document.getElementById('serviceEmployees').innerHTML = employees
                .filter(e => e.area === 'atencion')
                .map(e => `
                    <div class="flex items-center justify-between p-3 bg-pink-50 rounded-lg group">
                        <div>
                            <p class="font-medium text-gray-800">${e.name}</p>
                            <p class="text-xs text-gray-500">${e.role}</p>
                        </div>
                        <button onclick="deleteEmployee('${e.id}')" class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-all btn-action">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `).join('');

            const nominaSelect = document.getElementById('nominaEmployee');
            const filterSelect = document.getElementById('nominaFilterEmployee');
            
            if (nominaSelect) {
                nominaSelect.innerHTML = '<option value="">Seleccionar empleado...</option>' +
                    employees.map(e => `<option value="${e.id}">${e.name} - ${e.role}</option>`).join('');
            }
            if (filterSelect) {
                filterSelect.innerHTML = '<option value="all">Todos los empleados</option>' +
                    employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            }
            
        } catch (error) {
            console.error('Error loading employees:', error);
        }
    }

    async function saveEmployee() {
        const name = document.getElementById('empName').value;
        const area = document.getElementById('empArea').value;
        const role = document.getElementById('empRole').value;
        
        if (!name || !role) {
            alert('Complete todos los campos');
            return;
        }
        
        try {
            const { error } = await supabaseClient.from('employees').insert([{ name, area, role }]);
            if (error) throw error;
            
            closeModal('employeeModal');
            await loadEmployees();
            
            document.getElementById('empName').value = '';
            document.getElementById('empRole').value = '';
            
        } catch (error) {
            alert('Error al guardar empleado: ' + error.message);
        }
    }

    async function deleteEmployee(id) {
        if (!confirm('¬øEliminar este empleado?')) return;
        
        try {
            await supabaseClient.from('employees').update({ is_active: false }).eq('id', id);
            await loadEmployees();
        } catch (error) {
            alert('Error al eliminar: ' + error.message);
        }
    }

    // ============================================
    // N√ìMINA - AHORA CON GASTO AUTOM√ÅTICO
    // ============================================

    function setNominaPaymentMethod(method) {
        document.getElementById('nominaPaymentMethod').value = method;
        
        document.querySelectorAll('.payment-nomina-btn').forEach(btn => {
            btn.classList.remove('border-brand-500', 'bg-brand-50', 'text-brand-700');
            btn.classList.add('border-gray-300', 'text-gray-600');
        });
        
        const activeBtn = document.getElementById('btnNomina' + method.charAt(0).toUpperCase() + method.slice(1));
        if (activeBtn) {
            activeBtn.classList.remove('border-gray-300', 'text-gray-600');
            activeBtn.classList.add('border-brand-500', 'bg-brand-50', 'text-brand-700');
        }
    }

    async function loadNomina() {
        try {
            const monthFilter = document.getElementById('nominaFilterMonth').value;
            const empFilter = document.getElementById('nominaFilterEmployee').value;
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            let query = supabaseClient.from('nomina').select('*').order('created_at', { ascending: false });
            
            if (monthFilter !== 'all') {
                query = query.eq('month', parseInt(monthFilter)).eq('year', currentYear);
            }
            
            if (empFilter !== 'all') {
                query = query.eq('employee_id', empFilter);
            }
            
            const { data, error } = await query;
            if (error) throw error;
            
            const currentMonthRecords = (data || []).filter(n => n.month === currentMonth && n.year === currentYear);
            const totalMes = currentMonthRecords.reduce((sum, n) => sum + n.total, 0);
            const totalSueldos = currentMonthRecords.reduce((sum, n) => sum + n.sueldo, 0);
            const totalHorasExtras = currentMonthRecords.reduce((sum, n) => sum + n.total_horas_extras, 0);
            const totalBonos = currentMonthRecords.reduce((sum, n) => sum + n.bono + n.bono_puntualidad, 0);
            
            document.getElementById('totalNominaMes').textContent = formatMoney(totalMes);
            document.getElementById('totalSueldos').textContent = formatMoney(totalSueldos);
            document.getElementById('totalHorasExtras').textContent = formatMoney(totalHorasExtras);
            document.getElementById('totalBonos').textContent = formatMoney(totalBonos);
            
            const tbody = document.getElementById('nominaTableBody');
            tbody.innerHTML = (data || []).map(rec => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-4 py-3 text-gray-600">${new Date(rec.created_at).toLocaleDateString()}</td>
                    <td class="px-4 py-3 font-medium">${rec.employee_name || 'N/A'}</td>
                    <td class="px-4 py-3 text-right">${formatMoney(rec.sueldo)}</td>
                    <td class="px-4 py-3 text-center">${rec.horas_extras}</td>
                    <td class="px-4 py-3 text-right">${formatMoney(rec.total_horas_extras)}</td>
                    <td class="px-4 py-3 text-right text-green-600">${formatMoney(rec.bono)}</td>
                    <td class="px-4 py-3 text-right text-purple-600">${formatMoney(rec.bono_puntualidad)}</td>
                    <td class="px-4 py-3 text-right font-bold">${formatMoney(rec.total)}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded-full text-xs ${getPaymentMethodColor(rec.payment_method)}">
                            ${rec.payment_method || 'efectivo'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="deleteNomina('${rec.id}')" class="text-gray-400 hover:text-red-500 transition-colors btn-action">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            const employeeTotals = {};
            currentMonthRecords.forEach(rec => {
                const empName = rec.employee_name || 'N/A';
                if (!employeeTotals[rec.employee_id]) {
                    employeeTotals[rec.employee_id] = {
                        name: empName,
                        total: 0,
                        sueldo: 0,
                        horasExtras: 0,
                        bonos: 0
                    };
                }
                employeeTotals[rec.employee_id].total += rec.total;
                employeeTotals[rec.employee_id].sueldo += rec.sueldo;
                employeeTotals[rec.employee_id].horasExtras += rec.total_horas_extras;
                employeeTotals[rec.employee_id].bonos += rec.bono + rec.bono_puntualidad;
            });
            
            document.getElementById('nominaResumenEmpleados').innerHTML = Object.values(employeeTotals).map(emp => `
                <div class="glass-panel p-4 rounded-xl border-l-4 border-brand-500">
                    <h4 class="font-bold text-gray-800 mb-2">${emp.name}</h4>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total:</span>
                            <span class="font-bold">${formatMoney(emp.total)}</span>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>Sueldo: ${formatMoney(emp.sueldo)}</span>
                            <span>H.E.: ${formatMoney(emp.horasExtras)}</span>
                            <span>Bonos: ${formatMoney(emp.bonos)}</span>
                        </div>
                    </div>
                </div>
            `).join('') || '<p class="text-gray-500 col-span-3 text-center">No hay registros este mes</p>';
            
        } catch (error) {
            console.error('Error loading nomina:', error);
        }
    }

    function calculateNominaTotal() {
        const sueldo = parseFloat(document.getElementById('nominaSueldo').value) || 0;
        const horasExtras = parseInt(document.getElementById('nominaHorasExtras').value) || 0;
        const pagoHoraExtra = parseFloat(document.getElementById('nominaPagoHoraExtra').value) || 0;
        const bono = parseFloat(document.getElementById('nominaBono').value) || 0;
        const bonoPuntualidad = parseFloat(document.getElementById('nominaBonoPuntualidad').value) || 0;
        
        const totalHorasExtras = horasExtras * pagoHoraExtra;
        const total = sueldo + totalHorasExtras + bono + bonoPuntualidad;
        
        document.getElementById('nominaTotal').textContent = formatMoney(total);
    }

    async function saveNomina() {
        const empId = document.getElementById('nominaEmployee').value;
        const month = parseInt(document.getElementById('nominaMonth').value);
        const year = parseInt(document.getElementById('nominaYear').value);
        const sueldo = parseFloat(document.getElementById('nominaSueldo').value) || 0;
        const horasExtras = parseInt(document.getElementById('nominaHorasExtras').value) || 0;
        const pagoHoraExtra = parseFloat(document.getElementById('nominaPagoHoraExtra').value) || 0;
        const bono = parseFloat(document.getElementById('nominaBono').value) || 0;
        const bonoPuntualidad = parseFloat(document.getElementById('nominaBonoPuntualidad').value) || 0;
        const paymentMethod = document.getElementById('nominaPaymentMethod').value;
        
        if (!empId) {
            alert('Seleccione un empleado');
            return;
        }
        
        const employee = employees.find(e => e.id === empId);
        if (!employee) {
            alert('Empleado no encontrado');
            return;
        }
        
        const totalHorasExtras = horasExtras * pagoHoraExtra;
        const total = sueldo + totalHorasExtras + bono + bonoPuntualidad;
        
        try {
            // Insertar n√≥mina
            const { data: nominaData, error: nominaError } = await supabaseClient
                .from('nomina')
                .insert([{
                    employee_id: empId,
                    employee_name: employee.name,
                    user_id: currentUser.id,
                    month,
                    year,
                    sueldo,
                    horas_extras: horasExtras,
                    pago_hora_extra: pagoHoraExtra,
                    total_horas_extras: totalHorasExtras,
                    bono,
                    bono_puntualidad: bonoPuntualidad,
                    total,
                    payment_method: paymentMethod,
                    registered_by: currentProfile.full_name
                }])
                .select()
                .single();

            if (nominaError) throw nominaError;

            // Crear gasto autom√°tico vinculado a la n√≥mina
            const { error: expenseError } = await supabaseClient
                .from('expenses')
                .insert([{
                    user_id: currentUser.id,
                    registered_by: currentProfile.full_name,
                    area: employee.area === 'produccion' ? 'produccion' : 'atencion',
                    concept: `N√≥mina - ${employee.name} (${new Date(year, month).toLocaleString('es-MX', {month: 'long'})} ${year})`,
                    provider: `N√≥mina: ${employee.name}`,
                    amount: total,
                    subtotal: total,
                    iva_amount: 0,
                    method: paymentMethod,
                    has_iva: false,
                    iva_included: false,
                    items_count: 1,
                    origen: 'nomina',
                    reference_id: nominaData.id
                }]);

            if (expenseError) throw expenseError;

            closeModal('nominaModal');
            await loadNomina();
            
            // Limpiar formulario
            document.getElementById('nominaEmployee').value = '';
            document.getElementById('nominaSueldo').value = '';
            document.getElementById('nominaHorasExtras').value = '';
            document.getElementById('nominaPagoHoraExtra').value = '';
            document.getElementById('nominaBono').value = '';
            document.getElementById('nominaBonoPuntualidad').value = '';
            setNominaPaymentMethod('efectivo');
            calculateNominaTotal();
            
            alert('Pago de n√≥mina registrado correctamente. Se cre√≥ el gasto correspondiente.');
            
        } catch (error) {
            alert('Error al guardar n√≥mina: ' + error.message);
            console.error(error);
        }
    }

    async function deleteNomina(id) {
        if (!confirm('¬øEliminar este registro de n√≥mina? Tambi√©n se eliminar√° el gasto asociado.')) return;
        
        try {
            // Buscar y eliminar el gasto asociado primero
            const { data: expenseData } = await supabaseClient
                .from('expenses')
                .select('id')
                .eq('origen', 'nomina')
                .eq('reference_id', id);

            if (expenseData && expenseData.length > 0) {
                await supabaseClient
                    .from('expenses')
                    .delete()
                    .eq('id', expenseData[0].id);
            }

            // Eliminar n√≥mina
            await supabaseClient.from('nomina').delete().eq('id', id);
            await loadNomina();
            alert('Registro de n√≥mina y gasto asociado eliminados correctamente');
        } catch (error) {
            alert('Error al eliminar: ' + error.message);
        }
    }

    function generateNominaReport() {
        alert('Funci√≥n de reporte en desarrollo');
    }

    // ============================================
    // FACTURAS GLOBALES - NUEVO M√ìDULO
    // ============================================

    function setCurrentMonthForGlobal() {
        const now = new Date();
        document.getElementById('globalInvoiceMonth').value = now.getMonth();
        document.getElementById('globalInvoiceYear').value = now.getFullYear();
        loadGlobalInvoiceWeeks();
    }

    async function loadGlobalInvoiceWeeks() {
        const month = parseInt(document.getElementById('globalInvoiceMonth').value);
        const year = parseInt(document.getElementById('globalInvoiceYear').value);
        
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        
        document.getElementById('globalInvoiceMonthLabel').textContent = `${monthNames[month]} ${year}`;
        document.getElementById('globalInvoiceSummary').classList.remove('hidden');
        
        // Calcular semanas del mes
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        
        const weeks = [];
        let currentWeek = 1;
        let currentDate = new Date(firstDay);
        
        while (currentDate <= lastDay) {
            const weekStart = new Date(currentDate);
            const weekEnd = new Date(currentDate);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            if (weekEnd > lastDay) weekEnd.setDate(lastDay.getDate());
            
            weeks.push({
                number: currentWeek,
                start: new Date(weekStart),
                end: new Date(weekEnd),
                startStr: weekStart.toISOString().split('T')[0],
                endStr: weekEnd.toISOString().split('T')[0]
            });
            
            currentDate.setDate(currentDate.getDate() + 7);
            currentWeek++;
        }
        
        // Cargar datos de ventas para cada semana
        const { data: monthSales } = await supabaseClient
            .from('sales')
            .select('*')
            .gte('created_at', firstDay.toISOString())
            .lt('created_at', new Date(year, month + 1, 1).toISOString())
            .eq('cancelled', false);

        // Cargar semanas ya facturadas
        const { data: invoicedWeeks } = await supabaseClient
            .from('global_invoices')
            .select('*')
            .eq('month', month)
            .eq('year', year);

        const invoicedWeekNumbers = new Set(invoicedWeeks?.map(w => w.week_number) || []);
        
        currentGlobalInvoiceWeeks = weeks.map(week => {
            const weekSales = (monthSales || []).filter(sale => {
                const saleDate = new Date(sale.created_at);
                return saleDate >= week.start && saleDate <= week.end;
            });
            
            const totalIVA0 = weekSales.reduce((sum, s) => sum + (s.total_iva_0 || 0), 0);
            const totalIVA16 = weekSales.reduce((sum, s) => sum + (s.total_iva_16 || 0), 0);
            const total = weekSales.reduce((sum, s) => sum + s.total, 0);
            const iva = weekSales.reduce((sum, s) => sum + s.iva, 0);
            
            return {
                ...week,
                sales: weekSales,
                totalIVA0,
                totalIVA16,
                total,
                iva,
                transactionCount: weekSales.length,
                isInvoiced: invoicedWeekNumbers.has(week.number)
            };
        });
        
        // Actualizar resumen
        const totalMonth = currentGlobalInvoiceWeeks.reduce((sum, w) => sum + w.total, 0);
        const invoicedCount = currentGlobalInvoiceWeeks.filter(w => w.isInvoiced).length;
        
        document.getElementById('globalMonthTotal').textContent = formatMoney(totalMonth);
        document.getElementById('globalWeeksCount').textContent = currentGlobalInvoiceWeeks.length;
        document.getElementById('globalWeeksInvoiced').textContent = invoicedCount;
        document.getElementById('globalWeeksPending').textContent = currentGlobalInvoiceWeeks.length - invoicedCount;
        
        renderGlobalInvoiceWeeks();
    }

    function renderGlobalInvoiceWeeks() {
        const container = document.getElementById('weeksContainer');
        
        container.innerHTML = currentGlobalInvoiceWeeks.map(week => `
            <div class="week-card glass-panel p-6 rounded-2xl relative ${week.isInvoiced ? 'facturada' : ''}" 
                 onclick="openWeekDetail(${week.number})">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-brand-800">Semana ${week.number}</h3>
                        <p class="text-sm text-gray-500">
                            ${week.start.getDate()}-${week.end.getDate()} de ${week.start.toLocaleString('es-MX', {month: 'long'})}
                        </p>
                    </div>
                    <div class="w-12 h-12 ${week.isInvoiced ? 'bg-green-500' : 'bg-brand-500'} rounded-full flex items-center justify-center text-white">
                        <i class="fas ${week.isInvoiced ? 'fa-check' : 'fa-calendar-week'}"></i>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Transacciones:</span>
                        <span class="font-bold">${week.transactionCount}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-pink-600">IVA 0%:</span>
                        <span class="font-bold text-pink-700">${formatMoney(week.totalIVA0)}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-blue-600">IVA 16%:</span>
                        <span class="font-bold text-blue-700">${formatMoney(week.totalIVA16)}</span>
                    </div>
                    <div class="flex justify-between pt-2 border-t">
                        <span class="font-bold text-gray-800">Total:</span>
                        <span class="font-bold text-xl text-brand-800">${formatMoney(week.total)}</span>
                    </div>
                </div>
                
                ${week.isInvoiced ? `
                    <div class="mt-3 text-center">
                        <span class="text-xs text-green-600 font-bold">
                            <i class="fas fa-check-circle mr-1"></i>Facturada
                        </span>
                    </div>
                ` : `
                    <div class="mt-3 text-center">
                        <span class="text-xs text-orange-600 font-bold">
                            <i class="fas fa-clock mr-1"></i>Pendiente de facturar
                        </span>
                    </div>
                `}
            </div>
        `).join('');
    }

    function openWeekDetail(weekNumber) {
        const week = currentGlobalInvoiceWeeks.find(w => w.number === weekNumber);
        if (!week) return;
        
        selectedWeekForInvoice = week;
        
        document.getElementById('weekDetailTitle').textContent = `Semana ${week.number}`;
        document.getElementById('weekDetailDates').textContent = 
            `${week.start.getDate()} de ${week.start.toLocaleString('es-MX', {month: 'long'})} al ${week.end.getDate()} de ${week.end.toLocaleString('es-MX', {month: 'long'})} ${week.start.getFullYear()}`;
        
        document.getElementById('weekDetailIVA0').textContent = formatMoney(week.totalIVA0);
        document.getElementById('weekDetailCount0').textContent = week.sales.filter(s => (s.total_iva_0 || 0) > 0).length;
        document.getElementById('weekDetailIVA16').textContent = formatMoney(week.totalIVA16);
        document.getElementById('weekDetailCount16').textContent = week.sales.filter(s => (s.total_iva_16 || 0) > 0).length;
        document.getElementById('weekDetailTotal').textContent = formatMoney(week.total);
        document.getElementById('weekDetailIVATotal').textContent = formatMoney(week.iva);
        
        // Calcular desglose CFDI
        const subtotal0 = week.totalIVA0;
        const subtotal16 = week.totalIVA16 / 1.16;
        const ivaTrasladado = week.totalIVA16 - subtotal16;
        
        document.getElementById('cfdiSubtotal0').textContent = formatMoney(subtotal0);
        document.getElementById('cfdiSubtotal16').textContent = formatMoney(subtotal16);
        document.getElementById('cfdiIVA').textContent = formatMoney(ivaTrasladado);
        document.getElementById('cfdiTotal').textContent = formatMoney(week.total);
        
        // Actualizar bot√≥n seg√∫n estado
        const btnMark = document.getElementById('btnMarkInvoiced');
        if (week.isInvoiced) {
            btnMark.innerHTML = '<i class="fas fa-times-circle mr-2"></i>Desmarcar como Facturada';
            btnMark.classList.remove('bg-green-600', 'hover:bg-green-700');
            btnMark.classList.add('bg-red-500', 'hover:bg-red-600');
        } else {
            btnMark.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Marcar como Facturada';
            btnMark.classList.remove('bg-red-500', 'hover:bg-red-600');
            btnMark.classList.add('bg-green-600', 'hover:bg-green-700');
        }
        
        openModal('weekDetailModal');
    }

    async function markWeekAsInvoiced() {
        if (!selectedWeekForInvoice) return;
        
        try {
            const month = parseInt(document.getElementById('globalInvoiceMonth').value);
            const year = parseInt(document.getElementById('globalInvoiceYear').value);
            
            if (selectedWeekForInvoice.isInvoiced) {
                // Desmarcar
                await supabaseClient
                    .from('global_invoices')
                    .delete()
                    .eq('month', month)
                    .eq('year', year)
                    .eq('week_number', selectedWeekForInvoice.number);
                
                selectedWeekForInvoice.isInvoiced = false;
            } else {
                // Marcar como facturada
                await supabaseClient
                    .from('global_invoices')
                    .insert([{
                        month,
                        year,
                        week_number: selectedWeekForInvoice.number,
                        date_from: selectedWeekForInvoice.startStr,
                        date_to: selectedWeekForInvoice.endStr,
                        total_iva_0: selectedWeekForInvoice.totalIVA0,
                        total_iva_16: selectedWeekForInvoice.totalIVA16,
                        iva_amount: selectedWeekForInvoice.iva,
                        total: selectedWeekForInvoice.total,
                        transaction_count: selectedWeekForInvoice.transactionCount,
                        invoiced_by: currentProfile.full_name,
                        invoiced_at: new Date().toISOString()
                    }]);
                
                selectedWeekForInvoice.isInvoiced = true;
            }
            
            renderGlobalInvoiceWeeks();
            closeModal('weekDetailModal');
            
        } catch (error) {
            console.error('Error marking week as invoiced:', error);
            alert('Error al actualizar el estado: ' + error.message);
        }
    }

    function exportWeekToExcel() {
        if (!selectedWeekForInvoice) return;
        
        const week = selectedWeekForInvoice;
        const month = parseInt(document.getElementById('globalInvoiceMonth').value);
        const year = parseInt(document.getElementById('globalInvoiceYear').value);
        const monthName = new Date(year, month).toLocaleString('es-MX', {month: 'long'});
        
        // Crear CSV
        let csv = 'Fecha,Hora,Folio,Productos,Tipo IVA,Subtotal,IVA,Total\n';
        
        week.sales.forEach(sale => {
            const date = new Date(sale.created_at);
            const fecha = date.toLocaleDateString('es-MX');
            const hora = date.toLocaleTimeString('es-MX');
            const folio = sale.id.slice(0, 8);
            const productos = sale.items.map(i => `${i.name}(${i.quantity})`).join('; ');
            const tipoIVA = (sale.total_iva_0 || 0) > 0 && (sale.total_iva_16 || 0) > 0 ? 'MIXTA' : 
                          (sale.total_iva_16 || 0) > 0 ? '16%' : '0%';
            
            csv += `"${fecha}","${hora}","${folio}","${productos}","${tipoIVA}",${sale.subtotal},${sale.iva},${sale.total}\n`;
        });
        
        // Resumen al final
        csv += '\n"RESUMEN SEMANA"\n';
        csv += `"Semana ${week.number} de ${monthName} ${year}"\n`;
        csv += `"Per√≠odo:","${week.start.getDate()} al ${week.end.getDate()} de ${monthName}"\n`;
        csv += `"Total IVA 0%:",${week.totalIVA0}\n`;
        csv += `"Total IVA 16%:",${week.totalIVA16}\n`;
        csv += `"IVA Trasladado:",${week.iva}\n`;
        csv += `"TOTAL:",${week.total}\n`;
        
        // Descargar
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `Factura_Global_Semana_${week.number}_${monthName}_${year}.csv`;
        link.click();
    }

    // ============================================
    // UTILIDADES
    // ============================================

    function formatMoney(amount) {
        return '$' + (amount || 0).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }

    function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    function openCustomProductModal() { openModal('customProductModal'); }
    function openEmployeeModal() { openModal('employeeModal'); }
    function openNominaModal() { 
        setNominaPaymentMethod('efectivo');
        calculateNominaTotal();
        openModal('nominaModal'); 
    }

    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.classList.remove('active');
        }
    }

    // Inicializar al cargar
    document.addEventListener('DOMContentLoaded', () => {
        checkSession();
        
        const today = new Date().toISOString().split('T')[0];
        const dateFrom = document.getElementById('filterDateFrom');
        const dateTo = document.getElementById('filterDateTo');
        if (dateFrom) dateFrom.value = today;
        if (dateTo) dateTo.value = today;
        
        const stockInput = document.getElementById('stockNewValue');
        if (stockInput) {
            stockInput.addEventListener('input', (e) => {
                let value = parseInt(e.target.value) || 0;
                if (value < 0) value = 0;
                document.getElementById('stockPreview').textContent = value;
            });
        }
        
        // Set current year for global invoices
        const globalYear = document.getElementById('globalInvoiceYear');
        if (globalYear) globalYear.value = new Date().getFullYear();
    });
</script>

</body>
</html>
