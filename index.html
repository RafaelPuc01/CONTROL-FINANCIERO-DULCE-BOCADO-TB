<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dulce Bocado - ERP</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#6d453c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dulce Bocado">
    <meta name="description" content="Sistema ERP para Dulce Bocado - Gestión de ventas, inventario, nómina y gastos con OCR">

    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRHVsY2UgQm9jYWRvIC0gRVJQIiwic2hvcnRfbmFtZSI6IkR1bGNlIEJvY2FkbyIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmRmOGY2IiwidGhlbWVfY29sb3IiOiIjNmQ0NTNjIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9naC9kZXZlbG9wZXJzL2dpdGh1Yi9mbGFncy9lNDc0MjQucG5nIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyJ9XX0=">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Tesseract.js para OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    colors: {
                        brand: {
                            50: '#fdf8f6',
                            100: '#f2e8e5',
                            200: '#eaddd7',
                            300: '#e0cec7',
                            400: '#d2bab0',
                            500: '#a77f70',
                            600: '#8a5a4d',
                            700: '#6d453c',
                            800: '#4a2e28',
                            900: '#2d1b17',
                        },
                        sweet: {
                            100: '#fff0f3',
                            200: '#ffc1cc',
                            300: '#ff8fa3',
                            400: '#ff5c7a',
                            500: '#e83e5f',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            background: linear-gradient(135deg, #fdf8f6 0%, #fff0f3 100%);
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .sidebar-item { transition: all 0.3s ease; }
        .sidebar-item:hover { transform: translateX(5px); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #a77f70; border-radius: 3px; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        .btn-action { transition: all 0.2s; }
        .btn-action:hover { transform: scale(1.1); }
        
        .sidebar { 
            transition: width 0.3s ease-in-out; 
            width: 16rem;
        }
        .sidebar.mini { 
            width: 4.5rem;
        }
        .sidebar.mini .sidebar-text,
        .sidebar.mini .sidebar-header-text,
        .sidebar.mini .user-info {
            display: none;
        }
        .sidebar.mini .sidebar-item {
            justify-content: center;
            padding-left: 0;
            padding-right: 0;
        }
        .sidebar.mini .sidebar-item i {
            margin: 0;
            font-size: 1.25rem;
        }
        .sidebar.mini .sidebar-section-title {
            display: none;
        }
        
        .main-content { transition: margin-left 0.3s ease-in-out; }
        
        .nomina-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        
        #installPWA {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: linear-gradient(135deg, #6d453c, #8a5a4d);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            display: none;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .search-container {
            position: relative;
            margin-bottom: 1rem;
        }
        .search-input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }
        .search-input:focus {
            outline: none;
            border-color: #a77f70;
            box-shadow: 0 0 0 3px rgba(167, 127, 112, 0.1);
        }
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }
        
        .product-card {
            transition: all 0.3s ease;
        }
        .product-card.no-stock {
            opacity: 0.6;
            order: 2;
            background: #f3f4f6;
        }
        .product-card.has-stock {
            order: 1;
        }
        .stock-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }
        .stock-badge.high { background: #10b981; color: white; }
        .stock-badge.low { background: #f59e0b; color: white; }
        .stock-badge.none { background: #ef4444; color: white; }
        
        .sidebar.mini .sidebar-item {
            position: relative;
        }
        .sidebar.mini .sidebar-item:hover::after {
            content: attr(data-title);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: #2d1b17;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            margin-left: 8px;
            z-index: 100;
        }
        
        .stock-input-cashier {
            width: 80px;
            text-align: center;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 4px;
            font-weight: bold;
        }
        .stock-input-cashier:focus {
            outline: none;
            border-color: #a77f70;
        }

        /* NUEVO: Estilos para expansión de ventas mixtas */
        .sale-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .sale-row:hover {
            background-color: #f9fafb;
        }
        .sale-details {
            display: none;
            background-color: #f9fafb;
            border-top: 1px dashed #e5e7eb;
        }
        .sale-details.active {
            display: table-row;
        }
        .iva-badge-0 { background: #fce7f3; color: #be185d; }
        .iva-badge-16 { background: #dbeafe; color: #1e40af; }
        .iva-badge-mix { background: #f3e8ff; color: #7c3aed; }

        /* NUEVOS ESTILOS PARA MÓDULO DE GASTOS */
        .expense-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-ocr { background: #e0f2fe; color: #0369a1; }
        .badge-edited { background: #fef3c7; color: #92400e; }
        .badge-suggestion { background: #f3e8ff; color: #7c3aed; }
        
        .ocr-preview-item {
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        .ocr-preview-item:hover {
            border-left-color: #a77f70;
            background: #fafafa;
        }
        .ocr-confidence-low {
            border-left-color: #ef4444 !important;
            background: #fef2f2;
        }
        
        .drop-zone {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s;
            background: #f9fafb;
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #a77f70;
            background: #fdf2f8;
        }
        
        .learning-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #7c3aed;
            font-style: italic;
        }
        
        .expense-report-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
        }
    </style>
</head>
<body class="h-screen overflow-hidden">

<!-- PWA Install Button -->
<button id="installPWA" onclick="installApp()">
    <i class="fas fa-download mr-2"></i>Instalar App
</button>

<!-- Login Screen -->
<div id="loginScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-brand-100 to-sweet-100">
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4 transform transition-all hover:scale-105">
        <div class="text-center mb-8">
            <div class="w-20 h-20 bg-gradient-to-br from-brand-500 to-sweet-500 rounded-full mx-auto mb-4 flex items-center justify-center text-white text-3xl">
                <i class="fas fa-birthday-cake"></i>
            </div>
            <h1 class="text-3xl font-serif font-bold text-brand-800">Dulce Bocado</h1>
            <p class="text-brand-600 mt-2">Tierra Blanca - ERP System</p>
        </div>
        
        <div id="loginForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input type="email" id="loginEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all" placeholder="admin@dulcebocado.com">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                <input type="password" id="loginPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all" placeholder="••••••">
            </div>
            <button onclick="login()" class="w-full bg-gradient-to-r from-brand-600 to-brand-700 text-white py-3 rounded-lg font-semibold hover:from-brand-700 hover:to-brand-800 transition-all transform hover:scale-105 shadow-lg">
                Ingresar al Sistema
            </button>
            <div class="text-center">
                <button onclick="showRegisterForm()" class="text-sm text-brand-600 hover:text-brand-800 underline">
                    Crear cuenta nueva
                </button>
            </div>
        </div>

        <div id="registerForm" class="space-y-4 hidden">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo</label>
                <input type="text" id="regName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Tu nombre">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input type="email" id="regEmail" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="tu@email.com">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                <input type="password" id="regPassword" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Mínimo 6 caracteres">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Rol</label>
                <select id="regRole" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    <option value="cashier">Cajero</option>
                    <option value="admin">Administrador</option>
                </select>
            </div>
            <button onclick="register()" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-3 rounded-lg font-semibold hover:from-green-700 hover:to-green-800 transition-all shadow-lg">
                Crear Cuenta
            </button>
            <div class="text-center">
                <button onclick="showLoginForm()" class="text-sm text-gray-600 hover:text-gray-800 underline">
                    Ya tengo cuenta
                </button>
            </div>
        </div>
        
        <div class="mt-6 text-center text-sm text-gray-500">
            <p>Sistema conectado a Supabase</p>
        </div>
    </div>
</div>

<!-- Main App -->
<div id="mainApp" class="hidden h-full flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar bg-gradient-to-b from-brand-900 to-brand-800 text-white flex flex-col shadow-2xl z-50">
        <div class="p-4 border-b border-brand-700 flex justify-between items-center">
            <div class="flex items-center gap-3 sidebar-header-text">
                <div class="w-10 h-10 bg-sweet-500 rounded-full flex items-center justify-center">
                    <i class="fas fa-cookie-bite text-white"></i>
                </div>
                <div>
                    <h2 class="font-serif font-bold text-lg">Dulce Bocado</h2>
                    <p class="text-xs text-brand-300">ERP Supabase</p>
                </div>
            </div>
            <button onclick="toggleSidebar()" class="text-white hover:text-brand-200 transition-colors p-2 rounded-lg hover:bg-brand-700" title="Contraer/Expandir menú">
                <i class="fas fa-chevron-left text-lg" id="toggleIcon"></i>
            </button>
        </div>

        <nav class="flex-1 p-3 space-y-2 overflow-y-auto custom-scrollbar">
            <div class="text-xs font-semibold text-brand-400 uppercase tracking-wider mb-2 px-2 sidebar-section-title">Principal</div>
            
            <button onclick="showModule('dashboard')" data-title="Dashboard" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-brand-700 transition-colors text-left admin-only">
                <i class="fas fa-chart-pie w-5 text-center"></i>
                <span class="sidebar-text">Dashboard Financiero</span>
            </button>

            <button onclick="showModule('pos')" data-title="Punto de Venta" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-brand-700 transition-colors text-left">
                <i class="fas fa-cash-register w-5 text-center"></i>
                <span class="sidebar-text">Punto de Venta (POS)</span>
            </button>

            <button onclick="showModule('salesHistory')" data-title="Historial" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-brand-700 transition-colors text-left">
                <i class="fas fa-receipt w-5 text-center"></i>
                <span class="sidebar-text">Historial de Ventas</span>
            </button>

            <button onclick="showModule('expenses')" data-title="Gastos" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-brand-700 transition-colors text-left">
                <i class="fas fa-wallet w-5 text-center"></i>
                <span class="sidebar-text" id="expensesMenuText">Mis Gastos</span>
            </button>

            <button onclick="showModule('products')" data-title="Productos" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-brand-700 transition-colors text-left">
                <i class="fas fa-box w-5 text-center"></i>
                <span class="sidebar-text">Productos</span>
            </button>

            <div class="text-xs font-semibold text-brand-400 uppercase tracking-wider mt-6 mb-2 px-2 sidebar-section-title admin-only">Administración</div>

            <button onclick="showModule('bank')" data-title="Bancos" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-brand-700 transition-colors text-left admin-only">
                <i class="fas fa-university w-5 text-center"></i>
                <span class="sidebar-text">Bancos y Efectivo</span>
            </button>

            <button onclick="showModule('taxes')" data-title="Impuestos" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-brand-700 transition-colors text-left admin-only">
                <i class="fas fa-calculator w-5 text-center"></i>
                <span class="sidebar-text">Impuestos (IVA/ISR)</span>
            </button>

            <button onclick="showModule('employees')" data-title="Empleados" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-brand-700 transition-colors text-left admin-only">
                <i class="fas fa-users w-5 text-center"></i>
                <span class="sidebar-text">Empleados</span>
            </button>

            <button onclick="showModule('nomina')" data-title="Nómina" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-brand-700 transition-colors text-left admin-only">
                <i class="fas fa-money-check-alt w-5 text-center"></i>
                <span class="sidebar-text">Nómina</span>
            </button>
        </nav>

        <div class="p-3 border-t border-brand-700">
            <div class="flex items-center gap-3 mb-3 user-info">
                <div class="w-8 h-8 bg-brand-600 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-sm"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium truncate" id="currentUserName">Usuario</p>
                    <p class="text-xs text-brand-400" id="currentUserRole">Rol</p>
                </div>
            </div>
            <button onclick="logout()" data-title="Cerrar Sesión" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors text-sm group">
                <i class="fas fa-power-off text-lg"></i>
                <span class="sidebar-text">Cerrar Sesión</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main id="mainContent" class="flex-1 overflow-y-auto bg-gray-50 p-8 custom-scrollbar main-content">
        
        <!-- Dashboard Module -->
        <div id="dashboard" class="module fade-in">
            <div class="mb-8">
                <h1 class="text-3xl font-serif font-bold text-brand-900 mb-2">Dashboard Financiero</h1>
                <p class="text-gray-600">Resumen general del negocio (Datos en tiempo real)</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="glass-panel p-6 rounded-2xl card-hover border-l-4 border-green-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm mb-1">Ventas Reales del Día</p>
                            <h3 class="text-2xl font-bold text-gray-800" id="dashboardTodaySales">$0.00</h3>
                        </div>
                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                    <p class="text-xs text-green-600 mt-2" id="salesStatus"><i class="fas fa-check-circle"></i> Sin cancelaciones</p>
                </div>

                <div class="glass-panel p-6 rounded-2xl card-hover border-l-4 border-blue-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm mb-1">IVA por Pagar</p>
                            <h3 class="text-2xl font-bold text-gray-800" id="dashboardIVA">$0.00</h3>
                        </div>
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                            <i class="fas fa-percentage"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Este mes</p>
                </div>

                <div class="glass-panel p-6 rounded-2xl card-hover border-l-4 border-purple-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm mb-1">ISR Estimado (RESICO)</p>
                            <h3 class="text-2xl font-bold text-gray-800" id="dashboardISR">$0.00</h3>
                        </div>
                        <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center text-purple-600">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">2.5% de ingresos</p>
                </div>

                <div class="glass-panel p-6 rounded-2xl card-hover border-l-4 border-orange-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm mb-1">Gastos del Mes</p>
                            <h3 class="text-2xl font-bold text-gray-800" id="dashboardExpenses">$0.00</h3>
                        </div>
                        <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center text-orange-600">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <p class="text-xs text-red-500 mt-2" id="expenseTrend"><i class="fas fa-arrow-down"></i> Ver detalle</p>
                </div>
            </div>

            <div id="cancelledAlert" class="hidden mb-6 glass-panel p-4 rounded-xl bg-red-50 border border-red-200">
                <div class="flex items-center gap-3 text-red-800">
                    <i class="fas fa-exclamation-triangle text-xl"></i>
                    <div>
                        <p class="font-bold">Hay ventas canceladas hoy</p>
                        <p class="text-sm">Total cancelado: <span id="cancelledAmount" class="font-bold">$0.00</span> | Ventas afectadas: <span id="cancelledCount">0</span></p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="text-lg font-bold text-brand-800 mb-4">Ventas vs Gastos (Últimos 7 días)</h3>
                    <canvas id="salesChart" class="w-full h-64"></canvas>
                </div>
                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="text-lg font-bold text-brand-800 mb-4">Distribución de Gastos por Área</h3>
                    <canvas id="expensesChart" class="w-full h-64"></canvas>
                </div>
            </div>

            <div class="glass-panel p-6 rounded-2xl">
                <h3 class="text-lg font-bold text-brand-800 mb-4">Actividad Reciente</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="px-4 py-3 text-left rounded-l-lg">Fecha</th>
                                <th class="px-4 py-3 text-left">Concepto</th>
                                <th class="px-4 py-3 text-left">Tipo</th>
                                <th class="px-4 py-3 text-right rounded-r-lg">Monto</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivityTable" class="divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- POS Module -->
        <div id="pos" class="module hidden fade-in">
            <div class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-serif font-bold text-brand-900 mb-2">Punto de Venta</h1>
                    <p class="text-gray-600">Nueva venta - Los precios con IVA ya incluyen el 16%</p>
                </div>
                <button onclick="openCustomProductModal()" class="bg-sweet-500 hover:bg-sweet-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-plus mr-2"></i>Pastel Personalizado
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-200px)]">
                <div class="lg:col-span-2 glass-panel rounded-2xl p-6 overflow-y-auto custom-scrollbar">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="productSearch" class="search-input" placeholder="Buscar productos por nombre..." oninput="filterProductsBySearch(this.value)">
                    </div>
                    
                    <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                        <button onclick="filterProducts('all')" class="px-4 py-2 bg-brand-600 text-white rounded-full text-sm whitespace-nowrap hover:bg-brand-700 transition-colors">Todos</button>
                        <button onclick="filterProducts('pasteles')" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-full text-sm whitespace-nowrap hover:bg-gray-50 transition-colors">Pasteles</button>
                        <button onclick="filterProducts('postres')" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-full text-sm whitespace-nowrap hover:bg-gray-50 transition-colors">Postres</button>
                        <button onclick="filterProducts('decoracion')" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-full text-sm whitespace-nowrap hover:bg-gray-50 transition-colors">Decoración</button>
                        <button onclick="filterProducts('herramientas')" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-full text-sm whitespace-nowrap hover:bg-gray-50 transition-colors">Herramientas</button>
                    </div>

                    <div id="productsGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    </div>
                </div>

                <div class="glass-panel rounded-2xl p-6 flex flex-col">
                    <h3 class="text-lg font-bold text-brand-800 mb-4">Ticket Actual</h3>
                    
                    <div id="cartItems" class="flex-1 overflow-y-auto custom-scrollbar space-y-3 mb-4">
                        <div class="text-center text-gray-400 py-8">
                            <i class="fas fa-shopping-basket text-4xl mb-2"></i>
                            <p>Carrito vacío</p>
                        </div>
                    </div>

                    <div class="border-t pt-4 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Subtotal:</span>
                            <span class="font-medium" id="cartSubtotal">$0.00</span>
                        </div>
                        <div class="flex justify-between text-sm text-blue-600">
                            <span class="text-gray-600">IVA (16%):</span>
                            <span class="font-medium" id="cartIVA">$0.00</span>
                            <span class="text-xs text-gray-400">(incluido)</span>
                        </div>
                        <div class="flex justify-between text-lg font-bold text-brand-800 pt-2 border-t">
                            <span>Total:</span>
                            <span id="cartTotal">$0.00</span>
                        </div>
                    </div>

                    <div class="mt-4 space-y-2">
                        <label class="text-sm font-medium text-gray-700">Método de Pago:</label>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button onclick="setPaymentMethod('efectivo')" id="btnEfectivo" class="payment-btn py-2 border-2 border-brand-500 bg-brand-50 text-brand-700 rounded-lg text-sm font-medium transition-all">
                                <i class="fas fa-money-bill-wave mr-1"></i>Efectivo
                            </button>
                            <button onclick="setPaymentMethod('transferencia')" id="btnTransferencia" class="payment-btn py-2 border-2 border-gray-300 text-gray-600 rounded-lg text-sm font-medium transition-all hover:border-brand-400">
                                <i class="fas fa-mobile-alt mr-1"></i>Transfer
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="setPaymentMethod('tarjeta')" id="btnTarjeta" class="payment-btn py-2 border-2 border-gray-300 text-gray-600 rounded-lg text-sm font-medium transition-all hover:border-brand-400">
                                <i class="fas fa-credit-card mr-1"></i>Tarjeta
                            </button>
                            <button onclick="openMixedPaymentModal()" id="btnMixto" class="payment-btn py-2 border-2 border-purple-300 text-purple-600 rounded-lg text-sm font-medium transition-all hover:border-purple-500 hover:bg-purple-50">
                                <i class="fas fa-calculator mr-1"></i>Pago Mixto
                            </button>
                        </div>
                        
                        <div id="mixedPaymentSummary" class="hidden mt-3 p-3 bg-purple-50 rounded-lg border border-purple-200">
                            <p class="text-xs font-bold text-purple-800 mb-2">Desglose del Pago:</p>
                            <div class="space-y-1 text-sm">
                                <div class="flex justify-between"><span class="text-gray-600">Efectivo:</span><span class="font-medium" id="mixedCash">$0.00</span></div>
                                <div class="flex justify-between"><span class="text-gray-600">Transferencia:</span><span class="font-medium" id="mixedTransfer">$0.00</span></div>
                                <div class="flex justify-between"><span class="text-gray-600">Tarjeta:</span><span class="font-medium" id="mixedCard">$0.00</span></div>
                                <div class="flex justify-between border-t border-purple-200 pt-1 mt-1">
                                    <span class="font-bold text-purple-900">Total:</span>
                                    <span class="font-bold text-purple-900" id="mixedTotal">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="processSale()" class="mt-4 w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-3 rounded-lg font-bold text-lg hover:from-green-700 hover:to-green-800 transition-all transform hover:scale-105 shadow-lg">
                        <i class="fas fa-check-circle mr-2"></i>Cobrar
                    </button>
                </div>
            </div>
        </div>

        <!-- Sales History Module -->
        <div id="salesHistory" class="module hidden fade-in">
            <div class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-serif font-bold text-brand-900 mb-2">Historial de Ventas</h1>
                    <p class="text-gray-600">Corte del día y ventas anteriores</p>
                </div>
                <button onclick="generateDailyCut()" class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded-lg transition-colors shadow-lg">
                    <i class="fas fa-cut mr-2"></i>Generar Corte del Día
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="glass-panel p-6 rounded-2xl bg-gradient-to-br from-green-50 to-green-100 border border-green-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-800 text-sm font-medium">Ventas Hoy (Reales)</p>
                            <h3 class="text-2xl font-bold text-green-900" id="historyTotalSales">$0.00</h3>
                            <p class="text-xs text-green-700 mt-1"><span id="historyCount">0</span> transacciones</p>
                        </div>
                        <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-white text-xl">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-2xl bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-800 text-sm font-medium">En Caja Debería Haber</p>
                            <h3 class="text-2xl font-bold text-blue-900" id="historyShouldHave">$0.00</h3>
                            <div class="text-xs text-blue-700 mt-1 space-x-2">
                                <span id="cashTotal">E: $0</span>
                                <span id="transferTotal">T: $0</span>
                                <span id="cardTotal">C: $0</span>
                            </div>
                        </div>
                        <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white text-xl">
                            <i class="fas fa-cash-register"></i>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-2xl bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-800 text-sm font-medium">IVA Generado Hoy</p>
                            <h3 class="text-2xl font-bold text-purple-900" id="historyIVA">$0.00</h3>
                            <p class="text-xs text-purple-700 mt-1">IVA incluido en precios</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center text-white text-xl">
                            <i class="fas fa-receipt"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div id="historyCancelledSection" class="hidden mb-6 glass-panel p-4 rounded-xl bg-red-50 border border-red-200">
                <h4 class="font-bold text-red-800 mb-2">Ventas Canceladas Hoy</h4>
                <div class="grid grid-cols-3 gap-4 text-sm">
                    <div>
                        <span class="text-gray-600">Total Cancelado:</span>
                        <span class="font-bold text-red-600 ml-2" id="historyCancelledAmount">$0.00</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Ventas Afectadas:</span>
                        <span class="font-bold text-red-600 ml-2" id="historyCancelledCount">0</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Ventas Brutas:</span>
                        <span class="font-bold text-gray-600 ml-2" id="historyGrossSales">$0.00</span>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-4 rounded-xl mb-6 flex flex-wrap gap-4 items-center">
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">Desde:</label>
                    <input type="date" id="filterDateFrom" class="border border-gray-300 rounded-lg px-3 py-1 text-sm focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">Hasta:</label>
                    <input type="date" id="filterDateTo" class="border border-gray-300 rounded-lg px-3 py-1 text-sm focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
                <button onclick="filterSales()" class="bg-brand-600 text-white px-4 py-1 rounded-lg text-sm hover:bg-brand-700 transition-colors">
                    <i class="fas fa-filter mr-1"></i>Filtrar
                </button>
                <button onclick="loadTodaySales()" class="bg-gray-200 text-gray-700 px-4 py-1 rounded-lg text-sm hover:bg-gray-300 transition-colors">
                    Hoy
                </button>
            </div>

            <div class="glass-panel rounded-2xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-brand-50 text-brand-800">
                            <tr>
                                <th class="px-4 py-3 text-left">Folio</th>
                                <th class="px-4 py-3 text-left">Fecha/Hora</th>
                                <th class="px-4 py-3 text-left">Cajero</th>
                                <th class="px-4 py-3 text-left">Productos</th>
                                <th class="px-4 py-3 text-center">Tipo IVA</th>
                                <th class="px-4 py-3 text-left">Método</th>
                                <th class="px-4 py-3 text-right">Total</th>
                                <th class="px-4 py-3 text-center">Estado</th>
                                <th class="px-4 py-3 text-center admin-only-inline">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody" class="divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- EXPENSES MODULE - NUEVO SISTEMA COMPLETO -->
        <div id="expenses" class="module hidden fade-in">
            <div class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-serif font-bold text-brand-900 mb-2" id="expensesTitle">Gastos y Egresos</h1>
                    <p class="text-gray-600" id="expensesSubtitle">Control de egresos con OCR y aprendizaje automático</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="openExpenseTypeModal()" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-2 rounded-lg transition-colors shadow-lg">
                        <i class="fas fa-camera mr-2"></i>Con Ticket (OCR)
                    </button>
                    <button onclick="openManualExpenseModal()" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-6 py-2 rounded-lg transition-colors shadow-lg">
                        <i class="fas fa-edit mr-2"></i>Manual
                    </button>
                </div>
            </div>

            <!-- Estadísticas de Gastos -->
            <div id="adminExpenseStats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="glass-panel p-4 rounded-xl border-l-4 border-red-500">
                    <p class="text-xs text-gray-500 uppercase">Producción</p>
                    <h4 class="text-lg font-bold text-gray-800" id="expenseProduction">$0.00</h4>
                </div>
                <div class="glass-panel p-4 rounded-xl border-l-4 border-blue-500">
                    <p class="text-xs text-gray-500 uppercase">Atención Clientes</p>
                    <h4 class="text-lg font-bold text-gray-800" id="expenseCustomerService">$0.00</h4>
                </div>
                <div class="glass-panel p-4 rounded-xl border-l-4 border-yellow-500">
                    <p class="text-xs text-gray-500 uppercase">Administrativo</p>
                    <h4 class="text-lg font-bold text-gray-800" id="expenseAdmin">$0.00</h4>
                </div>
                <div class="glass-panel p-4 rounded-xl border-l-4 border-purple-500">
                    <p class="text-xs text-gray-500 uppercase">Otros</p>
                    <h4 class="text-lg font-bold text-gray-800" id="expenseOthers">$0.00</h4>
                </div>
            </div>

            <!-- Filtros y Tabla -->
            <div class="glass-panel rounded-2xl overflow-hidden">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center flex-wrap gap-4">
                    <h3 class="font-bold text-brand-800" id="expensesTableTitle">Registro de Gastos</h3>
                    <div class="flex gap-2 items-center">
                        <span id="expenseFilterLabel" class="text-sm text-gray-600 hidden">Mostrando solo tus gastos</span>
                        <select id="expenseFilterArea" onchange="loadExpenses()" class="border border-gray-300 rounded-lg px-3 py-1 text-sm admin-only-inline">
                            <option value="all">Todas las áreas</option>
                            <option value="produccion">Producción</option>
                            <option value="atencion">Atención a Clientes</option>
                            <option value="administrativo">Administrativo</option>
                            <option value="otros">Otros</option>
                        </select>
                        <button onclick="openExpenseReports()" class="bg-brand-100 text-brand-700 px-3 py-1 rounded-lg text-sm hover:bg-brand-200 transition-colors">
                            <i class="fas fa-chart-bar mr-1"></i>Reportes
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="px-4 py-3 text-left">Fecha</th>
                                <th class="px-4 py-3 text-left">Ticket/Concepto</th>
                                <th class="px-4 py-3 text-left admin-only-inline">Área</th>
                                <th class="px-4 py-3 text-center">Items</th>
                                <th class="px-4 py-3 text-right">Total</th>
                                <th class="px-4 py-3 text-center">IVA</th>
                                <th class="px-4 py-3 text-center">Badges</th>
                                <th class="px-4 py-3 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody" class="divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Products Module -->
        <div id="products" class="module hidden fade-in">
            <div class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-serif font-bold text-brand-900 mb-2">Catálogo de Productos</h1>
                    <p class="text-gray-600">Precios con IVA ya incluyen el 16%</p>
                </div>
                <button onclick="openProductModal()" class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded-lg transition-colors shadow-lg admin-only-inline" id="btnNewProduct">
                    <i class="fas fa-plus mr-2"></i>Nuevo Producto
                </button>
            </div>

            <div class="glass-panel rounded-2xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-brand-50 text-brand-800">
                            <tr>
                                <th class="px-4 py-3 text-left">Nombre</th>
                                <th class="px-4 py-3 text-left">Categoría</th>
                                <th class="px-4 py-3 text-center">Stock</th>
                                <th class="px-4 py-3 text-center">IVA Incluido</th>
                                <th class="px-4 py-3 text-right">Precio Final</th>
                                <th class="px-4 py-3 text-center">Estado</th>
                                <th class="px-4 py-3 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody" class="divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Bank Module -->
        <div id="bank" class="module hidden fade-in admin-only-content">
            <div class="mb-6">
                <h1 class="text-3xl font-serif font-bold text-brand-900 mb-2">Bancos y Efectivo</h1>
                <p class="text-gray-600">Saldos actualizados en tiempo real</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-green-100 rounded-full -mr-16 -mt-16 opacity-50"></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-white text-xl">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Efectivo en Caja</h3>
                                <p class="text-sm text-gray-500">Disponible actual</p>
                            </div>
                        </div>
                        <div class="text-3xl font-bold text-green-700 mb-2" id="cashBalance">$0.00</div>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-blue-100 rounded-full -mr-16 -mt-16 opacity-50"></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white text-xl">
                                <i class="fas fa-university"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Cuenta Bancaria</h3>
                                <p class="text-sm text-gray-500">Transferencias y tarjetas</p>
                            </div>
                        </div>
                        <div class="text-3xl font-bold text-blue-700 mb-2" id="bankBalance">$0.00</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Taxes Module -->
        <div id="taxes" class="module hidden fade-in admin-only-content">
            <div class="mb-6">
                <h1 class="text-3xl font-serif font-bold text-brand-900 mb-2">Impuestos</h1>
                <p class="text-gray-600">Desglose de ventas por tipo de IVA y cálculo de impuestos</p>
            </div>

            <div class="glass-panel p-6 rounded-2xl mb-6 border-l-4 border-brand-500">
                <h3 class="text-lg font-bold text-brand-800 mb-4">
                    <i class="fas fa-calendar-alt mr-2"></i>Seleccionar Período de Análisis
                </h3>
                <div class="flex flex-wrap gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Inicio</label>
                        <input type="date" id="taxDateFrom" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Fin</label>
                        <input type="date" id="taxDateTo" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <button onclick="calculateTaxesByPeriod()" class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded-lg transition-colors shadow-lg">
                        <i class="fas fa-search mr-2"></i>Analizar Período
                    </button>
                    <button onclick="setTaxPeriodThisMonth()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition-colors">
                        Este Mes
                    </button>
                    <button onclick="setTaxPeriodLastMonth()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition-colors">
                        Mes Pasado
                    </button>
                </div>
            </div>

            <div id="taxPeriodSummary" class="hidden mb-6">
                <div class="glass-panel p-4 rounded-xl bg-brand-50 border border-brand-200 mb-4">
                    <h4 class="font-bold text-brand-800 mb-2">
                        <i class="fas fa-file-invoice mr-2"></i>Resumen del Período: 
                        <span id="taxPeriodLabel" class="text-brand-600"></span>
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Total Ventas:</span>
                            <span class="font-bold text-brand-800 ml-2" id="taxPeriodTotalSales">$0.00</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Transacciones:</span>
                            <span class="font-bold text-brand-800 ml-2" id="taxPeriodTransactions">0</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Ventas IVA 0%:</span>
                            <span class="font-bold text-pink-600 ml-2" id="taxPeriodCount0">0</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Ventas IVA 16%:</span>
                            <span class="font-bold text-blue-600 ml-2" id="taxPeriodCount16">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden border-t-4 border-pink-400">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-pink-100 rounded-full -mr-16 -mt-16 opacity-50"></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-pink-500 rounded-full flex items-center justify-center text-white text-xl">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Ventas con IVA 0%</h3>
                                <p class="text-sm text-gray-500">Productos sin IVA (Exentos)</p>
                            </div>
                        </div>
                        <div class="text-3xl font-bold text-pink-700 mb-2" id="salesIVA0">$0.00</div>
                        <div class="text-sm text-gray-600 mb-4">
                            <span id="transactionsIVA0">0</span> transacciones
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden border-t-4 border-blue-400">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-blue-100 rounded-full -mr-16 -mt-16 opacity-50"></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white text-xl">
                                <i class="fas fa-receipt"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Ventas con IVA 16%</h3>
                                <p class="text-sm text-gray-500">IVA incluido en precios</p>
                            </div>
                        </div>
                        <div class="text-3xl font-bold text-blue-700 mb-2" id="salesIVA16">$0.00</div>
                        <div class="text-sm text-gray-600 mb-4">
                            <span id="transactionsIVA16">0</span> transacciones | 
                            IVA incluido: <span class="font-bold text-blue-600" id="ivaIncluded16">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="glass-panel p-6 rounded-2xl border-t-4 border-blue-500">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">IVA (16% incluido en precios)</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                            <span class="text-gray-700">IVA Cobrado (Ventas)</span>
                            <span class="font-bold text-blue-700" id="ivaCharged">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                            <span class="text-gray-700">IVA en Gastos</span>
                            <span class="font-bold text-red-700" id="ivaExpenses">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-blue-100 rounded-lg border-2 border-blue-300">
                            <span class="font-bold text-blue-900">IVA a Pagar</span>
                            <span class="font-bold text-xl text-blue-900" id="ivaToPay">$0.00</span>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-2xl border-t-4 border-purple-500">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">ISR - RESICO</h3>
                    <div class="bg-purple-50 p-4 rounded-lg mb-4">
                        <p class="text-sm text-purple-900 mb-2"><strong>Régimen:</strong> RESICO (Personas Físicas)</p>
                        <p class="text-sm text-purple-900 mb-2"><strong>Actividad:</strong> Panificación Tradicional</p>
                        <p class="text-sm text-purple-900"><strong>Tasa:</strong> 2.5% sobre ingresos</p>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Ingresos del Periodo:</span>
                            <span class="font-medium" id="isrIncome">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-purple-100 rounded-lg border-2 border-purple-300">
                            <span class="font-bold text-purple-900">ISR Estimado (2.5%):</span>
                            <span class="font-bold text-xl text-purple-900" id="isrAmount">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl overflow-hidden">
                <div class="p-4 border-b border-gray-200">
                    <h3 class="font-bold text-brand-800">Detalle de Ventas del Período Analizado</h3>
                    <p class="text-sm text-gray-500 mt-1">Haz clic en una venta "Mixta" para ver el desglose por tipo de IVA</p>
                </div>
                <div class="overflow-x-auto max-h-96 overflow-y-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left">Folio</th>
                                <th class="px-4 py-3 text-left">Fecha</th>
                                <th class="px-4 py-3 text-left">Productos</th>
                                <th class="px-4 py-3 text-center">Tipo IVA</th>
                                <th class="px-4 py-3 text-right">Subtotal</th>
                                <th class="px-4 py-3 text-right">IVA</th>
                                <th class="px-4 py-3 text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody id="taxSalesDetailTable" class="divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Employees Module -->
        <div id="employees" class="module hidden fade-in admin-only-content">
            <div class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-serif font-bold text-brand-900 mb-2">Empleados</h1>
                    <p class="text-gray-600">Personal de Dulce Bocado</p>
                </div>
                <button onclick="openEmployeeModal()" class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded-lg transition-colors shadow-lg">
                    <i class="fas fa-plus mr-2"></i>Agregar Empleado
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass-panel p-6 rounded-2xl">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center text-orange-600">
                            <i class="fas fa-bread-slice"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-gray-800">Producción</h3>
                            <p class="text-xs text-gray-500" id="countProduction">0 empleados</p>
                        </div>
                    </div>
                    <div id="productionEmployees" class="space-y-3"></div>
                </div>

                <div class="glass-panel p-6 rounded-2xl">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center text-pink-600">
                            <i class="fas fa-headset"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-gray-800">Atención a Clientes</h3>
                            <p class="text-xs text-gray-500" id="countService">0 empleados</p>
                        </div>
                    </div>
                    <div id="serviceEmployees" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <!-- NOMINA MODULE -->
        <div id="nomina" class="module hidden fade-in admin-only-content">
            <div class="mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-serif font-bold text-brand-900 mb-2">Nómina</h1>
                    <p class="text-gray-600">Gestión de pagos y sueldos</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="generateNominaReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors shadow-lg">
                        <i class="fas fa-file-pdf mr-2"></i>Reporte Mensual
                    </button>
                    <button onclick="openNominaModal()" class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded-lg transition-colors shadow-lg">
                        <i class="fas fa-plus mr-2"></i>Registrar Pago
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="nomina-card p-4 rounded-xl text-white">
                    <p class="text-xs opacity-80 uppercase">Total Nómina Mes</p>
                    <h4 class="text-xl font-bold" id="totalNominaMes">$0.00</h4>
                </div>
                <div class="glass-panel p-4 rounded-xl border-l-4 border-green-500">
                    <p class="text-xs text-gray-500 uppercase">Sueldos Base</p>
                    <h4 class="text-lg font-bold text-gray-800" id="totalSueldos">$0.00</h4>
                </div>
                <div class="glass-panel p-4 rounded-xl border-l-4 border-yellow-500">
                    <p class="text-xs text-gray-500 uppercase">Horas Extras</p>
                    <h4 class="text-lg font-bold text-gray-800" id="totalHorasExtras">$0.00</h4>
                </div>
                <div class="glass-panel p-4 rounded-xl border-l-4 border-purple-500">
                    <p class="text-xs text-gray-500 uppercase">Bonos y Puntualidad</p>
                    <h4 class="text-lg font-bold text-gray-800" id="totalBonos">$0.00</h4>
                </div>
            </div>

            <div class="glass-panel rounded-2xl overflow-hidden">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center flex-wrap gap-4">
                    <h3 class="font-bold text-brand-800">Historial de Pagos</h3>
                    <div class="flex gap-2">
                        <select id="nominaFilterMonth" onchange="loadNomina()" class="border border-gray-300 rounded-lg px-3 py-1 text-sm">
                            <option value="all">Todos los meses</option>
                            <option value="0">Enero</option>
                            <option value="1">Febrero</option>
                            <option value="2">Marzo</option>
                            <option value="3">Abril</option>
                            <option value="4">Mayo</option>
                            <option value="5">Junio</option>
                            <option value="6">Julio</option>
                            <option value="7">Agosto</option>
                            <option value="8">Septiembre</option>
                            <option value="9">Octubre</option>
                            <option value="10">Noviembre</option>
                            <option value="11">Diciembre</option>
                        </select>
                        <select id="nominaFilterEmployee" onchange="loadNomina()" class="border border-gray-300 rounded-lg px-3 py-1 text-sm">
                            <option value="all">Todos los empleados</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="px-4 py-3 text-left">Fecha</th>
                                <th class="px-4 py-3 text-left">Empleado</th>
                                <th class="px-4 py-3 text-right">Sueldo Base</th>
                                <th class="px-4 py-3 text-center">Horas Extras</th>
                                <th class="px-4 py-3 text-right">Pago H.E.</th>
                                <th class="px-4 py-3 text-right">Bono</th>
                                <th class="px-4 py-3 text-right">Bono Punt.</th>
                                <th class="px-4 py-3 text-right">Total</th>
                                <th class="px-4 py-3 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="nominaTableBody" class="divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mt-6 glass-panel p-6 rounded-2xl">
                <h3 class="text-lg font-bold text-brand-800 mb-4">Resumen por Empleado (Mes Actual)</h3>
                <div id="nominaResumenEmpleados" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </div>
            </div>
        </div>

    </main>
</div>

<!-- MODALES -->

<!-- Modal para seleccionar tipo de gasto -->
<div id="expenseTypeModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 shadow-2xl">
        <h3 class="text-xl font-bold text-brand-800 mb-4">¿Cómo deseas registrar el gasto?</h3>
        <div class="grid grid-cols-1 gap-4">
            <button onclick="openOCRExpenseModal()" class="p-6 border-2 border-blue-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all text-left group">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 group-hover:bg-blue-200">
                        <i class="fas fa-camera text-xl"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-800">Con Ticket (OCR)</h4>
                        <p class="text-sm text-gray-500">Toma foto o sube imagen del ticket. El sistema extraerá los datos automáticamente.</p>
                    </div>
                </div>
            </button>
            <button onclick="openManualExpenseModal()" class="p-6 border-2 border-red-200 rounded-xl hover:border-red-500 hover:bg-red-50 transition-all text-left group">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center text-red-600 group-hover:bg-red-200">
                        <i class="fas fa-edit text-xl"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-800">Manual</h4>
                        <p class="text-sm text-gray-500">Registra el gasto manualmente sin subir imagen.</p>
                    </div>
                </div>
            </button>
        </div>
        <button onclick="closeModal('expenseTypeModal')" class="w-full mt-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
    </div>
</div>

<!-- Modal para Gasto con OCR -->
<div id="ocrExpenseModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-4xl mx-4 shadow-2xl max-h-[95vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-brand-800">
                <i class="fas fa-camera mr-2"></i>Nuevo Gasto con Ticket
            </h3>
            <button onclick="closeModal('ocrExpenseModal')" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Paso 1: Subir imagen -->
        <div id="ocrStep1" class="space-y-4">
            <div class="drop-zone" id="dropZone" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <input type="file" id="ticketImageInput" accept="image/*" class="hidden" onchange="handleImageSelect(event)">
                <div class="text-center">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                    <p class="text-gray-600 mb-2">Arrastra una imagen aquí o</p>
                    <button onclick="document.getElementById('ticketImageInput').click()" class="bg-brand-600 text-white px-4 py-2 rounded-lg hover:bg-brand-700 transition-colors">
                        Seleccionar archivo
                    </button>
                    <p class="text-xs text-gray-400 mt-2">Soporta: JPG, PNG, WEBP</p>
                </div>
            </div>
            <div class="text-center">
                <p class="text-sm text-gray-500 mb-2">O toma una foto directamente:</p>
                <button onclick="startCamera()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-camera mr-2"></i>Abrir Cámara
                </button>
            </div>
        </div>

        <!-- Paso 2: Vista previa y procesamiento -->
        <div id="ocrStep2" class="hidden space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h4 class="font-bold text-gray-700 mb-2">Imagen del Ticket:</h4>
                    <div class="relative">
                        <img id="ticketPreview" class="w-full rounded-lg border border-gray-200 max-h-64 object-contain">
                        <button onclick="retakePhoto()" class="absolute top-2 right-2 bg-red-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-600">
                            <i class="fas fa-redo mr-1"></i>Reintentar
                        </button>
                    </div>
                </div>
                <div>
                    <h4 class="font-bold text-gray-700 mb-2">Progreso OCR:</h4>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex items-center gap-2 mb-2">
                            <div id="ocrStatusIcon" class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center">
                                <i class="fas fa-spinner fa-spin text-yellow-600"></i>
                            </div>
                            <span id="ocrStatusText" class="text-sm font-medium">Procesando imagen...</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="ocrProgressBar" class="bg-brand-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                        <p id="ocrConfidence" class="text-xs text-gray-500 mt-2">Confianza: --%</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Paso 3: Edición de datos extraídos -->
        <div id="ocrStep3" class="hidden space-y-4">
            <div id="ocrWarning" class="hidden bg-yellow-50 border border-yellow-200 p-3 rounded-lg">
                <div class="flex items-center gap-2 text-yellow-800">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span class="text-sm font-medium">Baja confianza en el OCR. Por favor verifica los datos.</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Número de Ticket</label>
                    <input type="text" id="ocrTicketNumber" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                    <input type="date" id="ocrTicketDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Hora</label>
                    <input type="time" id="ocrTicketTime" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Área</label>
                <select id="ocrExpenseArea" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    <option value="produccion">Producción</option>
                    <option value="atencion">Atención a Clientes</option>
                    <option value="administrativo">Administrativo</option>
                    <option value="otros">Otros</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Método de Pago</label>
                <select id="ocrExpenseMethod" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    <option value="efectivo">Efectivo</option>
                    <option value="transferencia">Transferencia</option>
                    <option value="tarjeta">Tarjeta</option>
                </select>
            </div>

            <div>
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-sm font-medium text-gray-700">Items detectados:</label>
                    <span class="text-xs text-gray-500">Marca los que llevan IVA (16% incluido)</span>
                </div>
                <div id="ocrItemsList" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- Items se insertan aquí dinámicamente -->
                </div>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-600">Subtotal:</span>
                    <span id="ocrSubtotal" class="font-medium">$0.00</span>
                </div>
                <div class="flex justify-between items-center mb-2 text-blue-600">
                    <span class="text-gray-600">IVA (16%):</span>
                    <span id="ocrIVA" class="font-medium">$0.00</span>
                </div>
                <div class="flex justify-between items-center pt-2 border-t border-gray-200">
                    <span class="font-bold text-lg">Total:</span>
                    <span id="ocrTotal" class="font-bold text-xl text-brand-800">$0.00</span>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeModal('ocrExpenseModal')" class="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
                <button onclick="saveOCRExpense()" class="flex-1 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition-colors">
                    <i class="fas fa-save mr-2"></i>Guardar Gasto
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Gasto Manual -->
<div id="manualExpenseModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 shadow-2xl">
        <h3 class="text-xl font-bold text-brand-800 mb-4">
            <i class="fas fa-edit mr-2"></i>Registro Manual de Gasto
        </h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Área *</label>
                <select id="manualExpenseArea" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    <option value="produccion">Producción</option>
                    <option value="atencion">Atención a Clientes</option>
                    <option value="administrativo">Administrativo</option>
                    <option value="otros">Otros</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Concepto/Descripción *</label>
                <input type="text" id="manualExpenseConcept" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Ej: Pago de servicios">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Monto Total ($) *</label>
                <input type="number" id="manualExpenseAmount" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="0.00" step="0.01">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Método de Pago</label>
                <select id="manualExpenseMethod" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    <option value="efectivo">Efectivo</option>
                    <option value="transferencia">Transferencia</option>
                    <option value="tarjeta">Tarjeta</option>
                </select>
            </div>
            <div class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg">
                <input type="checkbox" id="manualExpenseHasIVA" class="w-4 h-4 text-brand-600 rounded" onchange="updateManualExpenseDisplay()">
                <label for="manualExpenseHasIVA" class="text-sm text-gray-700">¿Incluye IVA (16%)?</label>
            </div>
            <div id="manualExpenseBreakdown" class="hidden text-sm bg-blue-50 p-3 rounded-lg">
                <div class="flex justify-between text-gray-600">
                    <span>Subtotal:</span>
                    <span id="manualSubtotal">$0.00</span>
                </div>
                <div class="flex justify-between text-blue-600">
                    <span>IVA (16%):</span>
                    <span id="manualIVA">$0.00</span>
                </div>
                <div class="flex justify-between font-bold text-gray-800 pt-1 border-t border-blue-200 mt-1">
                    <span>Total:</span>
                    <span id="manualTotalDisplay">$0.00</span>
                </div>
            </div>
        </div>
        <div class="flex gap-3 mt-6">
            <button onclick="closeModal('manualExpenseModal')" class="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
            <button onclick="saveManualExpense()" class="flex-1 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition-colors">Guardar</button>
        </div>
    </div>
</div>

<!-- Modal de Edición de Gasto -->
<div id="editExpenseModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-4xl mx-4 shadow-2xl max-h-[95vh] overflow-y-auto">
        <h3 class="text-xl font-bold text-brand-800 mb-4">
            <i class="fas fa-edit mr-2"></i>Editar Gasto
        </h3>
        <input type="hidden" id="editExpenseId">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Área</label>
                <select id="editExpenseArea" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    <option value="produccion">Producción</option>
                    <option value="atencion">Atención a Clientes</option>
                    <option value="administrativo">Administrativo</option>
                    <option value="otros">Otros</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Método de Pago</label>
                <select id="editExpenseMethod" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    <option value="efectivo">Efectivo</option>
                    <option value="transferencia">Transferencia</option>
                    <option value="tarjeta">Tarjeta</option>
                </select>
            </div>
        </div>

        <div id="editExpenseHasItems" class="hidden">
            <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg mb-4">
                <p class="text-sm text-yellow-800">
                    <i class="fas fa-info-circle mr-1"></i>
                    Este gasto fue creado desde un ticket. Solo puedes modificar el área y el IVA de los items. El total no puede cambiar.
                </p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Items (marca los que llevan IVA):</label>
                <div id="editItemsList" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- Items se insertan aquí -->
                </div>
            </div>
        </div>

        <div id="editExpenseNoItems">
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <p class="text-sm text-gray-600">Concepto: <span id="editExpenseConcept" class="font-medium"></span></p>
                <p class="text-sm text-gray-600">Total: <span id="editExpenseTotal" class="font-bold text-brand-800"></span></p>
            </div>
        </div>

        <div class="flex gap-3 mt-6">
            <button onclick="closeModal('editExpenseModal')" class="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
            <button onclick="saveEditedExpense()" class="flex-1 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition-colors">
                <i class="fas fa-save mr-2"></i>Guardar Cambios
            </button>
        </div>
    </div>
</div>

<!-- Modal de Ver OCR -->
<div id="viewOCRModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-2xl mx-4 shadow-2xl">
        <h3 class="text-xl font-bold text-brand-800 mb-4">
            <i class="fas fa-file-alt mr-2"></i>Texto OCR Original
        </h3>
        <div class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm max-h-96 overflow-y-auto" id="ocrRawText">
        </div>
        <button onclick="closeModal('viewOCRModal')" class="w-full mt-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">Cerrar</button>
    </div>
</div>

<!-- Modal de Desglose -->
<div id="expenseBreakdownModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-2xl mx-4 shadow-2xl">
        <h3 class="text-xl font-bold text-brand-800 mb-4">
            <i class="fas fa-list-alt mr-2"></i>Desglose del Gasto
        </h3>
        <div id="expenseBreakdownContent" class="space-y-2 max-h-96 overflow-y-auto">
        </div>
        <button onclick="closeModal('expenseBreakdownModal')" class="w-full mt-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">Cerrar</button>
    </div>
</div>

<!-- Modal de Reportes de Gastos -->
<div id="expenseReportsModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-4xl mx-4 shadow-2xl max-h-[95vh] overflow-y-auto">
        <h3 class="text-xl font-bold text-brand-800 mb-4">
            <i class="fas fa-chart-bar mr-2"></i>Reportes de Gastos
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Desde</label>
                <input type="date" id="reportDateFrom" class="w-full border border-gray-300 rounded-lg px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Hasta</label>
                <input type="date" id="reportDateTo" class="w-full border border-gray-300 rounded-lg px-3 py-2">
            </div>
            <div class="flex items-end">
                <button onclick="generateExpenseReport()" class="w-full bg-brand-600 text-white py-2 rounded-lg hover:bg-brand-700">
                    <i class="fas fa-search mr-2"></i>Generar
                </button>
            </div>
        </div>

        <div id="expenseReportResults" class="space-y-6">
            <!-- Resultados se insertan aquí -->
        </div>

        <button onclick="closeModal('expenseReportsModal')" class="w-full mt-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cerrar</button>
    </div>
</div>

<!-- Modales existentes (mantenidos del código original) -->
<div id="customProductModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 shadow-2xl">
        <h3 class="text-xl font-bold text-brand-800 mb-4">Pastel Personalizado</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                <textarea id="customDesc" rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Ej: Pastel 3 pisos, fondant rosa..."></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Precio Final (IVA incluido si aplica) ($)</label>
                <input type="number" id="customPrice" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="0.00">
            </div>
            <div class="flex items-center gap-2">
                <input type="checkbox" id="customIVA" class="w-4 h-4 text-brand-600 rounded">
                <label for="customIVA" class="text-sm text-gray-700">Precio ya incluye IVA (16%)</label>
            </div>
        </div>
        <div class="flex gap-3 mt-6">
            <button onclick="closeModal('customProductModal')" class="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
            <button onclick="addCustomProduct()" class="flex-1 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition-colors">Agregar</button>
        </div>
    </div>
</div>

<div id="mixedPaymentModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 shadow-2xl">
        <h3 class="text-xl font-bold text-purple-800 mb-4">
            <i class="fas fa-calculator mr-2"></i>Pago Mixto
        </h3>
        <div class="space-y-4 mb-4">
            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Efectivo</label>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-gray-500">$</span>
                    <input type="number" id="mixedPaymentCash" class="w-24 border border-gray-300 rounded-lg px-3 py-2 text-right focus:ring-2 focus:ring-green-500 outline-none" placeholder="0.00" step="0.01" oninput="validateMixedPayment()">
                </div>
            </div>

            <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Transferencia</label>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-gray-500">$</span>
                    <input type="number" id="mixedPaymentTransfer" class="w-24 border border-gray-300 rounded-lg px-3 py-2 text-right focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0.00" step="0.01" oninput="validateMixedPayment()">
                </div>
            </div>

            <div class="flex items-center justify-between p-3 bg-purple-50 rounded-lg">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center text-white">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tarjeta</label>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-gray-500">$</span>
                    <input type="number" id="mixedPaymentCard" class="w-24 border border-gray-300 rounded-lg px-3 py-2 text-right focus:ring-2 focus:ring-purple-500 outline-none" placeholder="0.00" step="0.01" oninput="validateMixedPayment()">
                </div>
            </div>
        </div>

        <div class="bg-gray-50 p-4 rounded-lg mb-4">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm text-gray-600">Total a Pagar:</span>
                <span class="font-bold text-lg" id="mixedPaymentTotalRequired">$0.00</span>
            </div>
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm text-gray-600">Total Distribuido:</span>
                <span class="font-bold text-lg" id="mixedPaymentDistributed">$0.00</span>
            </div>
            <div class="flex justify-between items-center pt-2 border-t border-gray-200">
                <span class="text-sm font-medium" id="mixedPaymentDiffLabel">Diferencia:</span>
                <span class="font-bold" id="mixedPaymentDifference">$0.00</span>
            </div>
            <div id="mixedPaymentAlert" class="hidden mt-2 p-2 bg-red-100 text-red-700 text-xs rounded text-center">
                <i class="fas fa-exclamation-circle mr-1"></i> Los montos no coinciden
            </div>
            <div id="mixedPaymentSuccess" class="hidden mt-2 p-2 bg-green-100 text-green-700 text-xs rounded text-center">
                <i class="fas fa-check-circle mr-1"></i> ¡Montos correctos!
            </div>
        </div>

        <div class="grid grid-cols-2 gap-2 mb-4">
            <button onclick="autoDistribute('half')" class="py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-xs font-medium text-gray-700 transition-colors">
                <i class="fas fa-adjust mr-1"></i>50/50
            </button>
            <button onclick="autoDistribute('thirds')" class="py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-xs font-medium text-gray-700 transition-colors">
                <i class="fas fa-chart-pie mr-1"></i>Tercios
            </button>
        </div>

        <div class="flex gap-3">
            <button onclick="closeModal('mixedPaymentModal')" class="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
            <button onclick="confirmMixedPayment()" id="btnConfirmMixed" class="flex-1 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors opacity-50 cursor-not-allowed" disabled>
                Confirmar
            </button>
        </div>
    </div>
</div>

<div id="productModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 shadow-2xl">
        <h3 class="text-xl font-bold text-brand-800 mb-4" id="productModalTitle">Nuevo Producto</h3>
        <input type="hidden" id="prodId">
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
                <input type="text" id="prodName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                <select id="prodCategory" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    <option value="pasteles">Pasteles</option>
                    <option value="postres">Postres</option>
                    <option value="decoracion">Decoración</option>
                    <option value="herramientas">Herramientas</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Precio Final ($) *</label>
                <input type="number" id="prodPrice" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" step="0.01">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Stock Actual</label>
                <input type="number" id="prodStock" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
            </div>
            <div class="flex items-center gap-2">
                <input type="checkbox" id="prodIVA" class="w-4 h-4 text-brand-600 rounded">
                <label for="prodIVA" class="text-sm text-gray-700">Precio incluye IVA (16%)</label>
            </div>
        </div>
        <div class="flex gap-3 mt-6">
            <button onclick="closeModal('productModal')" class="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
            <button onclick="saveProduct()" class="flex-1 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition-colors">Guardar</button>
        </div>
    </div>
</div>

<div id="stockModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-sm mx-4 shadow-2xl">
        <h3 class="text-xl font-bold text-brand-800 mb-4">Ajustar Stock</h3>
        <input type="hidden" id="stockProdId">
        <div class="text-center mb-6">
            <div class="text-4xl mb-2" id="stockProdImage">📦</div>
            <h4 class="font-bold text-lg text-gray-800" id="stockProdName">Producto</h4>
            <p class="text-sm text-gray-500" id="stockProdCurrent">Stock actual: 0</p>
        </div>
        
        <div class="flex items-center justify-center gap-4 mb-6">
            <button onclick="adjustStockPreview(-1)" class="w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-700 font-bold text-lg">-</button>
            <input type="number" id="stockNewValue" class="stock-input-cashier text-xl" value="0" min="0">
            <button onclick="adjustStockPreview(1)" class="w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-700 font-bold text-lg">+</button>
        </div>
        
        <div class="bg-blue-50 p-3 rounded-lg mb-4 text-center">
            <p class="text-xs text-blue-600">Nuevo stock: <span id="stockPreview" class="font-bold text-lg">0</span></p>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeModal('stockModal')" class="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
            <button onclick="saveStockAdjustment()" class="flex-1 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition-colors">Guardar Cambio</button>
        </div>
    </div>
</div>

<div id="employeeModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 shadow-2xl">
        <h3 class="text-xl font-bold text-brand-800 mb-4">Agregar Empleado</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo *</label>
                <input type="text" id="empName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Área *</label>
                <select id="empArea" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    <option value="produccion">Producción</option>
                    <option value="atencion">Atención a Clientes</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Puesto/Rol *</label>
                <input type="text" id="empRole" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
            </div>
        </div>
        <div class="flex gap-3 mt-6">
            <button onclick="closeModal('employeeModal')" class="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
            <button onclick="saveEmployee()" class="flex-1 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition-colors">Guardar</button>
        </div>
    </div>
</div>

<div id="nominaModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-lg mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-bold text-brand-800 mb-4">Registrar Pago de Nómina</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Empleado *</label>
                <select id="nominaEmployee" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                    <option value="">Seleccionar empleado...</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Periodo (Mes)</label>
                    <select id="nominaMonth" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none">
                        <option value="0">Enero</option>
                        <option value="1">Febrero</option>
                        <option value="2">Marzo</option>
                        <option value="3">Abril</option>
                        <option value="4">Mayo</option>
                        <option value="5">Junio</option>
                        <option value="6">Julio</option>
                        <option value="7">Agosto</option>
                        <option value="8">Septiembre</option>
                        <option value="9">Octubre</option>
                        <option value="10">Noviembre</option>
                        <option value="11">Diciembre</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Año</label>
                    <input type="number" id="nominaYear" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" value="2024">
                </div>
            </div>
            <div class="border-t pt-4">
                <h4 class="font-bold text-gray-800 mb-3">Conceptos de Pago</h4>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sueldo Base ($)</label>
                        <input type="number" id="nominaSueldo" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="0.00" oninput="calculateNominaTotal()">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Horas Extras</label>
                            <input type="number" id="nominaHorasExtras" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="0" oninput="calculateNominaTotal()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pago por Hora ($)</label>
                            <input type="number" id="nominaPagoHoraExtra" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="0.00" oninput="calculateNominaTotal()">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bono Productividad ($)</label>
                            <input type="number" id="nominaBono" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="0.00" oninput="calculateNominaTotal()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bono Puntualidad ($)</label>
                            <input type="number" id="nominaBonoPuntualidad" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="0.00" oninput="calculateNominaTotal()">
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-brand-50 p-4 rounded-lg border-2 border-brand-200">
                <div class="flex justify-between items-center">
                    <span class="font-bold text-brand-800">TOTAL A PAGAR:</span>
                    <span class="text-2xl font-bold text-brand-800" id="nominaTotal">$0.00</span>
                </div>
            </div>
        </div>
        <div class="flex gap-3 mt-6">
            <button onclick="closeModal('nominaModal')" class="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
            <button onclick="saveNomina()" class="flex-1 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition-colors">Guardar Pago</button>
        </div>
    </div>
</div>

<div id="cutModal" class="modal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-lg mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-brand-100 rounded-full mx-auto mb-3 flex items-center justify-center text-brand-600 text-2xl">
                <i class="fas fa-cut"></i>
            </div>
            <h3 class="text-2xl font-bold text-brand-800">Corte del Día</h3>
            <p class="text-gray-500" id="cutDate"></p>
        </div>

        <div class="space-y-4 mb-6">
            <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                <span class="text-green-800">Ventas Reales:</span>
                <span class="font-bold text-green-900" id="cutTotal">$0.00</span>
            </div>
            <div class="grid grid-cols-3 gap-2 text-center">
                <div class="p-2 bg-gray-50 rounded">
                    <p class="text-xs text-gray-500">Efectivo</p>
                    <p class="font-bold text-gray-800" id="cutCash">$0</p>
                </div>
                <div class="p-2 bg-gray-50 rounded">
                    <p class="text-xs text-gray-500">Transfer</p>
                    <p class="font-bold text-gray-800" id="cutTransfer">$0</p>
                </div>
                <div class="p-2 bg-gray-50 rounded">
                    <p class="text-xs text-gray-500">Tarjeta</p>
                    <p class="font-bold text-gray-800" id="cutCard">$0</p>
                </div>
            </div>
            <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                <span class="text-blue-800">IVA Generado:</span>
                <span class="font-bold text-blue-900" id="cutIVA">$0.00</span>
            </div>
            <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                <span class="text-purple-800">Transacciones:</span>
                <span class="font-bold text-purple-900" id="cutTransactions">0</span>
            </div>
            <div id="cutCancelledSection" class="hidden flex justify-between items-center p-3 bg-red-50 rounded-lg border border-red-200">
                <span class="text-red-800">Ventas Canceladas:</span>
                <span class="font-bold text-red-900" id="cutCancelledAmount">$0.00</span>
            </div>
        </div>

        <div class="border-t pt-4">
            <h4 class="font-bold text-gray-800 mb-2">Desglose de Ventas:</h4>
            <div id="cutDetails" class="text-sm space-y-1 max-h-40 overflow-y-auto"></div>
        </div>

        <button onclick="closeModal('cutModal')" class="w-full mt-6 py-3 bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition-colors">
            Cerrar
        </button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // ============================================
    // CONFIGURACIÓN SUPABASE
    // ============================================
    const SUPABASE_URL = 'https://qvisoofgwuuhfnbzytnb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2aXNvb2Znd3V1aGZuYnp5dG5iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzODE4MDAsImV4cCI6MjA4Njk1NzgwMH0.816vyiAx3RBlGWyyjC-4AU_-4yMHv0wW1g0CXqhahjs';

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Variables globales
    let currentUser = null;
    let currentProfile = null;
    let cart = [];
    let currentPaymentMethod = 'efectivo';
    let mixedPaymentData = { efectivo: 0, transferencia: 0, tarjeta: 0 };
    let isMixedPayment = false;
    let products = [];
    let employees = [];
    let salesChartInstance = null;
    let expensesChartInstance = null;
    let currentProductFilter = 'all';
    let deferredPrompt = null;
    let isSidebarMini = false;
    let expandedSales = new Set();

    // Variables para el sistema de gastos
    let currentOCRData = null;
    let productLearningData = {};
    let currentExpenseItems = [];

    // ============================================
    // PWA - SERVICE WORKER & INSTALL
    // ============================================
    
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
            const CACHE_NAME = 'dulce-bocado-v1';
            const urlsToCache = [
                '/',
                'https://cdn.tailwindcss.com',
                'https://unpkg.com/@supabase/supabase-js@2',
                'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css',
                'https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap',
                'https://cdn.jsdelivr.net/npm/chart.js',
                'https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js'
            ];

            self.addEventListener('install', event => {
                event.waitUntil(
                    caches.open(CACHE_NAME)
                        .then(cache => cache.addAll(urlsToCache))
                );
            });

            self.addEventListener('fetch', event => {
                event.respondWith(
                    caches.match(event.request)
                        .then(response => {
                            if (response) return response;
                            return fetch(event.request);
                        })
                );
            });
        `)).then(registration => {
            console.log('Service Worker registrado:', registration);
        }).catch(error => {
            console.log('Error al registrar Service Worker:', error);
        });
    }

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('installPWA').style.display = 'block';
    });

    function installApp() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('Usuario aceptó instalar la PWA');
                    document.getElementById('installPWA').style.display = 'none';
                }
                deferredPrompt = null;
            });
        }
    }

    // ============================================
    // AUTENTICACIÓN
    // ============================================
    
    function showRegisterForm() {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('registerForm').classList.remove('hidden');
    }

    function showLoginForm() {
        document.getElementById('registerForm').classList.add('hidden');
        document.getElementById('loginForm').classList.remove('hidden');
    }

    async function register() {
        const email = document.getElementById('regEmail').value;
        const password = document.getElementById('regPassword').value;
        const name = document.getElementById('regName').value;
        const role = document.getElementById('regRole').value;

        if (!email || !password || !name) {
            alert('Complete todos los campos');
            return;
        }

        try {
            const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                email,
                password
            });

            if (authError) throw authError;

            const { error: profileError } = await supabaseClient
                .from('profiles')
                .insert([{
                    id: authData.user.id,
                    username: email,
                    role: role,
                    full_name: name
                }]);

            if (profileError) throw profileError;

            alert('Cuenta creada exitosamente. Ahora puedes iniciar sesión.');
            showLoginForm();
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function login() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        try {
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email,
                password
            });

            if (error) throw error;

            await initializeApp();
        } catch (error) {
            alert('Error de inicio de sesión: ' + error.message);
        }
    }

    async function logout() {
        await supabaseClient.auth.signOut();
        location.reload();
    }

    async function checkSession() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
            await initializeApp();
        }
    }

    // ============================================
    // INICIALIZACIÓN
    // ============================================

    async function initializeApp() {
        try {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) return;

            const { data: profile, error } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .single();

            if (error) throw error;

            currentUser = user;
            currentProfile = profile;

            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('currentUserName').textContent = profile.full_name || profile.username;
            document.getElementById('currentUserRole').textContent = profile.role === 'admin' ? 'Administrador' : 'Cajero';

            if (profile.role === 'cashier') {
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = 'none';
                });
                document.querySelectorAll('.admin-only-inline').forEach(el => {
                    el.style.display = 'none';
                });
                document.querySelectorAll('.admin-only-content').forEach(el => {
                    el.classList.add('hidden');
                });
                
                document.getElementById('expensesMenuText').textContent = 'Mis Gastos';
                document.getElementById('adminExpenseStats').classList.add('hidden');
                document.getElementById('expenseFilterLabel').classList.remove('hidden');
                document.getElementById('expensesTableTitle').textContent = 'Mis Gastos Registrados';
                
                showModule('pos');
            } else {
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = '';
                });
                document.querySelectorAll('.admin-only-inline').forEach(el => {
                    el.style.display = '';
                });
                document.querySelectorAll('.admin-only-content').forEach(el => {
                    el.classList.remove('hidden');
                });
                
                showModule('dashboard');
            }

            await loadProducts();
            await loadEmployees();
            await updateDashboard();
            await loadTodaySales();
            await loadProductLearningData();
            
            setupRealtimeSubscriptions();
            
        } catch (error) {
            console.error('Error initializing:', error);
            alert('Error al inicializar la aplicación');
        }
    }

    function setupRealtimeSubscriptions() {
        supabaseClient
            .channel('sales_changes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'sales' }, payload => {
                if (currentProfile?.role === 'admin') {
                    updateDashboard();
                    loadTodaySales();
                }
            })
            .subscribe();
    }

    // ============================================
    // NAVEGACIÓN
    // ============================================

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const toggleIcon = document.getElementById('toggleIcon');
        
        isSidebarMini = !isSidebarMini;
        
        if (isSidebarMini) {
            sidebar.classList.add('mini');
            toggleIcon.classList.remove('fa-chevron-left');
            toggleIcon.classList.add('fa-chevron-right');
        } else {
            sidebar.classList.remove('mini');
            toggleIcon.classList.remove('fa-chevron-right');
            toggleIcon.classList.add('fa-chevron-left');
        }
    }

    async function showModule(moduleName) {
        if (currentProfile?.role === 'cashier') {
            const allowedModules = ['pos', 'salesHistory', 'expenses', 'products'];
            if (!allowedModules.includes(moduleName)) {
                alert('No tienes permisos para acceder a esta sección');
                return;
            }
        }
        
        document.querySelectorAll('.module').forEach(m => m.classList.add('hidden'));
        document.getElementById(moduleName).classList.remove('hidden');
        
        switch(moduleName) {
            case 'pos': await loadProducts(); break;
            case 'salesHistory': await loadTodaySales(); break;
            case 'expenses': await loadExpenses(); break;
            case 'products': await loadProductsTable(); break;
            case 'bank': await updateBankModule(); break;
            case 'taxes': setTaxPeriodThisMonth(); break;
            case 'employees': await loadEmployees(); break;
            case 'nomina': await loadNomina(); break;
            case 'dashboard': await updateDashboard(); break;
        }
        
        if (window.innerWidth < 768 && !isSidebarMini) {
            toggleSidebar();
        }
    }

    // ============================================
    // DASHBOARD
    // ============================================

    async function updateDashboard() {
        try {
            const today = new Date().toISOString().split('T')[0];
            
            const { data: todaySales } = await supabaseClient
                .from('sales')
                .select('*')
                .gte('created_at', today)
                .eq('cancelled', false);

            const { data: todayCancelled } = await supabaseClient
                .from('sales')
                .select('*')
                .gte('created_at', today)
                .eq('cancelled', true);

            const todayTotal = todaySales?.reduce((sum, s) => sum + s.total, 0) || 0;
            const cancelledTotal = todayCancelled?.reduce((sum, s) => sum + s.total, 0) || 0;
            
            document.getElementById('dashboardTodaySales').textContent = formatMoney(todayTotal);
            
            const cancelledAlert = document.getElementById('cancelledAlert');
            if (todayCancelled?.length > 0) {
                cancelledAlert.classList.remove('hidden');
                document.getElementById('cancelledAmount').textContent = formatMoney(cancelledTotal);
                document.getElementById('cancelledCount').textContent = todayCancelled.length;
                document.getElementById('salesStatus').innerHTML = `<i class="fas fa-exclamation-circle text-red-500"></i> ${todayCancelled.length} venta(s) cancelada(s)`;
                document.getElementById('salesStatus').className = 'text-xs text-red-600 mt-2';
            } else {
                cancelledAlert.classList.add('hidden');
                document.getElementById('salesStatus').innerHTML = '<i class="fas fa-check-circle"></i> Sin cancelaciones';
                document.getElementById('salesStatus').className = 'text-xs text-green-600 mt-2';
            }
            
            const firstDayOfMonth = new Date();
            firstDayOfMonth.setDate(1);
            
            const { data: monthSales } = await supabaseClient
                .from('sales')
                .select('total, iva')
                .gte('created_at', firstDayOfMonth.toISOString())
                .eq('cancelled', false);

            const ivaTotal = monthSales?.reduce((sum, s) => sum + s.iva, 0) || 0;
            document.getElementById('dashboardIVA').textContent = formatMoney(ivaTotal);
            
            const totalIncome = monthSales?.reduce((sum, s) => sum + s.total, 0) || 0;
            const isr = totalIncome * 0.025;
            document.getElementById('dashboardISR').textContent = formatMoney(isr);

            const { data: monthExpenses } = await supabaseClient
                .from('expenses')
                .select('amount')
                .gte('created_at', firstDayOfMonth.toISOString());

            const totalExpenses = monthExpenses?.reduce((sum, e) => sum + e.amount, 0) || 0;
            document.getElementById('dashboardExpenses').textContent = formatMoney(totalExpenses);
            
            const { data: recentSales } = await supabaseClient
                .from('sales')
                .select('*')
                .eq('cancelled', false)
                .order('created_at', { ascending: false })
                .limit(5);

            const { data: recentExpenses } = await supabaseClient
                .from('expenses')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(5);

            const recent = [
                ...(recentSales || []).map(s => ({...s, type: 'sale'})), 
                ...(recentExpenses || []).map(e => ({...e, type: 'expense'}))
            ].sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 5);
            
            const tbody = document.getElementById('recentActivityTable');
            tbody.innerHTML = recent.map(item => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-4 py-3 text-gray-600">${new Date(item.created_at).toLocaleDateString()}</td>
                    <td class="px-4 py-3 font-medium">${item.type === 'sale' ? 'Venta' : (item.concept || 'Gasto')}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs ${item.type === 'sale' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            ${item.type === 'sale' ? 'Ingreso' : 'Egreso'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-right font-bold ${item.type === 'sale' ? 'text-green-600' : 'text-red-600'}">
                        ${item.type === 'sale' ? '+' : '-'}${formatMoney(item.total || item.amount)}
                    </td>
                </tr>
            `).join('');

            if (currentProfile?.role === 'admin') {
                await initCharts();
            }
            
        } catch (error) {
            console.error('Error updating dashboard:', error);
        }
    }

    async function initCharts() {
        try {
            const last7Days = Array.from({length: 7}, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (6 - i));
                return d.toISOString().split('T')[0];
            });

            const { data: salesData } = await supabaseClient
                .from('sales')
                .select('total, created_at')
                .eq('cancelled', false)
                .gte('created_at', last7Days[0]);

            const { data: expensesData } = await supabaseClient
                .from('expenses')
                .select('amount, created_at')
                .gte('created_at', last7Days[0]);

            const dailySales = last7Days.map(date => {
                return salesData
                    ?.filter(s => s.created_at.startsWith(date))
                    .reduce((sum, s) => sum + s.total, 0) || 0;
            });

            const dailyExpenses = last7Days.map(date => {
                return expensesData
                    ?.filter(e => e.created_at.startsWith(date))
                    .reduce((sum, e) => sum + e.amount, 0) || 0;
            });

            const ctx1 = document.getElementById('salesChart');
            if (ctx1) {
                if (salesChartInstance) salesChartInstance.destroy();
                salesChartInstance = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: last7Days.map(d => new Date(d).toLocaleDateString('es', {weekday: 'short'})),
                        datasets: [{
                            label: 'Ventas',
                            data: dailySales,
                            borderColor: '#a77f70',
                            backgroundColor: 'rgba(167, 127, 112, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'Gastos',
                            data: dailyExpenses,
                            borderColor: '#e83e5f',
                            backgroundColor: 'rgba(232, 62, 95, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }

            const { data: allExpenses } = await supabaseClient
                .from('expenses')
                .select('area, amount');

            const areaTotals = ['produccion', 'atencion', 'administrativo', 'otros'].map(area => {
                return allExpenses
                    ?.filter(e => e.area === area)
                    .reduce((sum, e) => sum + e.amount, 0) || 0;
            });

            const ctx2 = document.getElementById('expensesChart');
            if (ctx2) {
                if (expensesChartInstance) expensesChartInstance.destroy();
                expensesChartInstance = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['Producción', 'Atención', 'Administrativo', 'Otros'],
                        datasets: [{
                            data: areaTotals,
                            backgroundColor: ['#f97316', '#3b82f6', '#eab308', '#a855f7']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }
        } catch (error) {
            console.error('Error initializing charts:', error);
        }
    }

    // ============================================
    // PRODUCTOS (POS)
    // ============================================

    async function loadProducts(filter = 'all') {
        try {
            currentProductFilter = filter;
            const { data, error } = await supabaseClient
                .from('products')
                .select('*')
                .eq('is_active', true)
                .order('name');

            if (error) throw error;
            products = data || [];

            renderProductsGrid(products, filter);
        } catch (error) {
            console.error('Error loading products:', error);
        }
    }

    function renderProductsGrid(productsToRender, filter = 'all') {
        const grid = document.getElementById('productsGrid');
        let filtered = productsToRender;
        
        if (filter !== 'all') {
            filtered = productsToRender.filter(p => p.category === filter);
        }
        
        filtered.sort((a, b) => {
            if (a.stock > 0 && b.stock <= 0) return -1;
            if (a.stock <= 0 && b.stock > 0) return 1;
            return a.name.localeCompare(b.name);
        });
        
        grid.innerHTML = filtered.map(p => {
            const hasStock = p.stock > 0;
            const stockClass = p.stock > 10 ? 'high' : p.stock > 0 ? 'low' : 'none';
            const stockText = p.stock > 0 ? `Stock: ${p.stock}` : 'Agotado';
            
            return `
                <div onclick="${hasStock ? `addToCart('${p.id}')` : ''}" 
                     class="product-card ${hasStock ? 'has-stock' : 'no-stock'} bg-white p-4 rounded-xl shadow-md hover:shadow-xl transition-all cursor-pointer transform hover:scale-105 border-2 border-transparent hover:border-brand-300 relative">
                    
                    ${hasStock ? `<span class="stock-badge ${stockClass}">${stockText}</span>` : '<span class="stock-badge none">AGOTADO</span>'}
                    
                    <div class="text-4xl mb-2 text-center">${p.image || '📦'}</div>
                    <h4 class="font-bold text-gray-800 text-sm mb-1">${p.name}</h4>
                    <p class="text-xs ${p.has_iva ? 'text-blue-600 font-medium' : 'text-gray-500'} mb-2">
                        ${p.has_iva ? 'IVA incluido' : 'Sin IVA'}
                    </p>
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-brand-700">${formatMoney(p.price)}</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    function filterProducts(category) {
        document.querySelectorAll('#pos button[onclick^="filterProducts"]').forEach(btn => {
            btn.classList.remove('bg-brand-600', 'text-white');
            btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-300');
        });
        
        event.target.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-300');
        event.target.classList.add('bg-brand-600', 'text-white');
        
        const searchValue = document.getElementById('productSearch').value.toLowerCase();
        if (searchValue) {
            filterProductsBySearch(searchValue);
        } else {
            renderProductsGrid(products, category);
        }
    }

    function filterProductsBySearch(searchTerm) {
        const term = searchTerm.toLowerCase();
        const filtered = products.filter(p => 
            p.name.toLowerCase().includes(term) || 
            p.category.toLowerCase().includes(term)
        );
        renderProductsGrid(filtered, currentProductFilter);
    }

    function addToCart(productId) {
        const product = products.find(p => p.id === productId);
        if (!product || product.stock <= 0) {
            alert('Producto sin stock disponible');
            return;
        }
        
        const existing = cart.find(item => item.id === productId);
        if (existing) {
            if (existing.quantity >= product.stock) {
                alert('No hay suficiente stock');
                return;
            }
            existing.quantity++;
        } else {
            cart.push({
                id: product.id,
                name: product.name,
                price: product.price,
                hasIVA: product.has_iva,
                image: product.image,
                quantity: 1
            });
        }
        updateCart();
    }

    function addCustomProduct() {
        const desc = document.getElementById('customDesc').value;
        const price = parseFloat(document.getElementById('customPrice').value);
        const hasIVA = document.getElementById('customIVA').checked;
        
        if (!desc || !price) {
            alert('Complete todos los campos');
            return;
        }
        
        cart.push({
            id: 'custom_' + Date.now(),
            name: desc,
            price: price,
            hasIVA: hasIVA,
            quantity: 1,
            isCustom: true
        });
        
        updateCart();
        closeModal('customProductModal');
        
        document.getElementById('customDesc').value = '';
        document.getElementById('customPrice').value = '';
        document.getElementById('customIVA').checked = false;
    }

    function updateCart() {
        const container = document.getElementById('cartItems');
        if (cart.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-400 py-8">
                    <i class="fas fa-shopping-basket text-4xl mb-2"></i>
                    <p>Carrito vacío</p>
                </div>
            `;
        } else {
            container.innerHTML = cart.map((item, index) => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                    <div class="flex-1">
                        <h4 class="font-medium text-sm text-gray-800">${item.name}</h4>
                        <p class="text-xs text-gray-500">${formatMoney(item.price)} c/u ${item.hasIVA ? '(IVA incl.)' : ''}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="updateQuantity(${index}, -1)" class="w-6 h-6 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-600">-</button>
                        <span class="font-medium w-6 text-center">${item.quantity}</span>
                        <button onclick="updateQuantity(${index}, 1)" class="w-6 h-6 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-600">+</button>
                        <button onclick="removeFromCart(${index})" class="ml-2 text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }
        calculateTotals();
    }

    function updateQuantity(index, change) {
        const item = cart[index];
        if (change > 0 && !item.isCustom) {
            const product = products.find(p => p.id === item.id);
            if (product && item.quantity >= product.stock) {
                alert('No hay suficiente stock');
                return;
            }
        }
        
        cart[index].quantity += change;
        if (cart[index].quantity <= 0) {
            cart.splice(index, 1);
        }
        updateCart();
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        updateCart();
    }

    function calculateTotals() {
        let subtotalSinIVA = 0;
        let totalIVA = 0;
        
        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            if (item.hasIVA) {
                const subtotalItem = itemTotal / 1.16;
                const ivaItem = itemTotal - subtotalItem;
                subtotalSinIVA += subtotalItem;
                totalIVA += ivaItem;
            } else {
                subtotalSinIVA += itemTotal;
            }
        });
        
        document.getElementById('cartSubtotal').textContent = formatMoney(subtotalSinIVA);
        document.getElementById('cartIVA').textContent = formatMoney(totalIVA);
        document.getElementById('cartTotal').textContent = formatMoney(subtotalSinIVA + totalIVA);
    }

    // ============================================
    // PAGO MIXTO
    // ============================================

    function setPaymentMethod(method) {
        currentPaymentMethod = method;
        isMixedPayment = false;
        mixedPaymentData = { efectivo: 0, transferencia: 0, tarjeta: 0 };
        
        document.getElementById('mixedPaymentSummary').classList.add('hidden');
        
        document.querySelectorAll('.payment-btn').forEach(btn => {
            btn.classList.remove('border-brand-500', 'bg-brand-50', 'text-brand-700', 'border-purple-500', 'bg-purple-50', 'text-purple-700');
            btn.classList.add('border-gray-300', 'text-gray-600');
        });
        
        const activeBtn = document.getElementById('btn' + method.charAt(0).toUpperCase() + method.slice(1));
        if (activeBtn) {
            activeBtn.classList.remove('border-gray-300', 'text-gray-600');
            if (method === 'mixto') {
                activeBtn.classList.add('border-purple-500', 'bg-purple-50', 'text-purple-700');
            } else {
                activeBtn.classList.add('border-brand-500', 'bg-brand-50', 'text-brand-700');
            }
        }
    }

    function openMixedPaymentModal() {
        if (cart.length === 0) {
            alert('El carrito está vacío');
            return;
        }
        
        let subtotalSinIVA = 0;
        let totalIVA = 0;
        
        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            if (item.hasIVA) {
                const subtotalItem = itemTotal / 1.16;
                const ivaItem = itemTotal - subtotalItem;
                subtotalSinIVA += subtotalItem;
                totalIVA += ivaItem;
            } else {
                subtotalSinIVA += itemTotal;
            }
        });
        
        const total = subtotalSinIVA + totalIVA;
        
        document.getElementById('mixedPaymentTotalRequired').textContent = formatMoney(total);
        document.getElementById('mixedPaymentDistributed').textContent = '$0.00';
        document.getElementById('mixedPaymentDifference').textContent = formatMoney(total);
        
        document.getElementById('mixedPaymentCash').value = '';
        document.getElementById('mixedPaymentTransfer').value = '';
        document.getElementById('mixedPaymentCard').value = '';
        
        document.getElementById('mixedPaymentAlert').classList.add('hidden');
        document.getElementById('mixedPaymentSuccess').classList.add('hidden');
        document.getElementById('btnConfirmMixed').disabled = true;
        document.getElementById('btnConfirmMixed').classList.add('opacity-50', 'cursor-not-allowed');
        
        setPaymentMethod('mixto');
        openModal('mixedPaymentModal');
    }

    function validateMixedPayment() {
        const cash = parseFloat(document.getElementById('mixedPaymentCash').value) || 0;
        const transfer = parseFloat(document.getElementById('mixedPaymentTransfer').value) || 0;
        const card = parseFloat(document.getElementById('mixedPaymentCard').value) || 0;
        
        const distributed = cash + transfer + card;
        
        let subtotalSinIVA = 0;
        let totalIVA = 0;
        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            if (item.hasIVA) {
                const subtotalItem = itemTotal / 1.16;
                const ivaItem = itemTotal - subtotalItem;
                subtotalSinIVA += subtotalItem;
                totalIVA += ivaItem;
            } else {
                subtotalSinIVA += itemTotal;
            }
        });
        const total = subtotalSinIVA + totalIVA;
        
        const difference = total - distributed;
        
        document.getElementById('mixedPaymentDistributed').textContent = formatMoney(distributed);
        document.getElementById('mixedPaymentDifference').textContent = formatMoney(Math.abs(difference));
        
        const alertBox = document.getElementById('mixedPaymentAlert');
        const successBox = document.getElementById('mixedPaymentSuccess');
        const confirmBtn = document.getElementById('btnConfirmMixed');
        
        if (Math.abs(difference) < 0.01) {
            document.getElementById('mixedPaymentDiffLabel').textContent = '¡Cuadre perfecto!';
            document.getElementById('mixedPaymentDiffLabel').className = 'text-sm font-medium text-green-600';
            document.getElementById('mixedPaymentDifference').className = 'font-bold text-green-600';
            alertBox.classList.add('hidden');
            successBox.classList.remove('hidden');
            confirmBtn.disabled = false;
            confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else if (difference > 0) {
            document.getElementById('mixedPaymentDiffLabel').textContent = 'Falta:';
            document.getElementById('mixedPaymentDiffLabel').className = 'text-sm font-medium text-orange-600';
            document.getElementById('mixedPaymentDifference').className = 'font-bold text-orange-600';
            alertBox.textContent = `Faltan ${formatMoney(difference)}`;
            alertBox.classList.remove('hidden');
            successBox.classList.add('hidden');
            confirmBtn.disabled = true;
            confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
            document.getElementById('mixedPaymentDiffLabel').textContent = 'Excedente:';
            document.getElementById('mixedPaymentDiffLabel').className = 'text-sm font-medium text-red-600';
            document.getElementById('mixedPaymentDifference').className = 'font-bold text-red-600';
            alertBox.textContent = `Excedente de ${formatMoney(Math.abs(difference))}`;
            alertBox.classList.remove('hidden');
            successBox.classList.add('hidden');
            confirmBtn.disabled = true;
            confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

    function autoDistribute(type) {
        let subtotalSinIVA = 0;
        let totalIVA = 0;
        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            if (item.hasIVA) {
                const subtotalItem = itemTotal / 1.16;
                const ivaItem = itemTotal - subtotalItem;
                subtotalSinIVA += subtotalItem;
                totalIVA += ivaItem;
            } else {
                subtotalSinIVA += itemTotal;
            }
        });
        const total = subtotalSinIVA + totalIVA;
        
        let cash = 0, transfer = 0, card = 0;
        
        switch(type) {
            case 'half':
                cash = total / 2;
                transfer = total / 2;
                break;
            case 'thirds':
                cash = total / 3;
                transfer = total / 3;
                card = total / 3;
                break;
        }
        
        cash = Math.round(cash * 100) / 100;
        transfer = Math.round(transfer * 100) / 100;
        card = Math.round(card * 100) / 100;
        
        const sum = cash + transfer + card;
        if (sum !== total) cash += (total - sum);
        
        document.getElementById('mixedPaymentCash').value = cash.toFixed(2);
        document.getElementById('mixedPaymentTransfer').value = transfer > 0 ? transfer.toFixed(2) : '';
        document.getElementById('mixedPaymentCard').value = card > 0 ? card.toFixed(2) : '';
        
        validateMixedPayment();
    }

    function confirmMixedPayment() {
        const cash = parseFloat(document.getElementById('mixedPaymentCash').value) || 0;
        const transfer = parseFloat(document.getElementById('mixedPaymentTransfer').value) || 0;
        const card = parseFloat(document.getElementById('mixedPaymentCard').value) || 0;
        
        mixedPaymentData = { efectivo: cash, transferencia: transfer, tarjeta: card };
        isMixedPayment = true;
        
        document.getElementById('mixedPaymentSummary').classList.remove('hidden');
        document.getElementById('mixedCash').textContent = formatMoney(cash);
        document.getElementById('mixedTransfer').textContent = formatMoney(transfer);
        document.getElementById('mixedCard').textContent = formatMoney(card);
        document.getElementById('mixedTotal').textContent = formatMoney(cash + transfer + card);
        
        closeModal('mixedPaymentModal');
    }

    // ============================================
    // PROCESAR VENTA
    // ============================================

    async function processSale() {
        if (cart.length === 0) {
            alert('El carrito está vacío');
            return;
        }
        
        if (isMixedPayment) {
            const totalMixed = mixedPaymentData.efectivo + mixedPaymentData.transferencia + mixedPaymentData.tarjeta;
            
            let subtotalSinIVA = 0;
            let iva = 0;
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                if (item.hasIVA) {
                    const subtotalItem = itemTotal / 1.16;
                    const ivaItem = itemTotal - subtotalItem;
                    subtotalSinIVA += subtotalItem;
                    iva += ivaItem;
                } else {
                    subtotalSinIVA += itemTotal;
                }
            });
            
            const total = subtotalSinIVA + iva;
            
            if (Math.abs(totalMixed - total) > 0.01) {
                alert('Los montos del pago mixto no coinciden con el total');
                return;
            }
        }
        
        let subtotalSinIVA = 0;
        let iva = 0;
        let totalIVA0 = 0;
        let totalIVA16 = 0;
        
        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            if (item.hasIVA) {
                const subtotalItem = itemTotal / 1.16;
                const ivaItem = itemTotal - subtotalItem;
                subtotalSinIVA += subtotalItem;
                iva += ivaItem;
                totalIVA16 += itemTotal;
            } else {
                subtotalSinIVA += itemTotal;
                totalIVA0 += itemTotal;
            }
        });
        
        const total = subtotalSinIVA + iva;
        
        const sale = {
            user_id: currentUser.id,
            cashier_name: currentProfile.full_name || currentProfile.username,
            items: cart.map(i => ({
                id: i.id,
                name: i.name,
                price: i.price,
                quantity: i.quantity,
                hasIVA: i.hasIVA
            })),
            subtotal: subtotalSinIVA,
            iva: iva,
            total: total,
            total_iva_0: totalIVA0,
            total_iva_16: totalIVA16,
            payment_method: isMixedPayment ? 'mixto' : currentPaymentMethod,
            payment_details: isMixedPayment ? mixedPaymentData : null,
            cancelled: false
        };
        
        try {
            const { error } = await supabaseClient.from('sales').insert([sale]);
            if (error) throw error;
            
            for (const item of cart) {
                if (!item.isCustom) {
                    const product = products.find(p => p.id === item.id);
                    if (product) {
                        await supabaseClient
                            .from('products')
                            .update({ stock: product.stock - item.quantity })
                            .eq('id', item.id);
                    }
                }
            }
            
            cart = [];
            isMixedPayment = false;
            mixedPaymentData = { efectivo: 0, transferencia: 0, tarjeta: 0 };
            updateCart();
            document.getElementById('mixedPaymentSummary').classList.add('hidden');
            
            alert('¡Venta realizada con éxito!');
            await loadProducts();
            
        } catch (error) {
            alert('Error al procesar la venta: ' + error.message);
        }
    }

    // ============================================
    // HISTORIAL DE VENTAS
    // ============================================

    async function loadTodaySales() {
        try {
            const today = new Date().toISOString().split('T')[0];
            
            const { data: todaySales } = await supabaseClient
                .from('sales')
                .select('*')
                .gte('created_at', today)
                .eq('cancelled', false)
                .order('created_at', { ascending: false });

            const { data: todayCancelled } = await supabaseClient
                .from('sales')
                .select('*')
                .gte('created_at', today)
                .eq('cancelled', true);

            const total = todaySales?.reduce((sum, s) => sum + s.total, 0) || 0;
            const grossTotal = total + (todayCancelled?.reduce((sum, s) => sum + s.total, 0) || 0);
            const iva = todaySales?.reduce((sum, s) => sum + s.iva, 0) || 0;
            
            let cash = 0, transfer = 0, card = 0;
            todaySales?.forEach(s => {
                if (s.payment_method === 'mixto' && s.payment_details) {
                    cash += s.payment_details.efectivo || 0;
                    transfer += s.payment_details.transferencia || 0;
                    card += s.payment_details.tarjeta || 0;
                } else {
                    if (s.payment_method === 'efectivo') cash += s.total;
                    if (s.payment_method === 'transferencia') transfer += s.total;
                    if (s.payment_method === 'tarjeta') card += s.total;
                }
            });
            
            document.getElementById('historyTotalSales').textContent = formatMoney(total);
            document.getElementById('historyIVA').textContent = formatMoney(iva);
            document.getElementById('historyCount').textContent = todaySales?.length || 0;
            document.getElementById('historyShouldHave').textContent = formatMoney(total);
            document.getElementById('cashTotal').textContent = 'E: ' + formatMoney(cash);
            document.getElementById('transferTotal').textContent = 'T: ' + formatMoney(transfer);
            document.getElementById('cardTotal').textContent = 'C: ' + formatMoney(card);
            
            const cancelledSection = document.getElementById('historyCancelledSection');
            if (todayCancelled?.length > 0) {
                cancelledSection.classList.remove('hidden');
                document.getElementById('historyCancelledAmount').textContent = formatMoney(todayCancelled.reduce((sum, s) => sum + s.total, 0));
                document.getElementById('historyCancelledCount').textContent = todayCancelled.length;
                document.getElementById('historyGrossSales').textContent = formatMoney(grossTotal);
            } else {
                cancelledSection.classList.add('hidden');
            }
            
            renderSalesTable(todaySales || []);
            
        } catch (error) {
            console.error('Error loading sales:', error);
        }
    }

    function getSaleIVAType(sale) {
        const hasIVA0 = (sale.total_iva_0 || 0) > 0;
        const hasIVA16 = (sale.total_iva_16 || 0) > 0;
        
        if (hasIVA0 && hasIVA16) {
            return { type: 'MIXTA', class: 'iva-badge-mix', icon: 'fa-layer-group' };
        } else if (hasIVA16) {
            return { type: '16%', class: 'iva-badge-16', icon: 'fa-percentage' };
        } else {
            return { type: '0%', class: 'iva-badge-0', icon: 'fa-circle' };
        }
    }

    function renderSalesTable(salesList) {
        const tbody = document.getElementById('salesTableBody');
        tbody.innerHTML = '';
        
        salesList.forEach(sale => {
            const ivaType = getSaleIVAType(sale);
            
            let paymentDisplay = '';
            if (sale.payment_method === 'mixto' && sale.payment_details) {
                const parts = [];
                if (sale.payment_details.efectivo > 0) parts.push(`Ef: ${formatMoney(sale.payment_details.efectivo)}`);
                if (sale.payment_details.transferencia > 0) parts.push(`Tr: ${formatMoney(sale.payment_details.transferencia)}`);
                if (sale.payment_details.tarjeta > 0) parts.push(`Ta: ${formatMoney(sale.payment_details.tarjeta)}`);
                paymentDisplay = `<span class="px-2 py-1 rounded-full text-xs bg-purple-100 text-purple-700" title="${parts.join(' | ')}">Mixto</span>`;
            } else {
                paymentDisplay = `<span class="px-2 py-1 rounded-full text-xs ${getPaymentMethodColor(sale.payment_method)}">${sale.payment_method}</span>`;
            }
            
            const mainRow = document.createElement('tr');
            mainRow.className = `sale-row hover:bg-gray-50 transition-colors ${sale.cancelled ? 'bg-red-50' : ''}`;
            mainRow.onclick = () => toggleSaleDetails(sale.id);
            mainRow.innerHTML = `
                <td class="px-4 py-3 font-medium ${sale.cancelled ? 'text-red-600 line-through' : 'text-brand-700'}">
                    ${sale.id.slice(0, 8)}...
                    ${ivaType.type === 'MIXTA' ? '<i class="fas fa-chevron-down text-xs ml-1 text-gray-400"></i>' : ''}
                </td>
                <td class="px-4 py-3 text-gray-600">${new Date(sale.created_at).toLocaleString()}</td>
                <td class="px-4 py-3 text-sm">${sale.cashier_name || 'N/A'}</td>
                <td class="px-4 py-3 text-sm">${sale.items.length} productos</td>
                <td class="px-4 py-3 text-center">
                    <span class="px-2 py-1 rounded-full text-xs font-bold ${ivaType.class}">
                        <i class="fas ${ivaType.icon} mr-1"></i>${ivaType.type}
                    </span>
                </td>
                <td class="px-4 py-3">${paymentDisplay}</td>
                <td class="px-4 py-3 text-right font-bold ${sale.cancelled ? 'text-red-600 line-through' : ''}">${formatMoney(sale.total)}</td>
                <td class="px-4 py-3 text-center">
                    ${sale.cancelled ? 
                        '<span class="px-2 py-1 rounded-full text-xs bg-red-100 text-red-700">Cancelada</span>' : 
                        '<span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-700">Activa</span>'
                    }
                </td>
                <td class="px-4 py-3 text-center">
                    ${!sale.cancelled && currentProfile?.role === 'admin' ? `
                        <button onclick="event.stopPropagation(); cancelSale('${sale.id}')" class="text-red-500 hover:text-red-700 text-xs bg-red-50 px-2 py-1 rounded transition-colors">
                            <i class="fas fa-times mr-1"></i>Cancelar
                        </button>
                    ` : '<span class="text-xs text-gray-400">-</span>'}
                </td>
            `;
            tbody.appendChild(mainRow);
            
            if (ivaType.type === 'MIXTA') {
                const detailRow = document.createElement('tr');
                detailRow.id = `sale-detail-${sale.id}`;
                detailRow.className = 'sale-details';
                detailRow.innerHTML = `
                    <td colspan="9" class="px-4 py-3">
                        <div class="bg-purple-50 rounded-lg p-3 ml-4">
                            <p class="text-xs font-bold text-purple-800 mb-2">Desglose por tipo de IVA:</p>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div class="flex justify-between items-center p-2 bg-white rounded">
                                    <span class="text-gray-600"><i class="fas fa-circle text-pink-500 mr-2"></i>IVA 0%:</span>
                                    <span class="font-bold text-pink-700">${formatMoney(sale.total_iva_0 || 0)}</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-white rounded">
                                    <span class="text-gray-600"><i class="fas fa-percentage text-blue-500 mr-2"></i>IVA 16%:</span>
                                    <span class="font-bold text-blue-700">${formatMoney(sale.total_iva_16 || 0)}</span>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-gray-500">
                                <p>Subtotal IVA 0%: ${formatMoney(sale.total_iva_0 || 0)}</p>
                                <p>Subtotal IVA 16%: ${formatMoney((sale.total_iva_16 || 0) / 1.16)} | IVA: ${formatMoney((sale.total_iva_16 || 0) - ((sale.total_iva_16 || 0) / 1.16))}</p>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(detailRow);
            }
        });
    }

    function toggleSaleDetails(saleId) {
        const detailRow = document.getElementById(`sale-detail-${saleId}`);
        if (detailRow) {
            detailRow.classList.toggle('active');
            const icon = detailRow.previousElementSibling.querySelector('.fa-chevron-down');
            if (icon) {
                icon.classList.toggle('fa-chevron-up');
                icon.classList.toggle('fa-chevron-down');
            }
        }
    }

    function getPaymentMethodColor(method) {
        const colors = {
            'efectivo': 'bg-green-100 text-green-700',
            'transferencia': 'bg-blue-100 text-blue-700',
            'tarjeta': 'bg-purple-100 text-purple-700'
        };
        return colors[method] || 'bg-gray-100 text-gray-700';
    }

    async function cancelSale(saleId) {
        if (!confirm('¿Cancelar esta venta? Se restaurará el stock.')) return;
        
        try {
            const { data: sale } = await supabaseClient
                .from('sales')
                .select('*')
                .eq('id', saleId)
                .single();

            if (!sale) return;

            for (const item of sale.items) {
                if (!item.isCustom) {
                    const { data: product } = await supabaseClient
                        .from('products')
                        .select('stock')
                        .eq('id', item.id)
                        .single();
                    
                    if (product) {
                        await supabaseClient
                            .from('products')
                            .update({ stock: product.stock + item.quantity })
                            .eq('id', item.id);
                    }
                }
            }

            await supabaseClient
                .from('sales')
                .update({ 
                    cancelled: true, 
                    cancelled_at: new Date().toISOString(),
                    cancelled_by: currentProfile.full_name 
                })
                .eq('id', saleId);

            await loadTodaySales();
            await updateDashboard();
            alert('Venta cancelada correctamente');
            
        } catch (error) {
            alert('Error al cancelar: ' + error.message);
        }
    }

    async function filterSales() {
        const from = document.getElementById('filterDateFrom').value;
        const to = document.getElementById('filterDateTo').value;
        
        if (!from || !to) return;
        
        try {
            const { data } = await supabaseClient
                .from('sales')
                .select('*')
                .gte('created_at', from)
                .lte('created_at', to + 'T23:59:59')
                .order('created_at', { ascending: false });
            
            renderSalesTable(data || []);
        } catch (error) {
            console.error('Error filtering sales:', error);
        }
    }

    function generateDailyCut() {
        loadTodaySales();
        const today = new Date();
        document.getElementById('cutDate').textContent = today.toLocaleDateString('es-MX', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
        
        const todayStr = new Date().toISOString().split('T')[0];
        supabaseClient
            .from('sales')
            .select('*')
            .gte('created_at', todayStr)
            .eq('cancelled', false)
            .then(({ data: todaySales }) => {
                const total = todaySales?.reduce((sum, s) => sum + s.total, 0) || 0;
                const iva = todaySales?.reduce((sum, s) => sum + s.iva, 0) || 0;
                
                let cash = 0, transfer = 0, card = 0;
                todaySales?.forEach(s => {
                    if (s.payment_method === 'mixto' && s.payment_details) {
                        cash += s.payment_details.efectivo || 0;
                        transfer += s.payment_details.transferencia || 0;
                        card += s.payment_details.tarjeta || 0;
                    } else {
                        if (s.payment_method === 'efectivo') cash += s.total;
                        if (s.payment_method === 'transferencia') transfer += s.total;
                        if (s.payment_method === 'tarjeta') card += s.total;
                    }
                });
                
                document.getElementById('cutTotal').textContent = formatMoney(total);
                document.getElementById('cutCash').textContent = formatMoney(cash);
                document.getElementById('cutTransfer').textContent = formatMoney(transfer);
                document.getElementById('cutCard').textContent = formatMoney(card);
                document.getElementById('cutIVA').textContent = formatMoney(iva);
                document.getElementById('cutTransactions').textContent = todaySales?.length || 0;
                
                return supabaseClient
                    .from('sales')
                    .select('*')
                    .gte('created_at', todayStr)
                    .eq('cancelled', true);
            })
            .then(({ data: cancelledSales }) => {
                if (cancelledSales?.length > 0) {
                    document.getElementById('cutCancelledSection').classList.remove('hidden');
                    document.getElementById('cutCancelledAmount').textContent = formatMoney(cancelledSales.reduce((sum, s) => sum + s.total, 0));
                } else {
                    document.getElementById('cutCancelledSection').classList.add('hidden');
                }
            });
        
        openModal('cutModal');
    }

    // ============================================
    // SISTEMA DE GASTOS MEJORADO - OCR Y APRENDIZAJE
    // ============================================

    // Cargar datos de aprendizaje de productos
    async function loadProductLearningData() {
        try {
            const { data, error } = await supabaseClient
                .from('product_iva_learning')
                .select('*');
            
            if (error) throw error;
            
            productLearningData = {};
            data?.forEach(item => {
                productLearningData[item.product_fingerprint] = {
                    iva: item.usually_has_iva,
                    count: item.occurrence_count
                };
            });
        } catch (error) {
            console.error('Error loading learning data:', error);
        }
    }

    // Normalizar nombre de producto para fingerprint
    function normalizeProductName(name) {
        return name
            .toLowerCase()
            .replace(/\d+/g, '') // Eliminar números
            .replace(/[^\w\s]/g, '') // Eliminar puntuación
            .replace(/\s+/g, ' ') // Espacios múltiples a uno
            .trim()
            .split(' ')
            .filter(word => word.length > 2) // Solo palabras > 2 caracteres
            .slice(0, 2) // Máximo 2 palabras
            .join(' ');
    }

    // Obtener sugerencia de IVA basada en aprendizaje
    function getIVASuggestion(productName) {
        const fingerprint = normalizeProductName(productName);
        const data = productLearningData[fingerprint];
        
        if (!data || data.count < 2) return null;
        
        return {
            hasIVA: data.iva,
            confidence: data.count,
            text: data.iva ? 'Este producto suele llevar IVA' : 'Este producto usualmente no lleva IVA'
        };
    }

    // Actualizar datos de aprendizaje
    async function updateLearningData(productName, hasIVA) {
        const fingerprint = normalizeProductName(productName);
        
        try {
            const { data: existing } = await supabaseClient
                .from('product_iva_learning')
                .select('*')
                .eq('product_fingerprint', fingerprint)
                .single();

            if (existing) {
                const newCount = existing.occurrence_count + 1;
                const newIVA = hasIVA; // Actualizar con el valor más reciente
                await supabaseClient
                    .from('product_iva_learning')
                    .update({
                        usually_has_iva: newIVA,
                        occurrence_count: newCount
                    })
                    .eq('id', existing.id);
            } else {
                await supabaseClient
                    .from('product_iva_learning')
                    .insert([{
                        product_fingerprint: fingerprint,
                        usually_has_iva: hasIVA,
                        occurrence_count: 1
                    }]);
            }
            
            // Recargar datos locales
            await loadProductLearningData();
        } catch (error) {
            console.error('Error updating learning data:', error);
        }
    }

    // Abrir modal de selección de tipo de gasto
    function openExpenseTypeModal() {
        openModal('expenseTypeModal');
    }

    // Abrir modal de gasto con OCR
    function openOCRExpenseModal() {
        closeModal('expenseTypeModal');
        document.getElementById('ocrStep1').classList.remove('hidden');
        document.getElementById('ocrStep2').classList.add('hidden');
        document.getElementById('ocrStep3').classList.add('hidden');
        document.getElementById('ticketImageInput').value = '';
        openModal('ocrExpenseModal');
    }

    // Abrir modal de gasto manual
    function openManualExpenseModal() {
        closeModal('expenseTypeModal');
        document.getElementById('manualExpenseArea').value = 'produccion';
        document.getElementById('manualExpenseConcept').value = '';
        document.getElementById('manualExpenseAmount').value = '';
        document.getElementById('manualExpenseMethod').value = 'efectivo';
        document.getElementById('manualExpenseHasIVA').checked = false;
        document.getElementById('manualExpenseBreakdown').classList.add('hidden');
        openModal('manualExpenseModal');
    }

    // Manejar drag and drop
    function handleDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add('dragover');
    }

    function handleDragLeave(e) {
        e.currentTarget.classList.remove('dragover');
    }

    function handleDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            processImageFile(files[0]);
        }
    }

    function handleImageSelect(e) {
        const file = e.target.files[0];
        if (file) {
            processImageFile(file);
        }
    }

    // Procesar archivo de imagen
    function processImageFile(file) {
        if (!file.type.startsWith('image/')) {
            alert('Por favor selecciona un archivo de imagen válido');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                document.getElementById('ticketPreview').src = img.src;
                document.getElementById('ocrStep1').classList.add('hidden');
                document.getElementById('ocrStep2').classList.remove('hidden');
                processOCR(img);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    // Preprocesar imagen para mejor OCR
    function preprocessImage(img) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Escalar imagen si es muy grande
        let width = img.width;
        let height = img.height;
        const maxSize = 2000;
        
        if (width > maxSize || height > maxSize) {
            if (width > height) {
                height = (height / width) * maxSize;
                width = maxSize;
            } else {
                width = (width / height) * maxSize;
                height = maxSize;
            }
        }
        
        canvas.width = width;
        canvas.height = height;
        
        // Dibujar imagen
        ctx.drawImage(img, 0, 0, width, height);
        
        // Convertir a escala de grises y aumentar contraste
        const imageData = ctx.getImageData(0, 0, width, height);
        const data = imageData.data;
        
        for (let i = 0; i < data.length; i += 4) {
            // Escala de grises
            const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
            
            // Aumentar contraste
            const contrast = 1.5;
            const adjusted = ((gray - 128) * contrast) + 128;
            
            data[i] = adjusted;     // R
            data[i + 1] = adjusted; // G
            data[i + 2] = adjusted; // B
        }
        
        ctx.putImageData(imageData, 0, 0);
        return canvas;
    }

    // Procesar OCR con Tesseract.js
    async function processOCR(img) {
        try {
            const canvas = preprocessImage(img);
            
            // Actualizar UI
            document.getElementById('ocrStatusIcon').innerHTML = '<i class="fas fa-spinner fa-spin text-yellow-600"></i>';
            document.getElementById('ocrStatusText').textContent = 'Inicializando OCR...';
            document.getElementById('ocrProgressBar').style.width = '10%';
            
            const result = await Tesseract.recognize(
                canvas,
                'spa',
                {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const progress = Math.round(m.progress * 100);
                            document.getElementById('ocrProgressBar').style.width = progress + '%';
                            document.getElementById('ocrStatusText').textContent = `Procesando... ${progress}%`;
                        }
                    }
                }
            );
            
            // Procesar resultado
            document.getElementById('ocrStatusIcon').innerHTML = '<i class="fas fa-check text-green-600"></i>';
            document.getElementById('ocrStatusText').textContent = '¡Procesamiento completado!';
            document.getElementById('ocrProgressBar').style.width = '100%';
            
            const confidence = result.data.confidence;
            document.getElementById('ocrConfidence').textContent = `Confianza: ${confidence.toFixed(1)}%`;
            
            // Mostrar advertencia si confianza es baja
            if (confidence < 70) {
                document.getElementById('ocrWarning').classList.remove('hidden');
            } else {
                document.getElementById('ocrWarning').classList.add('hidden');
            }
            
            // Parsear datos del ticket
            parseTicketData(result.data.text);
            
            // Guardar datos OCR crudos
            currentOCRData = {
                raw_text: result.data.text,
                confidence: confidence,
                processed_at: new Date().toISOString()
            };
            
            // Mostrar paso de edición
            setTimeout(() => {
                document.getElementById('ocrStep2').classList.add('hidden');
                document.getElementById('ocrStep3').classList.remove('hidden');
            }, 500);
            
        } catch (error) {
            console.error('OCR Error:', error);
            document.getElementById('ocrStatusIcon').innerHTML = '<i class="fas fa-exclamation-triangle text-red-600"></i>';
            document.getElementById('ocrStatusText').textContent = 'Error en el procesamiento';
            alert('Error al procesar la imagen: ' + error.message);
        }
    }

    // Parsear datos del ticket
    function parseTicketData(text) {
        const lines = text.split('\n').filter(line => line.trim());
        
        // Buscar número de ticket (patrones comunes)
        let ticketNumber = '';
        const ticketPatterns = [
            /ticket[:\s]*#?\s*(\d+)/i,
            /folio[:\s]*#?\s*(\d+)/i,
            /no[:\s]*#?\s*(\d+)/i,
            /(\d{4,})/ // Número largo cualquiera
        ];
        
        for (const pattern of ticketPatterns) {
            const match = text.match(pattern);
            if (match) {
                ticketNumber = match[1];
                break;
            }
        }
        
        // Buscar fecha
        let ticketDate = new Date().toISOString().split('T')[0];
        const datePatterns = [
            /(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/,
            /(\d{2,4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/
        ];
        
        for (const pattern of datePatterns) {
            const match = text.match(pattern);
            if (match) {
                try {
                    const day = parseInt(match[1]);
                    const month = parseInt(match[2]) - 1;
                    const year = parseInt(match[3]) < 100 ? 2000 + parseInt(match[3]) : parseInt(match[3]);
                    const date = new Date(year, month, day);
                    if (!isNaN(date.getTime())) {
                        ticketDate = date.toISOString().split('T')[0];
                        break;
                    }
                } catch (e) {}
            }
        }
        
        // Buscar hora
        let ticketTime = '';
        const timeMatch = text.match(/(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM|am|pm)?/);
        if (timeMatch) {
            let hours = parseInt(timeMatch[1]);
            const minutes = timeMatch[2];
            const period = timeMatch[4];
            
            if (period && (period.toUpperCase() === 'PM') && hours !== 12) {
                hours += 12;
            } else if (period && (period.toUpperCase() === 'AM') && hours === 12) {
                hours = 0;
            }
            
            ticketTime = `${hours.toString().padStart(2, '0')}:${minutes}`;
        }
        
        // Parsear items (líneas con cantidad, descripción y precio)
        const items = [];
        const itemPatterns = [
            /(\d+(?:\.\d+)?)\s+([^\d]+?)\s+\$?(\d+(?:\.\d+)?)/i,
            /([^\d]+?)\s+(\d+(?:\.\d+)?)\s+\$?(\d+(?:\.\d+)?)/i,
            /(\d+)\s+x\s+\$?([\d.]+)\s+([^\d]+)/i
        ];
        
        for (const line of lines) {
            // Intentar diferentes patrones
            let match = line.match(/(\d+(?:\.\d+)?)\s+([A-Za-z\s]+)\s+\$?(\d+(?:,\d{3})*(?:\.\d+)?)/);
            
            if (match) {
                const quantity = parseFloat(match[1]) || 1;
                const name = match[2].trim();
                const total = parseFloat(match[3].replace(',', '')) || 0;
                
                if (name.length > 2 && total > 0) {
                    // Buscar sugerencia de IVA
                    const suggestion = getIVASuggestion(name);
                    
                    items.push({
                        name: name,
                        quantity: quantity,
                        total: total,
                        has_iva: suggestion ? suggestion.hasIVA : false,
                        suggestion: suggestion
                    });
                }
            }
        }
        
        // Buscar total general
        let totalGeneral = 0;
        const totalPatterns = [
            /total[:\s]*\$?(\d+(?:,\d{3})*(?:\.\d+)?)/i,
            /importe[:\s]*\$?(\d+(?:,\d{3})*(?:\.\d+)?)/i,
            /\$?\s*(\d+(?:,\d{3})*(?:\.\d{2}))\s*$/m
        ];
        
        for (const pattern of totalPatterns) {
            const match = text.match(pattern);
            if (match) {
                totalGeneral = parseFloat(match[1].replace(',', '')) || 0;
                if (totalGeneral > 0) break;
            }
        }
        
        // Si no hay total, sumar items
        if (totalGeneral === 0 && items.length > 0) {
            totalGeneral = items.reduce((sum, item) => sum + item.total, 0);
        }
        
        // Llenar campos del formulario
        document.getElementById('ocrTicketNumber').value = ticketNumber;
        document.getElementById('ocrTicketDate').value = ticketDate;
        document.getElementById('ocrTicketTime').value = ticketTime;
        
        // Renderizar items
        renderOCRItems(items, totalGeneral);
    }

    // Renderizar items del OCR
    function renderOCRItems(items, totalGeneral) {
        currentExpenseItems = items;
        const container = document.getElementById('ocrItemsList');
        
        if (items.length === 0) {
            container.innerHTML = `
                <div class="p-4 bg-yellow-50 rounded-lg text-center">
                    <i class="fas fa-exclamation-triangle text-yellow-500 mb-2"></i>
                    <p class="text-sm text-yellow-700">No se detectaron items automáticamente.</p>
                    <button onclick="addManualOCRItem()" class="mt-2 text-brand-600 hover:text-brand-800 text-sm font-medium">
                        <i class="fas fa-plus mr-1"></i>Agregar item manualmente
                    </button>
                </div>
            `;
        } else {
            container.innerHTML = items.map((item, index) => `
                <div class="ocr-preview-item p-3 bg-gray-50 rounded-lg flex items-center justify-between gap-3">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <input type="text" value="${item.name}" 
                                onchange="updateOCRItem(${index}, 'name', this.value)"
                                class="flex-1 border border-gray-300 rounded px-2 py-1 text-sm">
                            ${item.suggestion ? `
                                <span class="learning-indicator" title="Basado en ${item.suggestion.confidence} compras anteriores">
                                    <i class="fas fa-brain"></i>
                                </span>
                            ` : ''}
                        </div>
                        <div class="flex items-center gap-2 mt-1">
                            <input type="number" value="${item.quantity}" step="0.01"
                                onchange="updateOCRItem(${index}, 'quantity', this.value)"
                                class="w-20 border border-gray-300 rounded px-2 py-1 text-xs">
                            <span class="text-gray-400">x</span>
                            <input type="number" value="${item.total.toFixed(2)}" step="0.01"
                                onchange="updateOCRItem(${index}, 'total', this.value)"
                                class="w-24 border border-gray-300 rounded px-2 py-1 text-xs">
                        </div>
                        ${item.suggestion ? `
                            <p class="text-xs text-purple-600 mt-1">
                                <i class="fas fa-lightbulb mr-1"></i>${item.suggestion.text}
                            </p>
                        ` : ''}
                    </div>
                    <div class="flex flex-col items-center gap-1">
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="checkbox" ${item.has_iva ? 'checked' : ''} 
                                onchange="updateOCRItem(${index}, 'has_iva', this.checked)"
                                class="w-4 h-4 text-brand-600 rounded">
                            <span class="text-xs text-gray-600">IVA</span>
                        </label>
                        <button onclick="removeOCRItem(${index})" class="text-red-400 hover:text-red-600">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        updateOCRTotals();
    }

    function updateOCRItem(index, field, value) {
        if (field === 'has_iva') {
            currentExpenseItems[index][field] = value;
        } else if (field === 'quantity' || field === 'total') {
            currentExpenseItems[index][field] = parseFloat(value) || 0;
        } else {
            currentExpenseItems[index][field] = value;
        }
        updateOCRTotals();
    }

    function removeOCRItem(index) {
        currentExpenseItems.splice(index, 1);
        renderOCRItems(currentExpenseItems, 0);
    }

    function addManualOCRItem() {
        currentExpenseItems.push({
            name: 'Nuevo producto',
            quantity: 1,
            total: 0,
            has_iva: false,
            suggestion: null
        });
        renderOCRItems(currentExpenseItems, 0);
    }

    function updateOCRTotals() {
        let subtotal = 0;
        let iva = 0;
        
        currentExpenseItems.forEach(item => {
            if (item.has_iva) {
                const itemSubtotal = item.total / 1.16;
                const itemIVA = item.total - itemSubtotal;
                subtotal += itemSubtotal;
                iva += itemIVA;
            } else {
                subtotal += item.total;
            }
        });
        
        document.getElementById('ocrSubtotal').textContent = formatMoney(subtotal);
        document.getElementById('ocrIVA').textContent = formatMoney(iva);
        document.getElementById('ocrTotal').textContent = formatMoney(subtotal + iva);
    }

    function retakePhoto() {
        document.getElementById('ocrStep1').classList.remove('hidden');
        document.getElementById('ocrStep2').classList.add('hidden');
        document.getElementById('ocrStep3').classList.add('hidden');
        document.getElementById('ticketImageInput').value = '';
    }

    // Guardar gasto con OCR
    async function saveOCRExpense() {
        if (currentExpenseItems.length === 0) {
            alert('Debes agregar al menos un item');
            return;
        }
        
        // Validar que los items sumen el total
        const calculatedTotal = currentExpenseItems.reduce((sum, item) => sum + item.total, 0);
        
        const expenseData = {
            user_id: currentUser.id,
            registered_by: currentProfile.full_name,
            area: document.getElementById('ocrExpenseArea').value,
            method: document.getElementById('ocrExpenseMethod').value,
            ticket_number: document.getElementById('ocrTicketNumber').value,
            ticket_date: document.getElementById('ocrTicketDate').value,
            ticket_time: document.getElementById('ocrTicketTime').value || null,
            ticket_data: currentOCRData,
            has_ticket: true,
            is_edited: false,
            amount: calculatedTotal // Se calculará automáticamente en la base de datos
        };
        
        try {
            // Insertar gasto
            const { data: expense, error: expenseError } = await supabaseClient
                .from('expenses')
                .insert([expenseData])
                .select()
                .single();
            
            if (expenseError) throw expenseError;
            
            // Insertar items
            const itemsToInsert = currentExpenseItems.map(item => ({
                expense_id: expense.id,
                name: item.name,
                quantity: item.quantity,
                total: item.total,
                has_iva: item.has_iva,
                product_fingerprint: normalizeProductName(item.name)
            }));
            
            const { error: itemsError } = await supabaseClient
                .from('expense_items')
                .insert(itemsToInsert);
            
            if (itemsError) throw itemsError;
            
            // Actualizar datos de aprendizaje
            for (const item of currentExpenseItems) {
                await updateLearningData(item.name, item.has_iva);
            }
            
            closeModal('ocrExpenseModal');
            await loadExpenses();
            await updateDashboard();
            
            // Limpiar
            currentExpenseItems = [];
            currentOCRData = null;
            
            alert('¡Gasto guardado exitosamente!');
            
        } catch (error) {
            console.error('Error saving expense:', error);
            alert('Error al guardar el gasto: ' + error.message);
        }
    }

    // Actualizar display de gasto manual
    function updateManualExpenseDisplay() {
        const amount = parseFloat(document.getElementById('manualExpenseAmount').value) || 0;
        const hasIVA = document.getElementById('manualExpenseHasIVA').checked;
        
        if (hasIVA && amount > 0) {
            const subtotal = amount / 1.16;
            const iva = amount - subtotal;
            
            document.getElementById('manualSubtotal').textContent = formatMoney(subtotal);
            document.getElementById('manualIVA').textContent = formatMoney(iva);
            document.getElementById('manualTotalDisplay').textContent = formatMoney(amount);
            document.getElementById('manualExpenseBreakdown').classList.remove('hidden');
        } else {
            document.getElementById('manualExpenseBreakdown').classList.add('hidden');
        }
    }

    // Guardar gasto manual
    async function saveManualExpense() {
        const area = document.getElementById('manualExpenseArea').value;
        const concept = document.getElementById('manualExpenseConcept').value;
        const amount = parseFloat(document.getElementById('manualExpenseAmount').value);
        const method = document.getElementById('manualExpenseMethod').value;
        const hasIVA = document.getElementById('manualExpenseHasIVA').checked;
        
        if (!concept || !amount) {
            alert('Complete todos los campos obligatorios');
            return;
        }
        
        let subtotal = amount;
        let ivaAmount = 0;
        
        if (hasIVA) {
            subtotal = amount / 1.16;
            ivaAmount = amount - subtotal;
        }
        
        try {
            const { error } = await supabaseClient.from('expenses').insert([{
                user_id: currentUser.id,
                registered_by: currentProfile.full_name,
                area,
                concept,
                amount: amount,
                method,
                has_iva: hasIVA,
                subtotal: subtotal,
                iva_amount: ivaAmount,
                has_ticket: false,
                is_edited: false,
                ticket_data: { concept, manual: true }
            }]);
            
            if (error) throw error;
            
            closeModal('manualExpenseModal');
            await loadExpenses();
            await updateDashboard();
            
            alert('¡Gasto registrado exitosamente!');
            
        } catch (error) {
            alert('Error al guardar gasto: ' + error.message);
        }
    }

    // REEMPLAZA la función loadExpenses() completa con esta versión:

async function loadExpenses() {
    try {
        const filter = document.getElementById('expenseFilterArea').value;
        
        // CORRECCIÓN 1: Consulta base simplificada sin el join problemático
        let query = supabaseClient
            .from('expenses')
            .select('*')
            .order('created_at', { ascending: false });
        
        // Aplicar filtros de usuario
        if (currentProfile?.role === 'cashier') {
            query = query.eq('user_id', currentUser.id);
        } else if (filter !== 'all') {
            query = query.eq('area', filter);
        }
        
        const { data: expenses, error } = await query;
        
        if (error) {
            console.error('Error en consulta de gastos:', error);
            throw error;
        }
        
        console.log('Gastos cargados:', expenses?.length || 0, expenses); // Debug
        
        // CORRECCIÓN 2: Cargar items de gastos en una consulta separada para evitar problemas de join
        let expenseItems = [];
        if (expenses && expenses.length > 0) {
            const expenseIds = expenses.map(e => e.id);
            
            const { data: items, error: itemsError } = await supabaseClient
                .from('expense_items')
                .select('*')
                .in('expense_id', expenseIds);
            
            if (itemsError) {
                console.error('Error cargando items:', itemsError);
            } else {
                expenseItems = items || [];
            }
        }
        
        // Combinar datos
        const expensesWithItems = (expenses || []).map(exp => ({
            ...exp,
            expense_items: expenseItems.filter(item => item.expense_id === exp.id)
        }));
        
        // Actualizar estadísticas (solo admin)
        if (currentProfile?.role === 'admin') {
            await updateExpenseStats();
        }
        
        // Renderizar tabla con los datos combinados
        renderExpensesTable(expensesWithItems);
        
    } catch (error) {
        console.error('Error loading expenses:', error);
        // Mostrar error en la tabla
        document.getElementById('expensesTableBody').innerHTML = `
            <tr>
                <td colspan="8" class="px-4 py-8 text-center text-red-500">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    Error al cargar gastos: ${error.message}
                </td>
            </tr>
        `;
    }
}

// Función separada para actualizar estadísticas
async function updateExpenseStats() {
    try {
        const { data: allExpenses, error } = await supabaseClient
            .from('expenses')
            .select('area, amount');
        
        if (error) throw error;
        
        const stats = {
            produccion: 0,
            atencion: 0,
            administrativo: 0,
            otros: 0
        };
        
        (allExpenses || []).forEach(e => {
            if (stats[e.area] !== undefined) {
                stats[e.area] += e.amount || 0;
            }
        });
        
        document.getElementById('expenseProduction').textContent = formatMoney(stats.produccion);
        document.getElementById('expenseCustomerService').textContent = formatMoney(stats.atencion);
        document.getElementById('expenseAdmin').textContent = formatMoney(stats.administrativo);
        document.getElementById('expenseOthers').textContent = formatMoney(stats.otros);
        
    } catch (error) {
        console.error('Error updating stats:', error);
    }
}

// Función separada para renderizar la tabla
function renderExpensesTable(expenses) {
    const tbody = document.getElementById('expensesTableBody');
    
    if (!expenses || expenses.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                    <i class="fas fa-inbox text-4xl mb-2 block"></i>
                    No hay gastos registrados
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = expenses.map(exp => {
        const hasItems = exp.expense_items && exp.expense_items.length > 0;
        const itemCount = hasItems ? exp.expense_items.length : 0;
        
        // Badges
        let badges = '';
        if (exp.has_ticket) {
            badges += `<span class="expense-badge badge-ocr" title="Procesado con OCR">📷</span>`;
        }
        if (exp.is_edited) {
            badges += `<span class="expense-badge badge-edited" title="Editado">✏️</span>`;
        }
        
        // Verificar sugerencias
        let hasSuggestion = false;
        if (hasItems) {
            hasSuggestion = exp.expense_items.some(item => {
                const suggestion = getIVASuggestion(item.name);
                return suggestion && suggestion.confidence >= 2;
            });
            if (hasSuggestion) {
                badges += `<span class="expense-badge badge-suggestion" title="Sugerencia basada en aprendizaje">🧠</span>`;
            }
        }
        
        const displayName = exp.has_ticket 
            ? (exp.ticket_number ? `Ticket #${exp.ticket_number}` : 'Ticket sin número')
            : (exp.concept || 'Sin concepto');
        
        // Determinar columnas visibles según rol
        const isAdmin = currentProfile?.role === 'admin';
        const areaColumn = isAdmin ? `<td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs ${getAreaColor(exp.area)}">${exp.area}</span></td>` : '';
        
        return `
            <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-4 py-3 text-gray-600">${new Date(exp.created_at).toLocaleDateString()}</td>
                <td class="px-4 py-3 font-medium">${displayName}</td>
                ${areaColumn}
                <td class="px-4 py-3 text-center">
                    ${hasItems ? `<span class="font-medium">${itemCount}</span>` : '<span class="text-gray-400">-</span>'}
                </td>
                <td class="px-4 py-3 text-right font-bold text-red-600">-${formatMoney(exp.amount)}</td>
                <td class="px-4 py-3 text-center">
                    ${exp.iva_total > 0 ? `<span class="text-blue-600 font-medium">${formatMoney(exp.iva_total)}</span>` : '<span class="text-gray-400">-</span>'}
                </td>
                <td class="px-4 py-3 text-center">${badges}</td>
                <td class="px-4 py-3 text-center">
                    <div class="flex justify-center gap-2">
                        <button onclick="editExpense('${exp.id}')" class="text-blue-500 hover:text-blue-700 btn-action" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${exp.has_ticket ? `
                            <button onclick="viewOCR('${exp.id}')" class="text-purple-500 hover:text-purple-700 btn-action" title="Ver OCR">
                                <i class="fas fa-file-alt"></i>
                            </button>
                        ` : ''}
                        ${hasItems ? `
                            <button onclick="viewBreakdown('${exp.id}')" class="text-green-500 hover:text-green-700 btn-action" title="Desglose">
                                <i class="fas fa-list-alt"></i>
                            </button>
                        ` : ''}
                        <button onclick="deleteExpense('${exp.id}')" class="text-red-500 hover:text-red-700 btn-action" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}
            
        } catch (error) {
            console.error('Error loading expenses:', error);
        }
    }

    // Editar gasto
    async function editExpense(id) {
        try {
            const { data: expense, error } = await supabaseClient
                .from('expenses')
                .select(`
                    *,
                    expense_items (*)
                `)
                .eq('id', id)
                .single();
            
            if (error) throw error;
            
            document.getElementById('editExpenseId').value = expense.id;
            document.getElementById('editExpenseArea').value = expense.area;
            document.getElementById('editExpenseMethod').value = expense.method;
            
            const hasItems = expense.expense_items && expense.expense_items.length > 0;
            
            if (hasItems) {
                document.getElementById('editExpenseHasItems').classList.remove('hidden');
                document.getElementById('editExpenseNoItems').classList.add('hidden');
                
                const container = document.getElementById('editItemsList');
                container.innerHTML = expense.expense_items.map((item, index) => {
                    const suggestion = getIVASuggestion(item.name);
                    
                    return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <p class="font-medium text-sm">${item.name}</p>
                            <p class="text-xs text-gray-500">${item.quantity} x ${formatMoney(item.total / item.quantity)} = ${formatMoney(item.total)}</p>
                            ${suggestion ? `
                                <p class="text-xs text-purple-600 mt-1">
                                    <i class="fas fa-lightbulb mr-1"></i>${suggestion.text}
                                </p>
                            ` : ''}
                        </div>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="editItem_${item.id}" ${item.has_iva ? 'checked' : ''} 
                                class="w-4 h-4 text-brand-600 rounded">
                            <span class="text-sm text-gray-600">IVA</span>
                        </label>
                    </div>
                `}).join('');
            } else {
                document.getElementById('editExpenseHasItems').classList.add('hidden');
                document.getElementById('editExpenseNoItems').classList.remove('hidden');
                document.getElementById('editExpenseConcept').textContent = expense.concept || 'Sin concepto';
                document.getElementById('editExpenseTotal').textContent = formatMoney(expense.amount);
            }
            
            openModal('editExpenseModal');
            
        } catch (error) {
            console.error('Error loading expense:', error);
            alert('Error al cargar el gasto');
        }
    }

    // Guardar gasto editado
    async function saveEditedExpense() {
        const id = document.getElementById('editExpenseId').value;
        const area = document.getElementById('editExpenseArea').value;
        const method = document.getElementById('editExpenseMethod').value;
        
        try {
            // Obtener items actuales
            const { data: expense } = await supabaseClient
                .from('expenses')
                .select('expense_items(*)')
                .eq('id', id)
                .single();
            
            const hasItems = expense.expense_items && expense.expense_items.length > 0;
            
            if (hasItems) {
                // Actualizar IVA de cada item
                for (const item of expense.expense_items) {
                    const checkbox = document.getElementById(`editItem_${item.id}`);
                    if (checkbox) {
                        const newHasIVA = checkbox.checked;
                        
                        await supabaseClient
                            .from('expense_items')
                            .update({ has_iva: newHasIVA })
                            .eq('id', item.id);
                        
                        // Actualizar aprendizaje
                        await updateLearningData(item.name, newHasIVA);
                    }
                }
            }
            
            // Marcar como editado
            await supabaseClient
                .from('expenses')
                .update({ 
                    area,
                    method,
                    is_edited: true 
                })
                .eq('id', id);
            
            closeModal('editExpenseModal');
            await loadExpenses();
            await updateDashboard();
            
            alert('Gasto actualizado correctamente');
            
        } catch (error) {
            console.error('Error updating expense:', error);
            alert('Error al actualizar el gasto');
        }
    }

    // Ver OCR
    async function viewOCR(id) {
        try {
            const { data, error } = await supabaseClient
                .from('expenses')
                .select('ticket_data')
                .eq('id', id)
                .single();
            
            if (error) throw error;
            
            const container = document.getElementById('ocrRawText');
            if (data.ticket_data && data.ticket_data.raw_text) {
                container.textContent = data.ticket_data.raw_text;
            } else {
                container.textContent = 'No hay texto OCR disponible';
            }
            
            openModal('viewOCRModal');
            
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Ver desglose
    async function viewBreakdown(id) {
        try {
            const { data, error } = await supabaseClient
                .from('expense_items')
                .select('*')
                .eq('expense_id', id);
            
            if (error) throw error;
            
            const container = document.getElementById('expenseBreakdownContent');
            container.innerHTML = data.map(item => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                        <p class="font-medium">${item.name}</p>
                        <p class="text-sm text-gray-500">${item.quantity} unidades</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold">${formatMoney(item.total)}</p>
                        ${item.has_iva ? `<p class="text-xs text-blue-600">IVA incluido</p>` : ''}
                    </div>
                </div>
            `).join('');
            
            openModal('expenseBreakdownModal');
            
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Eliminar gasto
    async function deleteExpense(id) {
        if (!confirm('¿Eliminar este gasto?')) return;
        
        try {
            await supabaseClient.from('expenses').delete().eq('id', id);
            await loadExpenses();
            await updateDashboard();
        } catch (error) {
            alert('Error al eliminar: ' + error.message);
        }
    }

    // Abrir reportes de gastos
    function openExpenseReports() {
        // Establecer fechas por defecto (mes actual)
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        
        document.getElementById('reportDateFrom').value = firstDay.toISOString().split('T')[0];
        document.getElementById('reportDateTo').value = today.toISOString().split('T')[0];
        
        openModal('expenseReportsModal');
    }

    // Generar reporte de gastos
    async function generateExpenseReport() {
        const from = document.getElementById('reportDateFrom').value;
        const to = document.getElementById('reportDateTo').value;
        
        if (!from || !to) {
            alert('Selecciona un rango de fechas');
            return;
        }
        
        try {
            const { data, error } = await supabaseClient
                .from('expenses')
                .select(`
                    *,
                    expense_items (*)
                `)
                .gte('created_at', from)
                .lte('created_at', to + 'T23:59:59')
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            // Calcular totales
            const totalGeneral = data.reduce((sum, e) => sum + e.amount, 0);
            const totalIVA0 = data.filter(e => e.iva_total === 0).reduce((sum, e) => sum + e.amount, 0);
            const totalIVA16 = data.filter(e => e.iva_total > 0).reduce((sum, e) => sum + e.amount, 0);
            const totalIVA = data.reduce((sum, e) => sum + (e.iva_total || 0), 0);
            
            // Por área
            const porArea = {};
            data.forEach(e => {
                if (!porArea[e.area]) porArea[e.area] = { total: 0, count: 0 };
                porArea[e.area].total += e.amount;
                porArea[e.area].count++;
            });
            
            // Productos más comprados
            const productos = {};
            data.forEach(e => {
                if (e.expense_items) {
                    e.expense_items.forEach(item => {
                        const name = item.name;
                        if (!productos[name]) {
                            productos[name] = {
                                total: 0,
                                count: 0,
                                avgPrice: 0,
                                hasIVA: item.has_iva
                            };
                        }
                        productos[name].total += item.total;
                        productos[name].count += item.quantity;
                    });
                }
            });
            
            // Calcular promedios
            Object.keys(productos).forEach(key => {
                productos[key].avgPrice = productos[key].total / productos[key].count;
            });
            
            // Top 10 productos
            const topProductos = Object.entries(productos)
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 10);
            
            const container = document.getElementById('expenseReportResults');
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="expense-report-card p-4 rounded-xl">
                        <p class="text-xs text-blue-600 uppercase font-bold">Total Gastos</p>
                        <h4 class="text-2xl font-bold text-blue-900">${formatMoney(totalGeneral)}</h4>
                    </div>
                    <div class="bg-pink-50 border border-pink-200 p-4 rounded-xl">
                        <p class="text-xs text-pink-600 uppercase font-bold">IVA 0%</p>
                        <h4 class="text-2xl font-bold text-pink-900">${formatMoney(totalIVA0)}</h4>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 p-4 rounded-xl">
                        <p class="text-xs text-blue-600 uppercase font-bold">Con IVA 16%</p>
                        <h4 class="text-2xl font-bold text-blue-900">${formatMoney(totalIVA16)}</h4>
                    </div>
                    <div class="bg-purple-50 border border-purple-200 p-4 rounded-xl">
                        <p class="text-xs text-purple-600 uppercase font-bold">IVA Total</p>
                        <h4 class="text-2xl font-bold text-purple-900">${formatMoney(totalIVA)}</h4>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h4 class="font-bold text-gray-800 mb-3">Por Área</h4>
                    <div class="space-y-2">
                        ${Object.entries(porArea).map(([area, data]) => `
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="capitalize">${area}</span>
                                <div class="text-right">
                                    <span class="font-bold">${formatMoney(data.total)}</span>
                                    <span class="text-xs text-gray-500 ml-2">(${data.count} gastos)</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="mt-6">
                    <h4 class="font-bold text-gray-800 mb-3">Top Productos Comprados</h4>
                    <div class="space-y-2">
                        ${topProductos.map(([name, data]) => `
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <span class="font-medium">${name}</span>
                                    <span class="text-xs text-gray-500 ml-2">${data.count} unidades</span>
                                    ${data.hasIVA ? '<span class="text-xs text-blue-600 ml-2">IVA</span>' : ''}
                                </div>
                                <div class="text-right">
                                    <span class="font-bold">${formatMoney(data.total)}</span>
                                    <span class="text-xs text-gray-500 block">Prom: ${formatMoney(data.avgPrice)}/u</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="mt-6 flex gap-2">
                    <button onclick="printExpenseReport()" class="flex-1 bg-brand-600 text-white py-2 rounded-lg hover:bg-brand-700">
                        <i class="fas fa-print mr-2"></i>Imprimir
                    </button>
                    <button onclick="exportExpenseReport()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        <i class="fas fa-file-export mr-2"></i>Exportar
                    </button>
                </div>
            `;
            
        } catch (error) {
            console.error('Error generating report:', error);
            alert('Error al generar el reporte');
        }
    }

    function printExpenseReport() {
        window.print();
    }

    function exportExpenseReport() {
        alert('Función de exportación en desarrollo');
    }

    function getAreaColor(area) {
        const colors = {
            'produccion': 'bg-orange-100 text-orange-700',
            'atencion': 'bg-blue-100 text-blue-700',
            'administrativo': 'bg-yellow-100 text-yellow-700',
            'otros': 'bg-purple-100 text-purple-700'
        };
        return colors[area] || 'bg-gray-100 text-gray-700';
    }

    // ============================================
    // PRODUCTOS
    // ============================================

    async function loadProductsTable() {
        try {
            const { data, error } = await supabaseClient
                .from('products')
                .select('*')
                .order('name');
            
            if (error) throw error;
            products = data || [];
            
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = products.map(p => {
                const isAdmin = currentProfile?.role === 'admin';
                
                const editButton = isAdmin ? `
                    <button onclick="editProduct('${p.id}')" class="text-blue-500 hover:text-blue-700 mr-3 btn-action" title="Editar producto">
                        <i class="fas fa-edit"></i>
                    </button>
                ` : '';
                
                const stockButton = !isAdmin ? `
                    <button onclick="openStockModal('${p.id}')" class="text-green-500 hover:text-green-700 mr-3 btn-action" title="Ajustar stock">
                        <i class="fas fa-boxes"></i>
                    </button>
                ` : '';
                
                const deleteButton = isAdmin ? `
                    <button onclick="deleteProduct('${p.id}')" class="text-red-500 hover:text-red-700 btn-action" title="Eliminar producto">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : '';
                
                return `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-4 py-3 font-medium">${p.name}</td>
                    <td class="px-4 py-3 capitalize">${p.category}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="${p.stock < 5 ? 'text-red-600 font-bold' : 'text-gray-700'}">${p.stock}</span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        ${p.has_iva ? '<span class="text-blue-600 font-medium">Sí (16%)</span>' : '<span class="text-gray-400">No</span>'}
                    </td>
                    <td class="px-4 py-3 text-right font-bold">${formatMoney(p.price)}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded-full text-xs ${p.stock > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            ${p.stock > 0 ? 'Activo' : 'Agotado'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        ${editButton}${stockButton}${deleteButton}
                    </td>
                </tr>
            `}).join('');
            
            const btnNewProduct = document.getElementById('btnNewProduct');
            if (btnNewProduct) {
                btnNewProduct.style.display = currentProfile?.role === 'admin' ? 'inline-flex' : 'none';
            }
            
        } catch (error) {
            console.error('Error loading products table:', error);
        }
    }

    function openStockModal(productId) {
        const product = products.find(p => p.id === productId);
        if (!product) return;
        
        document.getElementById('stockProdId').value = product.id;
        document.getElementById('stockProdName').textContent = product.name;
        document.getElementById('stockProdImage').textContent = product.image || '📦';
        document.getElementById('stockProdCurrent').textContent = `Stock actual: ${product.stock}`;
        document.getElementById('stockNewValue').value = product.stock;
        document.getElementById('stockPreview').textContent = product.stock;
        
        openModal('stockModal');
    }

    function adjustStockPreview(change) {
        const input = document.getElementById('stockNewValue');
        let value = parseInt(input.value) || 0;
        value += change;
        if (value < 0) value = 0;
        input.value = value;
        document.getElementById('stockPreview').textContent = value;
    }

    async function saveStockAdjustment() {
        const productId = document.getElementById('stockProdId').value;
        const newStock = parseInt(document.getElementById('stockNewValue').value) || 0;
        
        if (newStock < 0) {
            alert('El stock no puede ser negativo');
            return;
        }
        
        try {
            const { error } = await supabaseClient
                .from('products')
                .update({ stock: newStock })
                .eq('id', productId);
            
            if (error) throw error;
            
            closeModal('stockModal');
            await loadProductsTable();
            await loadProducts();
            
            alert('Stock actualizado correctamente');
            
        } catch (error) {
            alert('Error al actualizar stock: ' + error.message);
        }
    }

    function openProductModal() {
        if (currentProfile?.role !== 'admin') {
            alert('No tienes permisos para crear productos');
            return;
        }
        
        document.getElementById('productModalTitle').textContent = 'Nuevo Producto';
        document.getElementById('prodId').value = '';
        document.getElementById('prodName').value = '';
        document.getElementById('prodCategory').value = 'pasteles';
        document.getElementById('prodPrice').value = '';
        document.getElementById('prodStock').value = '0';
        document.getElementById('prodIVA').checked = false;
        openModal('productModal');
    }

    function editProduct(id) {
        if (currentProfile?.role !== 'admin') {
            alert('No tienes permisos para editar productos');
            return;
        }
        
        const product = products.find(p => p.id === id);
        if (!product) return;
        
        document.getElementById('productModalTitle').textContent = 'Editar Producto';
        document.getElementById('prodId').value = product.id;
        document.getElementById('prodName').value = product.name;
        document.getElementById('prodCategory').value = product.category;
        document.getElementById('prodPrice').value = product.price;
        document.getElementById('prodStock').value = product.stock;
        document.getElementById('prodIVA').checked = product.has_iva;
        openModal('productModal');
    }

    async function saveProduct() {
        if (currentProfile?.role !== 'admin') {
            alert('No tienes permisos para guardar productos');
            return;
        }
        
        const id = document.getElementById('prodId').value;
        const name = document.getElementById('prodName').value;
        const category = document.getElementById('prodCategory').value;
        const price = parseFloat(document.getElementById('prodPrice').value);
        const stock = parseInt(document.getElementById('prodStock').value) || 0;
        const hasIVA = document.getElementById('prodIVA').checked;
        
        if (!name || !price) {
            alert('Complete los campos obligatorios');
            return;
        }
        
        const productData = {
            name,
            category,
            price,
            stock,
            has_iva: hasIVA,
            image: category === 'pasteles' ? '🎂' : 
                   category === 'postres' ? '🧁' : 
                   category === 'decoracion' ? '🎨' : '👨‍🍳'
        };
        
        try {
            if (id) {
                await supabaseClient.from('products').update(productData).eq('id', id);
            } else {
                await supabaseClient.from('products').insert([productData]);
            }
            
            closeModal('productModal');
            await loadProductsTable();
            await loadProducts();
            
        } catch (error) {
            alert('Error al guardar producto: ' + error.message);
        }
    }

    async function deleteProduct(id) {
        if (currentProfile?.role !== 'admin') {
            alert('No tienes permisos para eliminar productos');
            return;
        }
        
        if (!confirm('¿Eliminar este producto?')) return;
        
        try {
            await supabaseClient.from('products').update({ is_active: false }).eq('id', id);
            await loadProductsTable();
            await loadProducts();
        } catch (error) {
            alert('Error al eliminar: ' + error.message);
        }
    }

    // ============================================
    // BANCOS
    // ============================================

    async function updateBankModule() {
        try {
            const { data: salesData } = await supabaseClient
                .from('sales')
                .select('payment_method, payment_details, total')
                .eq('cancelled', false);

            let cashIn = 0, bankIn = 0;
            
            salesData?.forEach(s => {
                if (s.payment_method === 'mixto' && s.payment_details) {
                    cashIn += s.payment_details.efectivo || 0;
                    bankIn += (s.payment_details.transferencia || 0) + (s.payment_details.tarjeta || 0);
                } else {
                    if (s.payment_method === 'efectivo') cashIn += s.total;
                    if (s.payment_method === 'transferencia' || s.payment_method === 'tarjeta') bankIn += s.total;
                }
            });
            
            const { data: expensesData } = await supabaseClient
                .from('expenses')
                .select('method, amount');
            
            const cashOut = expensesData?.filter(e => e.method === 'efectivo').reduce((sum, e) => sum + e.amount, 0) || 0;
            const bankOut = expensesData?.filter(e => e.method === 'transferencia' || e.method === 'tarjeta').reduce((sum, e) => sum + e.amount, 0) || 0;
            
            document.getElementById('cashBalance').textContent = formatMoney(cashIn - cashOut);
            document.getElementById('bankBalance').textContent = formatMoney(bankIn - bankOut);
            
        } catch (error) {
            console.error('Error updating bank:', error);
        }
    }

    // ============================================
    // IMPUESTOS
    // ============================================

    function setTaxPeriodThisMonth() {
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        
        document.getElementById('taxDateFrom').value = firstDay.toISOString().split('T')[0];
        document.getElementById('taxDateTo').value = lastDay.toISOString().split('T')[0];
        
        calculateTaxesByPeriod();
    }

    function setTaxPeriodLastMonth() {
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        const lastDay = new Date(now.getFullYear(), now.getMonth(), 0);
        
        document.getElementById('taxDateFrom').value = firstDay.toISOString().split('T')[0];
        document.getElementById('taxDateTo').value = lastDay.toISOString().split('T')[0];
        
        calculateTaxesByPeriod();
    }

    async function calculateTaxesByPeriod() {
        const fromDate = document.getElementById('taxDateFrom').value;
        const toDate = document.getElementById('taxDateTo').value;
        
        if (!fromDate || !toDate) return;
        
        try {
            const { data: salesData } = await supabaseClient
                .from('sales')
                .select('*')
                .gte('created_at', fromDate)
                .lte('created_at', toDate + 'T23:59:59')
                .eq('cancelled', false);

            const { data: expensesData } = await supabaseClient
                .from('expenses')
                .select('*')
                .gte('created_at', fromDate)
                .lte('created_at', toDate + 'T23:59:59');

            let totalSales = 0;
            let totalIVA0 = 0;
            let totalIVA16 = 0;
            let countIVA0 = 0;
            let countIVA16 = 0;
            let countMixed = 0;
            
            salesData?.forEach(sale => {
                const saleIVA0 = sale.total_iva_0 || 0;
                const saleIVA16 = sale.total_iva_16 || 0;
                
                totalIVA0 += saleIVA0;
                totalIVA16 += saleIVA16;
                totalSales += sale.total;
                
                if (saleIVA0 > 0 && saleIVA16 > 0) {
                    countMixed++;
                } else if (saleIVA16 > 0) {
                    countIVA16++;
                } else {
                    countIVA0++;
                }
            });
            
            const ivaFrom16 = totalIVA16 - (totalIVA16 / 1.16);
            
            document.getElementById('taxPeriodSummary').classList.remove('hidden');
            document.getElementById('taxPeriodLabel').textContent = `${new Date(fromDate).toLocaleDateString('es-MX')} - ${new Date(toDate).toLocaleDateString('es-MX')}`;
            document.getElementById('taxPeriodTotalSales').textContent = formatMoney(totalSales);
            document.getElementById('taxPeriodTransactions').textContent = salesData?.length || 0;
            document.getElementById('taxPeriodCount0').textContent = countIVA0 + countMixed;
            document.getElementById('taxPeriodCount16').textContent = countIVA16 + countMixed;
            
            document.getElementById('salesIVA0').textContent = formatMoney(totalIVA0);
            document.getElementById('transactionsIVA0').textContent = countIVA0 + countMixed;
            document.getElementById('salesIVA16').textContent = formatMoney(totalIVA16);
            document.getElementById('transactionsIVA16').textContent = countIVA16 + countMixed;
            document.getElementById('ivaIncluded16').textContent = formatMoney(ivaFrom16);
            
            const ivaInExpenses = expensesData?.filter(e => e.iva_total > 0).reduce((sum, e) => sum + e.iva_total, 0) || 0;
            
            document.getElementById('ivaCharged').textContent = formatMoney(ivaFrom16);
            document.getElementById('ivaExpenses').textContent = formatMoney(ivaInExpenses);
            document.getElementById('ivaToPay').textContent = formatMoney(ivaFrom16 - ivaInExpenses);
            
            const isr = totalSales * 0.025;
            document.getElementById('isrIncome').textContent = formatMoney(totalSales);
            document.getElementById('isrAmount').textContent = formatMoney(isr);
            
            const tbody = document.getElementById('taxSalesDetailTable');
            tbody.innerHTML = (salesData || []).sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).map(sale => {
                const hasIVA0 = (sale.total_iva_0 || 0) > 0;
                const hasIVA16 = (sale.total_iva_16 || 0) > 0;
                
                let ivaType, ivaClass;
                if (hasIVA0 && hasIVA16) {
                    ivaType = 'MIXTA';
                    ivaClass = 'bg-purple-100 text-purple-700';
                } else if (hasIVA16) {
                    ivaType = '16%';
                    ivaClass = 'bg-blue-100 text-blue-700';
                } else {
                    ivaType = '0%';
                    ivaClass = 'bg-pink-100 text-pink-700';
                }
                
                return `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-4 py-3 font-medium text-brand-700">${sale.id.slice(0, 8)}...</td>
                    <td class="px-4 py-3 text-gray-600">${new Date(sale.created_at).toLocaleDateString('es-MX')}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${sale.items.map(i => i.name).join(', ').substring(0, 50)}...</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded-full text-xs ${ivaClass} font-bold">${ivaType}</span>
                    </td>
                    <td class="px-4 py-3 text-right">${formatMoney(sale.subtotal)}</td>
                    <td class="px-4 py-3 text-right ${hasIVA16 ? 'text-blue-600' : 'text-gray-400'}">${formatMoney(sale.iva)}</td>
                    <td class="px-4 py-3 text-right font-bold">${formatMoney(sale.total)}</td>
                </tr>
            `}).join('');
            
        } catch (error) {
            console.error('Error calculating taxes:', error);
        }
    }

    // ============================================
    // EMPLEADOS
    // ============================================

    async function loadEmployees() {
        try {
            const { data, error } = await supabaseClient
                .from('employees')
                .select('*')
                .eq('is_active', true)
                .order('name');
            
            if (error) throw error;
            employees = data || [];
            
            const prodCount = employees.filter(e => e.area === 'produccion').length;
            const servCount = employees.filter(e => e.area === 'atencion').length;
            
            document.getElementById('countProduction').textContent = prodCount + ' empleados';
            document.getElementById('countService').textContent = servCount + ' empleados';
            
            document.getElementById('productionEmployees').innerHTML = employees
                .filter(e => e.area === 'produccion')
                .map(e => `
                    <div class="flex items-center justify-between p-3 bg-orange-50 rounded-lg group">
                        <div>
                            <p class="font-medium text-gray-800">${e.name}</p>
                            <p class="text-xs text-gray-500">${e.role}</p>
                        </div>
                        <button onclick="deleteEmployee('${e.id}')" class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-all btn-action">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `).join('');
                
            document.getElementById('serviceEmployees').innerHTML = employees
                .filter(e => e.area === 'atencion')
                .map(e => `
                    <div class="flex items-center justify-between p-3 bg-pink-50 rounded-lg group">
                        <div>
                            <p class="font-medium text-gray-800">${e.name}</p>
                            <p class="text-xs text-gray-500">${e.role}</p>
                        </div>
                        <button onclick="deleteEmployee('${e.id}')" class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-all btn-action">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `).join('');

            const nominaSelect = document.getElementById('nominaEmployee');
            const filterSelect = document.getElementById('nominaFilterEmployee');
            
            if (nominaSelect) {
                nominaSelect.innerHTML = '<option value="">Seleccionar empleado...</option>' +
                    employees.map(e => `<option value="${e.id}">${e.name} - ${e.role}</option>`).join('');
            }
            if (filterSelect) {
                filterSelect.innerHTML = '<option value="all">Todos los empleados</option>' +
                    employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            }
            
        } catch (error) {
            console.error('Error loading employees:', error);
        }
    }

    async function saveEmployee() {
        const name = document.getElementById('empName').value;
        const area = document.getElementById('empArea').value;
        const role = document.getElementById('empRole').value;
        
        if (!name || !role) {
            alert('Complete todos los campos');
            return;
        }
        
        try {
            const { error } = await supabaseClient.from('employees').insert([{ name, area, role }]);
            if (error) throw error;
            
            closeModal('employeeModal');
            await loadEmployees();
            
            document.getElementById('empName').value = '';
            document.getElementById('empRole').value = '';
            
        } catch (error) {
            alert('Error al guardar empleado: ' + error.message);
        }
    }

    async function deleteEmployee(id) {
        if (!confirm('¿Eliminar este empleado?')) return;
        
        try {
            await supabaseClient.from('employees').update({ is_active: false }).eq('id', id);
            await loadEmployees();
        } catch (error) {
            alert('Error al eliminar: ' + error.message);
        }
    }

    // ============================================
    // NÓMINA
    // ============================================

    async function loadNomina() {
        try {
            const monthFilter = document.getElementById('nominaFilterMonth').value;
            const empFilter = document.getElementById('nominaFilterEmployee').value;
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            let query = supabaseClient.from('nomina').select('*').order('created_at', { ascending: false });
            
            if (monthFilter !== 'all') {
                query = query.eq('month', parseInt(monthFilter)).eq('year', currentYear);
            }
            
            if (empFilter !== 'all') {
                query = query.eq('employee_id', empFilter);
            }
            
            const { data, error } = await query;
            if (error) throw error;
            
            const currentMonthRecords = (data || []).filter(n => n.month === currentMonth && n.year === currentYear);
            const totalMes = currentMonthRecords.reduce((sum, n) => sum + n.total, 0);
            const totalSueldos = currentMonthRecords.reduce((sum, n) => sum + n.sueldo, 0);
            const totalHorasExtras = currentMonthRecords.reduce((sum, n) => sum + n.total_horas_extras, 0);
            const totalBonos = currentMonthRecords.reduce((sum, n) => sum + n.bono + n.bono_puntualidad, 0);
            
            document.getElementById('totalNominaMes').textContent = formatMoney(totalMes);
            document.getElementById('totalSueldos').textContent = formatMoney(totalSueldos);
            document.getElementById('totalHorasExtras').textContent = formatMoney(totalHorasExtras);
            document.getElementById('totalBonos').textContent = formatMoney(totalBonos);
            
            const tbody = document.getElementById('nominaTableBody');
            tbody.innerHTML = (data || []).map(rec => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-4 py-3 text-gray-600">${new Date(rec.created_at).toLocaleDateString()}</td>
                    <td class="px-4 py-3 font-medium">${rec.employee_name || 'N/A'}</td>
                    <td class="px-4 py-3 text-right">${formatMoney(rec.sueldo)}</td>
                    <td class="px-4 py-3 text-center">${rec.horas_extras}</td>
                    <td class="px-4 py-3 text-right">${formatMoney(rec.total_horas_extras)}</td>
                    <td class="px-4 py-3 text-right text-green-600">${formatMoney(rec.bono)}</td>
                    <td class="px-4 py-3 text-right text-purple-600">${formatMoney(rec.bono_puntualidad)}</td>
                    <td class="px-4 py-3 text-right font-bold">${formatMoney(rec.total)}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="deleteNomina('${rec.id}')" class="text-gray-400 hover:text-red-500 transition-colors btn-action">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            const employeeTotals = {};
            currentMonthRecords.forEach(rec => {
                const empName = rec.employee_name || 'N/A';
                if (!employeeTotals[rec.employee_id]) {
                    employeeTotals[rec.employee_id] = {
                        name: empName,
                        total: 0,
                        sueldo: 0,
                        horasExtras: 0,
                        bonos: 0
                    };
                }
                employeeTotals[rec.employee_id].total += rec.total;
                employeeTotals[rec.employee_id].sueldo += rec.sueldo;
                employeeTotals[rec.employee_id].horasExtras += rec.total_horas_extras;
                employeeTotals[rec.employee_id].bonos += rec.bono + rec.bono_puntualidad;
            });
            
            document.getElementById('nominaResumenEmpleados').innerHTML = Object.values(employeeTotals).map(emp => `
                <div class="glass-panel p-4 rounded-xl border-l-4 border-brand-500">
                    <h4 class="font-bold text-gray-800 mb-2">${emp.name}</h4>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total:</span>
                            <span class="font-bold">${formatMoney(emp.total)}</span>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>Sueldo: ${formatMoney(emp.sueldo)}</span>
                            <span>H.E.: ${formatMoney(emp.horasExtras)}</span>
                            <span>Bonos: ${formatMoney(emp.bonos)}</span>
                        </div>
                    </div>
                </div>
            `).join('') || '<p class="text-gray-500 col-span-3 text-center">No hay registros este mes</p>';
            
        } catch (error) {
            console.error('Error loading nomina:', error);
        }
    }

    function calculateNominaTotal() {
        const sueldo = parseFloat(document.getElementById('nominaSueldo').value) || 0;
        const horasExtras = parseInt(document.getElementById('nominaHorasExtras').value) || 0;
        const pagoHoraExtra = parseFloat(document.getElementById('nominaPagoHoraExtra').value) || 0;
        const bono = parseFloat(document.getElementById('nominaBono').value) || 0;
        const bonoPuntualidad = parseFloat(document.getElementById('nominaBonoPuntualidad').value) || 0;
        
        const totalHorasExtras = horasExtras * pagoHoraExtra;
        const total = sueldo + totalHorasExtras + bono + bonoPuntualidad;
        
        document.getElementById('nominaTotal').textContent = formatMoney(total);
    }

    async function saveNomina() {
        const empId = document.getElementById('nominaEmployee').value;
        const month = parseInt(document.getElementById('nominaMonth').value);
        const year = parseInt(document.getElementById('nominaYear').value);
        const sueldo = parseFloat(document.getElementById('nominaSueldo').value) || 0;
        const horasExtras = parseInt(document.getElementById('nominaHorasExtras').value) || 0;
        const pagoHoraExtra = parseFloat(document.getElementById('nominaPagoHoraExtra').value) || 0;
        const bono = parseFloat(document.getElementById('nominaBono').value) || 0;
        const bonoPuntualidad = parseFloat(document.getElementById('nominaBonoPuntualidad').value) || 0;
        
        if (!empId) {
            alert('Seleccione un empleado');
            return;
        }
        
        const employee = employees.find(e => e.id === empId);
        if (!employee) {
            alert('Empleado no encontrado');
            return;
        }
        
        const totalHorasExtras = horasExtras * pagoHoraExtra;
        const total = sueldo + totalHorasExtras + bono + bonoPuntualidad;
        
        try {
            const { error } = await supabaseClient.from('nomina').insert([{
                employee_id: empId,
                employee_name: employee.name,
                user_id: currentUser.id,
                month,
                year,
                sueldo,
                horas_extras: horasExtras,
                pago_hora_extra: pagoHoraExtra,
                total_horas_extras: totalHorasExtras,
                bono,
                bono_puntualidad: bonoPuntualidad,
                total,
                registered_by: currentProfile.full_name
            }]);
            
            if (error) throw error;
            
            closeModal('nominaModal');
            await loadNomina();
            
            document.getElementById('nominaEmployee').value = '';
            document.getElementById('nominaSueldo').value = '';
            document.getElementById('nominaHorasExtras').value = '';
            document.getElementById('nominaPagoHoraExtra').value = '';
            document.getElementById('nominaBono').value = '';
            document.getElementById('nominaBonoPuntualidad').value = '';
            calculateNominaTotal();
            
        } catch (error) {
            alert('Error al guardar nómina: ' + error.message);
            console.error(error);
        }
    }

    async function deleteNomina(id) {
        if (!confirm('¿Eliminar este registro de nómina?')) return;
        
        try {
            await supabaseClient.from('nomina').delete().eq('id', id);
            await loadNomina();
        } catch (error) {
            alert('Error al eliminar: ' + error.message);
        }
    }

    function generateNominaReport() {
        alert('Función de reporte en desarrollo');
    }

    // ============================================
    // UTILIDADES
    // ============================================

    function formatMoney(amount) {
        return '$' + (amount || 0).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }

    function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    function openCustomProductModal() { openModal('customProductModal'); }

    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.classList.remove('active');
        }
    }

    // Inicializar al cargar
    document.addEventListener('DOMContentLoaded', () => {
        checkSession();
        
        const today = new Date().toISOString().split('T')[0];
        const dateFrom = document.getElementById('filterDateFrom');
        const dateTo = document.getElementById('filterDateTo');
        if (dateFrom) dateFrom.value = today;
        if (dateTo) dateTo.value = today;
        
        const stockInput = document.getElementById('stockNewValue');
        if (stockInput) {
            stockInput.addEventListener('input', (e) => {
                let value = parseInt(e.target.value) || 0;
                if (value < 0) value = 0;
                document.getElementById('stockPreview').textContent = value;
            });
        }
    });
</script>

</body>
</html>
